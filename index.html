<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ö—É—Ä—Å: –î—Ä–µ–≤–Ω–µ–∫–∏—Ç–∞–π—Å–∫–∏–µ –æ—Ä–∞–∫—É–ª—å–Ω—ã–µ –Ω–∞–¥–ø–∏—Å–∏</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      margin: 0;
    }
    #task-container {
      width: 100%;
      height: 500px;
      border: 1px solid #ccc;
      margin-top: 20px;
      opacity: 0.4;
      transition: opacity 0.3s ease;
    }
    #task-container.active {
      opacity: 1;
    }
    .controls {
      margin-top: 15px;
    }
    button {
      padding: 10px 15px;
      font-size: 16px;
      cursor: pointer;
    }
    #status {
      font-weight: bold;
      color: #333;
    }
    .hidden-iframe {
      position: absolute;
      top: -9999px;
      left: -9999px;
      width: 1px;
      height: 1px;
      border: none;
    }
  </style>
</head>
<body>
  <h1>–ö—É—Ä—Å: –î—Ä–µ–≤–Ω–µ–∫–∏—Ç–∞–π—Å–∫–∏–µ –æ—Ä–∞–∫—É–ª—å–Ω—ã–µ –Ω–∞–¥–ø–∏—Å–∏</h1>
  <p id="status">üîç –ü–æ–∏—Å–∫ –∑–∞–¥–∞–Ω–∏–π... –û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å (F12)</p>

  <div id="task-container">
    <iframe id="task-frame" src="about:blank" width="100%" height="100%" frameborder="0"></iframe>
  </div>

  <div class="controls">
    <button id="next-btn" disabled>–°–ª–µ–¥—É—é—â–µ–µ –∑–∞–¥–∞–Ω–∏–µ</button>
  </div>

  <script>
    // –ú–∞—Å—Å–∏–≤ –∏–µ—Ä–æ–≥–ª–∏—Ñ–æ–≤ —É—Ä–æ–∫–∞ (—Ç–æ–ª—å–∫–æ —Å–∏–º–≤–æ–ª—ã)
    const lessonwords = [
      '‰∏ô', 'ÂØÖ', 'Âçú', 'Áà≠', 'Ë≤û', 'Èõ®', 'Êõ∞', 'ÂÖ∂', 'Áô∏',
      '‰∫•', '‰∏ç', 'ÂÖÅ', 'Áéã', 'Âç†', '‰∏ë', 'Â∑±', 'ÂçØ', 'Áèè', 'Â£¨', 'Âçà'
    ];

    let tasks = [];
    let currentTaskIndex = 0;

    const iframe = document.getElementById("task-frame");
    const statusEl = document.getElementById("status");
    const nextBtn = document.getElementById("next-btn");

    // –§–ª–∞–≥–∏
    let hasProcessedHanzi = false;           // –û–¥–Ω–æ–∫—Ä–∞—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ DO_HANZI
    let discoveryCompleted = false;          // –ü–æ–∏—Å–∫ –∑–∞–¥–∞–Ω–∏–π –∑–∞–≤–µ—Ä—à—ë–Ω

    // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–Ω–∏–µ –º–∞—Å—Å–∏–≤–∞
    function shuffleArray(array) {
      const arr = [...array];
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞: –Ω–∞—Å—Ç–æ—è—â–∏–π –ª–∏ —ç—Ç–æ task? (—á–µ—Ä–µ–∑ fetch + postMessage)
function checkTaskIsValid(n) {
  return new Promise((resolve) => {
    const filename = `task${n}.html`;
    const frame = document.createElement("iframe");
    frame.classList.add("hidden-iframe");
    frame.setAttribute("data-check", n);

    let responded = false;
    let timeoutId;

    function onMessage(event) {
      if (event.data.type === "TASK_EXISTS" && event.data.valid) {
        const frameN = parseInt(frame.getAttribute("data-check"));
        if (frameN === n) {
          console.log(`‚úÖ ${filename} ‚Äî –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª, —á—Ç–æ –æ–Ω –Ω–∞—Å—Ç–æ—è—â–∏–π`);
          responded = true;
          clearTimeout(timeoutId);
          document.body.removeChild(frame);
          window.removeEventListener("message", onMessage);
          resolve({ exists: true, n });
        }
      }
    }

    window.addEventListener("message", onMessage);

    // –¢–∞–π–º–µ—Ä —Å—Ç–∞—Ä—Ç—É–µ—Ç —Å—Ä–∞–∑—É ‚Äî –Ω–µ –∂–¥—ë–º onload
    timeoutId = setTimeout(() => {
      if (!responded) {
        console.warn(`‚è∞ ${filename} ‚Äî –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª –∑–∞ 3 —Å–µ–∫. –°—á–∏—Ç–∞–µ–º: –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.`);
        document.body.removeChild(frame);
        window.removeEventListener("message", onMessage);
        resolve({ exists: false, n });
      }
    }, 3000);

    frame.onload = () => {
      console.log(`üü¢ ${filename} ‚Äî iframe –∑–∞–≥—Ä—É–∑–∏–ª—Å—è`);
      // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ —ç—Ç–æ 404-—Å—Ç—Ä–∞–Ω–∏—Ü–∞ –±—Ä–∞—É–∑–µ—Ä–∞, –æ—Ç–∫–ª–æ–Ω—è–µ–º
      try {
        if (frame.contentDocument.title === "404 Not Found") {
          console.log(`‚ùå ${filename} ‚Äî —ç—Ç–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ 404`);
          if (!responded) {
            clearTimeout(timeoutId);
            document.body.removeChild(frame);
            window.removeEventListener("message", onMessage);
            resolve({ exists: false, n });
          }
        }
      } catch (e) {
        // –ï—Å–ª–∏ –¥–æ—Å—Ç—É–ø –∫ contentDocument –∑–∞–ø—Ä–µ—â—ë–Ω ‚Äî —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ
      }
    };

    frame.onerror = () => {
      if (!responded) {
        console.log(`‚ùå ${filename} ‚Äî –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏`);
        clearTimeout(timeoutId);
        document.body.removeChild(frame);
        window.removeEventListener("message", onMessage);
        resolve({ exists: false, n });
      }
    };

    frame.src = filename + "?_=" + Date.now();
    document.body.appendChild(frame);

    console.log(`üîç –ü—Ä–æ–≤–µ—Ä–∫–∞: ${filename} (—Ç–∞–π–º–µ—Ä –∑–∞–ø—É—â–µ–Ω)`);
  });
}

    // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è ‚Äî –ø–æ–∏—Å–∫ –∑–∞–¥–∞–Ω–∏–π
    async function discoverTasks() {
      const existingTasks = [];
      let n = 1;

      statusEl.textContent = "üîç –ò—â–µ–º –Ω–∞—Å—Ç–æ—è—â–∏–µ –∑–∞–¥–∞–Ω–∏—è...";

      while (true) {
        console.log(`üîÑ –ü—Ä–æ–≤–µ—Ä—è–µ–º task${n}.html`);
        const result = await checkTaskIsValid(n);

        if (result.exists) {
          existingTasks.push(`task${n}.html`);
          n++;
        } else {
          console.log(`üõë –ù–∞—Å—Ç–æ—è—â–µ–µ –∑–∞–¥–∞–Ω–∏–µ task${n}.html –Ω–µ –Ω–∞–π–¥–µ–Ω–æ ‚Üí –≤—ã—Ö–æ–¥`);
          break;
        }

        if (n > 200) {
          console.error("‚õî –õ–∏–º–∏—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ (n > 200). –û—Å—Ç–∞–Ω–æ–≤–∫–∞.");
          break;
        }
      }

      console.log(`üèÅ –ü–æ–∏—Å–∫ –∑–∞–≤–µ—Ä—à—ë–Ω. –ù–∞–π–¥–µ–Ω–æ –Ω–∞—Å—Ç–æ—è—â–∏—Ö –∑–∞–¥–∞–Ω–∏–π: ${existingTasks.length}`);
      console.log("üìã –°–ø–∏—Å–æ–∫:", existingTasks);

      if (existingTasks.length === 0) {
        statusEl.innerHTML = `
          ‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ <strong>–Ω–∞—Å—Ç–æ—è—â–µ–≥–æ</strong> –∑–∞–¥–∞–Ω–∏—è.<br>
          –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∫–∞–∂–¥—ã–π <code>taskN.html</code> —Å–æ–¥–µ—Ä–∂–∏—Ç:<br>
          <code>window.parent.postMessage({ type: "TASK_EXISTS", valid: true }, "*");</code>
        `;
        return;
      }

      tasks = shuffleArray(existingTasks);
      discoveryCompleted = true;  // üîë –ü–æ–∏—Å–∫ –∑–∞–≤–µ—Ä—à—ë–Ω ‚Äî —Ç–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å DO_HANZI
      statusEl.textContent = `‚úÖ –ù–∞–π–¥–µ–Ω–æ ${tasks.length} –Ω–∞—Å—Ç–æ—è—â–∏—Ö –∑–∞–¥–∞–Ω–∏–π.`;

      // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
      document.getElementById("task-container").classList.add("active");

      // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ
      loadTask(0);
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞–Ω–∏—è
    function loadTask(index) {
      if (index >= tasks.length) {
        statusEl.textContent = "üéâ –í—Å–µ –∑–∞–¥–∞–Ω–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã!";
        iframe.style.display = "none";
        nextBtn.disabled = true;
        return;
      }

      hasProcessedHanzi = false;  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –¥–ª—è –Ω–æ–≤–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è

      console.log(`‚ñ∂Ô∏è –ó–∞–≥—Ä—É–∑–∫–∞: ${tasks[index]}`);
      iframe.src = tasks[index];
      statusEl.textContent = `–ó–∞–¥–∞–Ω–∏–µ ${index + 1} –∏–∑ ${tasks.length}`;
      nextBtn.disabled = true;
      currentTaskIndex = index;
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç iframe
    window.addEventListener("message", (event) => {
      const { type, success } = event.data;

      // üîê –ò–ì–ù–û–†–ò–†–£–ï–ú DO_HANZI, –ø–æ–∫–∞ –ø–æ–∏—Å–∫ –∑–∞–¥–∞–Ω–∏–π –Ω–µ –∑–∞–≤–µ—Ä—à—ë–Ω
      if (type === "DO_HANZI" && !hasProcessedHanzi && discoveryCompleted) {
        hasProcessedHanzi = true;

        const randomChar = lessonwords[Math.floor(Math.random() * lessonwords.length)];
        const newSrc = `${tasks[currentTaskIndex]}?_=${Date.now()}#${randomChar}`;

        console.log(`üé® DO_HANZI –ø–æ–ª—É—á–µ–Ω. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å #${randomChar}`);

        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –¥–ª—è Chrome
        iframe.src = ''; // –æ–±–Ω—É–ª—è–µ–º
        setTimeout(() => {
          iframe.src = newSrc;
        }, 10);

        nextBtn.disabled = true;
        return;
      }

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è
      if (type === "TASK_RESULT") {
        statusEl.textContent = success 
          ? "‚úÖ –ó–∞–¥–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ!" 
          : "‚ùå –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.";
        nextBtn.disabled = false;
      }
    });

    // –ö–Ω–æ–ø–∫–∞ "–°–ª–µ–¥—É—é—â–µ–µ –∑–∞–¥–∞–Ω–∏–µ"
    nextBtn.addEventListener("click", () => {
      currentTaskIndex++;
      loadTask(currentTaskIndex);
    });

    // –ó–∞–ø—É—Å–∫ –ø–æ–∏—Å–∫–∞
    discoverTasks();
  </script>
</body>
</html>