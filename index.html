<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>–ö—É—Ä—Å: –î—Ä–µ–≤–Ω–µ–∫–∏—Ç–∞–π—Å–∫–∏–µ –æ—Ä–∞–∫—É–ª—å–Ω—ã–µ –Ω–∞–¥–ø–∏—Å–∏</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f8f9fa;
      color: #333;
      padding: 10px;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä */
    #progress-container {
      width: 100%;
      height: 6px;
      background-color: #e0e0e0;
      border-radius: 3px;
      margin: 10px 0;
      overflow: hidden;
    }

    #progress-bar {
      height: 100%;
      width: 0%;
      background-color: #4caf50;
      transition: width 0.4s ease;
      border-radius: 3px;
    }

    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä iframe */
    #task-container {
      flex: 1;
      border: none;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      opacity: 0.4;
      transition: opacity 0.3s ease;
    }

    #task-container.active {
      opacity: 1;
    }

    #task-frame {
      width: 100%;
      height: 100%;
      border: none;
      /* –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–µ –≤–ª–∞–∑–∏—Ç ‚Äî –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º */
      transform-origin: top left;
      transform: scale(1);
    }

    /* –ö–Ω–æ–ø–∫–∞ ‚Äî –º–æ–±–∏–ª—å–Ω–∞—è, –ø—Ä–∏—è—Ç–Ω–∞—è –Ω–∞ –æ—â—É–ø—å */
    .controls {
      padding: 12px 0;
      display: flex;
      justify-content: center;
    }

    #next-btn {
      padding: 14px 24px;
      font-size: 18px;
      font-weight: 600;
      color: white;
      background-color: #1976d2;
      border: none;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      transition: background-color 0.2s ease, transform 0.1s ease;
      width: 90%;
      max-width: 300px;
    }

    #next-btn:active {
      transform: scale(0.98);
    }

    #next-btn:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
      transform: none;
    }

    /* –°–∫—Ä—ã—Ç–∏–µ iframe –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ */
    .hidden-iframe {
      position: absolute;
      top: -9999px;
      left: -9999px;
      width: 1px;
      height: 1px;
      border: none;
    }

    /* –°–æ–æ–±—â–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è */
    #status {
      font-size: 16px;
      text-align: center;
      padding: 8px 0;
      color: #555;
    }
  </style>
</head>
<body>
  <div id="status">üîç –ü–æ–∏—Å–∫ –∑–∞–¥–∞–Ω–∏–π...</div>

  <div id="progress-container">
    <div id="progress-bar"></div>
  </div>

  <div id="task-container" class="active">
    <iframe id="task-frame" src="about:blank" frameborder="0" allowfullscreen></iframe>
  </div>

  <div class="controls">
    <button id="next-btn" disabled>–°–ª–µ–¥—É—é—â–µ–µ –∑–∞–¥–∞–Ω–∏–µ</button>
  </div>

  <script>
    const lessonwords = [
      '‰∏ô', 'ÂØÖ', 'Âçú', 'Áà≠', 'Ë≤û', 'Èõ®', 'Êõ∞', 'ÂÖ∂', 'Áô∏',
      '‰∫•', '‰∏ç', 'ÂÖÅ', 'Áéã', 'Âç†', '‰∏ë', 'Â∑±', 'ÂçØ', 'Áèè', 'Â£¨', 'Âçà'
    ];

    let tasks = [];
    let currentTaskIndex = 0;

    const iframe = document.getElementById("task-frame");
    const statusEl = document.getElementById("status");
    const nextBtn = document.getElementById("next-btn");
    const progressBar = document.getElementById("progress-bar");

    let hasProcessedHanzi = false;
    let discoveryCompleted = false;

    function shuffleArray(array) {
      const arr = [...array];
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function checkTaskIsValid(n) {
      return new Promise((resolve) => {
        const filename = `task${n}.html`;
        const frame = document.createElement("iframe");
        frame.classList.add("hidden-iframe");
        frame.setAttribute("data-check", n);

        let responded = false;
        let timeoutId;

        function onMessage(event) {
          if (event.data.type === "TASK_EXISTS" && event.data.valid) {
            const frameN = parseInt(frame.getAttribute("data-check"));
            if (frameN === n) {
              responded = true;
              clearTimeout(timeoutId);
              document.body.removeChild(frame);
              window.removeEventListener("message", onMessage);
              resolve({ exists: true, n });
            }
          }
        }

        window.addEventListener("message", onMessage);

        timeoutId = setTimeout(() => {
          if (!responded) {
            document.body.removeChild(frame);
            window.removeEventListener("message", onMessage);
            resolve({ exists: false, n });
          }
        }, 3000);

        frame.onload = () => {
          try {
            if (frame.contentDocument.title === "404 Not Found") {
              if (!responded) {
                clearTimeout(timeoutId);
                document.body.removeChild(frame);
                window.removeEventListener("message", onMessage);
                resolve({ exists: false, n });
              }
            }
          } catch (e) {}
        };

        frame.onerror = () => {
          if (!responded) {
            clearTimeout(timeoutId);
            document.body.removeChild(frame);
            window.removeEventListener("message", onMessage);
            resolve({ exists: false, n });
          }
        };

        frame.src = filename + "?_=" + Date.now();
        document.body.appendChild(frame);
      });
    }

    async function discoverTasks() {
      const existingTasks = [];
      let n = 1;

      statusEl.textContent = "üîç –ò—â–µ–º –∑–∞–¥–∞–Ω–∏—è...";

      while (true) {
        const result = await checkTaskIsValid(n);

        if (result.exists) {
          existingTasks.push(`task${n}.html`);
          n++;
        } else {
          break;
        }

        if (n > 200) break;
      }

      if (existingTasks.length === 0) {
        statusEl.innerHTML = `
          ‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ <strong>–Ω–∞—Å—Ç–æ—è—â–µ–≥–æ</strong> –∑–∞–¥–∞–Ω–∏—è.<br>
          –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∫–∞–∂–¥—ã–π <code>taskN.html</code> –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç:<br>
          <code>window.parent.postMessage({ type: "TASK_EXISTS", valid: true }, "*");</code>
        `;
        return;
      }

      tasks = shuffleArray(existingTasks);
      discoveryCompleted = true;
      statusEl.textContent = `‚úÖ –ù–∞–π–¥–µ–Ω–æ ${tasks.length} –∑–∞–¥–∞–Ω–∏–π.`;
      updateProgress();

      loadTask(0);
    }

    function loadTask(index) {
      if (index >= tasks.length) {
        statusEl.textContent = "üéâ –í—Å–µ –∑–∞–¥–∞–Ω–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã!";
        iframe.style.display = "none";
        nextBtn.disabled = true;
        return;
      }

      hasProcessedHanzi = false;

      const url = tasks[index] + "?_=" + Date.now();
      console.log(`‚ñ∂Ô∏è –ó–∞–≥—Ä—É–∑–∫–∞: ${url}`);
      iframe.src = url;

      updateProgress();
      nextBtn.disabled = true;
      currentTaskIndex = index;
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞
    function updateProgress() {
      const progress = tasks.length > 0 ? (currentTaskIndex / tasks.length) * 100 : 0;
      progressBar.style.width = `${progress}%`;
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç iframe
    window.addEventListener("message", (event) => {
      const { type, success } = event.data;

      if (type === "DO_HANZI" && !hasProcessedHanzi && discoveryCompleted) {
        hasProcessedHanzi = true;

        const randomChar = lessonwords[Math.floor(Math.random() * lessonwords.length)];
        const newSrc = `${tasks[currentTaskIndex]}?_=${Date.now()}#${randomChar}`;

        console.log(`üé® DO_HANZI: –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å #${randomChar}`);

        iframe.src = '';
        setTimeout(() => {
          iframe.src = newSrc;
        }, 10);

        nextBtn.disabled = true;
        return;
      }

      if (type === "TASK_RESULT") {
        if (success) {
          statusEl.textContent = "‚úÖ –ó–∞–¥–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ!";
          nextBtn.disabled = false;
        } else {
          statusEl.textContent = "‚è≥ –ó–∞–¥–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...";
        }
      }

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ iframe
      if (type === "CONTENT_TOO_WIDE") {
        iframe.style.transform = "scale(0.5)";
        iframe.style.margin = "auto";
        iframe.style.width = "200%";
        iframe.style.height = "200%";
      } else {
        iframe.style.transform = "scale(1)";
        iframe.style.width = "100%";
        iframe.style.height = "100%";
      }
    });

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç iframe (–±–µ–∑ CONTENT_TOO_WIDE)
window.addEventListener("message", (event) => {
  const { type, success } = event.data;

  if (type === "DO_HANZI" && !hasProcessedHanzi && discoveryCompleted) {
    hasProcessedHanzi = true;

    const randomChar = lessonwords[Math.floor(Math.random() * lessonwords.length)];
    const newSrc = `${tasks[currentTaskIndex]}?_=${Date.now()}#${randomChar}`;

    console.log(`üé® DO_HANZI: –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å #${randomChar}`);

    iframe.src = '';
    setTimeout(() => {
      iframe.src = newSrc;
    }, 10);

    nextBtn.disabled = true;
    return;
  }

  if (type === "TASK_RESULT") {
    if (success) {
      statusEl.textContent = "‚úÖ –ó–∞–¥–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ!";
      nextBtn.disabled = false;
    } else {
      statusEl.textContent = "‚è≥ –ó–∞–¥–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...";
    }
  }
});

// –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –º–æ–±–∏–ª—å–Ω–æ–µ –ª–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
function isMobile() {
  return window.innerWidth <= 768 || (navigator.maxTouchPoints && navigator.maxTouchPoints > 1);
}

// –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∞—Å—à—Ç–∞–± –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
window.addEventListener("load", () => {
  if (isMobile()) {
    iframe.style.transform = "scale(0.5)";
    iframe.style.transformOrigin = "top left";
    iframe.style.width = "200%";
    iframe.style.height = "200%";
    console.log("üì± –ú–æ–±–∏–ª—å–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: iframe —É–º–µ–Ω—å—à–µ–Ω –≤ 2 —Ä–∞–∑–∞");
  }
});

// –ü–µ—Ä–µ–ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ (–ø–æ–≤–æ—Ä–æ—Ç —ç–∫—Ä–∞–Ω–∞)
window.addEventListener("resize", () => {
  if (isMobile()) {
    iframe.style.transform = "scale(0.5)";
    iframe.style.width = "200%";
    iframe.style.height = "200%";
  } else {
    iframe.style.transform = "scale(1)";
    iframe.style.width = "100%";
    iframe.style.height = "100%";
  }
});

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –∏–∑ iframe (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    // iframe –º–æ–∂–µ—Ç –ø—Ä–∏—Å–ª–∞—Ç—å: postMessage({ type: "CONTENT_TOO_WIDE" }, "*")
    // –µ—Å–ª–∏ –µ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —à–∏—Ä–µ, —á–µ–º —à–∏—Ä–∏–Ω–∞ —ç–∫—Ä–∞–Ω–∞.

    discoverTasks();
  </script>
</body>
</html>