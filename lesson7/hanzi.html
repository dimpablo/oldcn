<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>–ò–µ—Ä–æ–≥–ª–∏—Ñ–∏–∫–∞</title>
  <style>
    html, body {
      width: 100%;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f8f9fa;
      color: #333;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      padding: 10px;
      gap: 8px;
      width: 100%;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 16px;
      color: #555;
      flex-shrink: 0;
    }

    .scale-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .scale-btn {
      width: 28px;
      height: 28px;
      font-size: 18px;
      line-height: 28px;
      text-align: center;
      background-color: #e0e0e0;
      border-radius: 50%;
      cursor: pointer;
      user-select: none;
    }

    .scale-value {
      min-width: 36px;
      text-align: center;
      font-weight: bold;
    }

    #progress-container {
      width: 100%;
      height: 6px;
      background-color: #e0e0e0;
      border-radius: 3px;
      overflow: hidden;
      flex-shrink: 0;
    }

    #progress-bar {
      height: 100%;
      width: 0%;
      background-color: #4caf50;
      transition: width 0.4s ease;
      border-radius: 3px;
    }

    #task-container {
      flex: 1;
      width: 100%;
      border: none;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease;
      min-height: 0;
      max-height: calc(100vh - 150px);
    }

    #task-container.active {
      opacity: 1;
      visibility: visible;
    }

    #task-frame {
      width: 100%;
      height: 100%;
      border: none;
      transform-origin: center top;
      transform: scale(1);
      transition: transform 0.2s ease;
      overflow: auto;
    }

    .controls {
      padding: 12px 0;
      display: flex;
      justify-content: center;
      flex-shrink: 0;
    }

    #next-btn {
      padding: 14px 24px;
      font-size: 18px;
      font-weight: 600;
      color: white;
      background-color: #1976d2;
      border: none;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      transition: background-color 0.2s ease, transform 0.1s ease;
      width: 90%;
      max-width: 300px;
    }

    #next-btn:active {
      transform: scale(0.98);
    }

    #next-btn:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
      transform: none;
    }

#status {
  font-size: 16px;
  text-align: center;
  color: #555;
  white-space: nowrap;        /* –ó–∞–ø—Ä–µ—â–∞–µ–º –ø–µ—Ä–µ–Ω–æ—Å */
  overflow: hidden;           /* –û–±—Ä–µ–∑–∞–µ–º, –µ—Å–ª–∏ –Ω–µ –≤–ª–µ–∑–∞–µ—Ç */
  text-overflow: ellipsis;    /* –ú–Ω–æ–≥–æ—Ç–æ—á–∏–µ, –µ—Å–ª–∏ –æ–±—Ä–µ–∑–∞–µ–º */
  padding: 0 8px;
}

    @media (max-width: 768px) {
      #task-container {
        max-height: calc(100vh - 180px);
      }
      
      .controls {
        padding: 8px 0;
      }
      
      #next-btn {
        padding: 12px 16px;
        font-size: 16px;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <div id="status">üî§ –ì–æ—Ç–æ–≤ –∫ —É—Ä–æ–∫—É</div>
    <div class="scale-controls">
      <div class="scale-btn" id="zoom-out">‚àí</div>
      <div class="scale-value" id="scale-value">1.0</div>
      <div class="scale-btn" id="zoom-in">+</div>
    </div>
  </div>

  <div id="progress-container">
    <div id="progress-bar"></div>
  </div>

  <div id="task-container">
    <iframe id="task-frame" src="about:blank" frameborder="0" allowfullscreen></iframe>
  </div>

  <div class="controls">
    <button id="next-btn">‚ñ∂Ô∏è –°—Ç–∞—Ä—Ç!</button>
  </div>
<script src="./../dictionary.js"></script>

<script>
  // –ü—Ä–æ–≤–µ—Ä–∏–º, –∑–∞–≥—Ä—É–∑–∏–ª—Å—è –ª–∏ —Å–ª–æ–≤–∞—Ä—å
  if (typeof charData === 'undefined') {
    console.error('‚ùå –°–ª–æ–≤–∞—Ä—å charData –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω! –ü—Ä–æ–≤–µ—Ä—å –ø—É—Ç—å –∫ dictionary.js');
    alert('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ª–æ–≤–∞—Ä—å –∏–µ—Ä–æ–≥–ª–∏—Ñ–æ–≤.');
  }

  // –ë–µ—Ä—ë–º —Ç–æ–ª—å–∫–æ —Ç–µ –∏–µ—Ä–æ–≥–ª–∏—Ñ—ã, —á—Ç–æ –µ—Å—Ç—å –≤ lessonwords (–Ω–∞—à —É—Ä–æ–∫)
const lessonwords = [
  '‰∏ã', 'Ë°Ü', 'Èúá', 'Âç±', 'ÁæΩ', 'Âë®', '‰ª§', 'Áôª', 'Êúõ', 'Â©¶',
  '‰∫∫', '‰πò', 'ÂçÉ', 'ÂæÅ', 'È´ò', 'Èõû', '‰∏â', 'Â§∑', 'Âæû', 'Âëº',
  'Áï¢', 'Ê¥ó', 'Â¶å', '‰∏Ä', 'Â∞π', 'ÂØá', 'Ëê¨', 'ÂÄâ'
];
  // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ
  function shuffleArray(array) {
    const arr = [...array];
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  const shuffledLesson = shuffleArray(lessonwords);
  const totalTasks = shuffledLesson.length;
  let currentTaskIndex = 0;

  // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–∞—Å—à—Ç–∞–±–∞
  let currentScale = 1.0;
  const minScale = 0.25;
  const maxScale = 2.0;
  const scaleStep = 0.1;

  const iframe = document.getElementById("task-frame");
  const statusEl = document.getElementById("status");
  const nextBtn = document.getElementById("next-btn");
  const progressBar = document.getElementById("progress-bar");
  const scaleValueEl = document.getElementById("scale-value");
  const zoomInBtn = document.getElementById("zoom-in");
  const zoomOutBtn = document.getElementById("zoom-out");

  // --- –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ ---
  function setScale(scale) {
    currentScale = Math.max(minScale, Math.min(maxScale, Math.round(scale * 10) / 10));
    iframe.style.transform = `scale(${currentScale})`;
    scaleValueEl.textContent = currentScale.toFixed(1);
  }

  zoomInBtn.addEventListener("click", () => setScale(currentScale + scaleStep));
  zoomOutBtn.addEventListener("click", () => setScale(currentScale - scaleStep));

  // --- –ü—Ä–æ–∏–≥—Ä—ã–≤–∞–Ω–∏–µ –∑–≤—É–∫–∞ ---
  function playHanziSound(hanzi) {
    const data = charData[hanzi];
    if (!data || !data.pinyin) return;

    // –£–±–∏—Ä–∞–µ–º —Ç–æ–Ω –∏–∑ –ø–∏–Ω—å–∏–Ω—è, –µ—Å–ª–∏ –µ—Å—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, b«êng ‚Üí bing2)
    let pinyinKey = data.pinyin
      .normalize('NFD') // —É–±–∏—Ä–∞–µ–º –¥–∏–∞–∫—Ä–∏—Ç–∏–∫—É
      .replace(/[\u0300-\u036f]/g, '') // –∞–∫—Ü–µ–Ω—Ç—ã
      .replace(/√º/g, 'u') // √º ‚Üí u
      .replace(/v/g, 'u') // v ‚Üí u
      + (data.pinyin.includes('ƒÅ') ? '1' :
         data.pinyin.includes('√°') ? '2' :
         data.pinyin.includes('«é') ? '3' :
         data.pinyin.includes('√†') ? '4' : '1');

    const url = `https://data.dong-chinese.com/pinyin/b/${pinyinKey}.mp3`;
    const audio = new Audio(url);

    audio.play().catch(e => {
      console.error(`‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–∏–≥—Ä–∞—Ç—å –∑–≤—É–∫ –¥–ª—è '${hanzi}':`, e);
    });
  }

// --- –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞–Ω–∏—è ---
function loadNextTask() {
  if (currentTaskIndex >= totalTasks) return;

  const hanzi = shuffledLesson[currentTaskIndex];
  const data = charData[hanzi] || { pinyin: '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ', meaning: '–∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ', lesson: '?' };
  const pinyin = data.pinyin;
  const lessonNum = data.lesson;

  const url = `tasks/task1.html?_=${Date.now()}#${hanzi}`;

  // –ö–æ–º–ø–∞–∫—Ç–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ: –Ω–µ –ª–æ–º–∞–µ—Ç –≤–µ—Ä—Å—Ç–∫—É
statusEl.textContent = `${hanzi} ‚Ä¢ ${pinyin} ‚Ä¢ —É—Ä–æ–∫ ${lessonNum}: ${data.meaning}`;
  statusEl.title = data.meaning; // –≤—Å–ø–ª—ã–≤–∞—é—â–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞

  document.getElementById("task-container").classList.add("active");

  // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ iframe
  iframe.src = '';
  setTimeout(() => {
    iframe.src = url;
  }, 10);

  // –ü—Ä–æ–∏–≥—Ä—ã–≤–∞–µ–º –∑–≤—É–∫
  setTimeout(() => playHanziSound(hanzi), 500);

  // –ü—Ä–æ–≥—Ä–µ—Å—Å
  progressBar.style.width = `${(currentTaskIndex / totalTasks) * 100}%`;
}

  // --- –ö–Ω–æ–ø–∫–∞ "–°—Ç–∞—Ä—Ç!" ‚Üí "–°–ª–µ–¥—É—é—â–µ–µ –∑–∞–¥–∞–Ω–∏–µ" ---
  nextBtn.addEventListener("click", () => {
    if (currentTaskIndex === 0) {
      nextBtn.textContent = "‚ñ∂Ô∏è –°–ª–µ–¥—É—é—â–µ–µ –∑–∞–¥–∞–Ω–∏–µ";
      loadNextTask();
      currentTaskIndex++;
      return;
    }

    if (currentTaskIndex < totalTasks) {
      loadNextTask();
      currentTaskIndex++;
      return;
    }

    // –ö–æ–Ω–µ—Ü —É—Ä–æ–∫–∞
    iframe.style.display = "none";
    nextBtn.disabled = true;
    statusEl.innerHTML = `<div style="text-align: center;">
      <h2>üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!</h2>
      <p>–í—ã –∑–∞–≤–µ—Ä—à–∏–ª–∏ —É—Ä–æ–∫<br><strong>–ò–µ—Ä–æ–≥–ª–∏—Ñ–∏–∫–∞</strong>!</p>
      <div id="fireworks" style="width: 100%; height: 200px; position: relative; background: #0000; border-radius: 8px; margin: 10px 0;"></div>
    </div>`;
    createFireworks();
    setTimeout(() => window.location.href = "../", 5000);
  });

  // --- –§–µ–π–µ—Ä–≤–µ—Ä–∫–∏ ---
  function createFireworks() {
    const container = document.getElementById("fireworks");
    const colors = ["#FF0000", "#00FF00", "#0000FF", "#FFFF00", "#FF00FF", "#00FFFF", "#FFA500", "#FFFFFF"];
    const particles = 50;

    function createExplosion(x, y) {
      for (let i = 0; i < particles; i++) {
        const particle = document.createElement("div");
        const angle = Math.random() * Math.PI * 2;
        const speed = 1 + Math.random() * 3;
        const size = 2 + Math.random() * 4;

        particle.style.position = "absolute";
        particle.style.width = `${size}px`;
        particle.style.height = `${size}px`;
        particle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        particle.style.borderRadius = "50%";
        particle.style.boxShadow = "0 0 6px currentColor";
        particle.style.left = `${x}px`;
        particle.style.top = `${y}px`;
        particle.style.pointerEvents = "none";

        container.appendChild(particle);

        let dx = Math.cos(angle) * speed;
        let dy = Math.sin(angle) * speed;
        let opacity = 1;
        let posX = x;
        let posY = y;

        const animate = () => {
          opacity -= 0.02;
          posX += dx;
          posY += dy + 0.1;
          dy += 0.05;

          particle.style.opacity = opacity;
          particle.style.left = `${posX}px`;
          particle.style.top = `${posY}px`;

          if (opacity > 0) {
            requestAnimationFrame(animate);
          } else {
            container.removeChild(particle);
          }
        };

        requestAnimationFrame(animate);
      }
    }

    for (let i = 0; i < 5; i++) {
      setTimeout(() => {
        const x = 50 + Math.random() * (container.offsetWidth - 100);
        const y = 100 + Math.random() * (container.offsetHeight - 100);
        createExplosion(x, y);
      }, i * 300);
    }
  }

  // --- –ó–∞–ø—É—Å–∫ ---
  window.addEventListener("load", () => {
    console.log("üìö –°–ª–æ–≤–∞—Ä—å charData –∑–∞–≥—Ä—É–∂–µ–Ω:", charData);
    console.log("üé≤ –ü–µ—Ä–µ–º–µ—à–∞–Ω–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫:", shuffledLesson);

    if (window.innerWidth <= 768 || (navigator.maxTouchPoints && navigator.maxTouchPoints > 1)) {
      setScale(1);
    }
  });
</script>
</body>
</html>