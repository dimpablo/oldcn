<!DOCTYPE html>
<html lang="ru">
<head>
    <script src="./../dictionary.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ö–≤–∏–∑ –ø–æ –ø–µ—Ä–µ–≤–æ–¥—É —Ç–µ–∫—Å—Ç–∞</title>
<style>
#sendTaskBtn {
    padding: 2px 6px;
    font-size: 14px;
    background-color: #a8c8d8;
    border: 1px solid #8fb8cc;
    border-radius: 4px;
    cursor: pointer;
    min-width: auto;
    width: auto;
    transition: background-color 0.2s;
}

#sendTaskBtn:hover {
    background-color: #8fb8cc;
    color: white;
}
    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        line-height: 1.5;
        color: #5a5a5a; /* –ù–µ–∂–Ω–æ-—Å–µ—Ä—ã–π —Ç–µ–∫—Å—Ç */
        padding: 10px;
        background-color: #fdf6f0; /* –ü–∞—Å—Ç–µ–ª—å–Ω—ã–π –ø–µ—Ä—Å–∏–∫–æ–≤—ã–π —Ñ–æ–Ω */
        font-size: 14px;
    }

    .container {
        max-width: 100%;
        margin: 0 auto;
    }

    .header {
        background-color: #fffaf7; /* –°–≤–µ—Ç–ª—ã–π –ø–µ—Ä—Å–∏–∫ */
        padding: 10px;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        margin-bottom: 10px;
        text-align: center;
        border: 1px solid #f5e1da; /* –ü–∞—Å—Ç–µ–ª—å–Ω—ã–π –∫–æ—Ä–∞–ª–ª */
    }

    .header h1 {
        color: #7c6b96; /* –ü–∞—Å—Ç–µ–ª—å–Ω—ã–π —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π */
        font-size: 18px;
        margin-bottom: 5px;
    }

    .header p {
        font-size: 12px;
        color: #a0a0a0;
    }

    .progress {
        background-color: #e6f4f1; /* –ü–∞—Å—Ç–µ–ª—å–Ω—ã–π –º—è—Ç–Ω—ã–π */
        padding: 8px;
        border-radius: 6px;
        margin-bottom: 10px;
        text-align: center;
        font-weight: bold;
        color: #5a9a8f; /* –ü—Ä–∏–≥–ª—É—à—ë–Ω–Ω—ã–π —Å–∏–Ω–µ-–∑–µ–ª—ë–Ω—ã–π */
        font-size: 13px;
        border: 1px solid #c2e3dd;
    }

    /* Collapsible Dictionary */
    .collapsible-container {
        border: 1px solid #d9d4e7; /* –ü–∞—Å—Ç–µ–ª—å–Ω–∞—è –ª–∞–≤–∞–Ω–¥–∞ */
        border-radius: 8px;
        overflow: hidden;
        margin-bottom: 10px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .collapsible-header {
        background-color: #f8f6fb; /* –û—á–µ–Ω—å —Å–≤–µ—Ç–ª–∞—è –ª–∞–≤–∞–Ω–¥–∞ */
        padding: 10px;
        cursor: pointer;
        font-weight: bold;
        color: #7c6b96;
        display: flex;
        justify-content: space-between;
        align-items: center;
        user-select: none;
        font-size: 13px;
        border-bottom: 1px solid #eae5f3;
    }

    .collapsible-header::after {
        content: "+";
        font-size: 18px;
        color: #9b9b9b;
    }

    .collapsible-header.active::after {
        content: "‚àí";
    }

    .collapsible-content {
        padding: 0;
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
        background-color: #fffdfb;
    }

    .collapsible-content.show {
        max-height: 400px;
        padding: 10px;
    }

    .dictionary-content {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        gap: 8px;
    }

    .dict-item {
        padding: 6px;
        background-color: #f9f7fc; /* –û—á–µ–Ω—å —Å–≤–µ—Ç–ª–∞—è –ª–∞–≤–∞–Ω–¥–∞ */
        border-radius: 6px;
        border: 1px solid #ece8f3;
        cursor: pointer;
        transition: all 0.2s;
        min-height: 55px;
    }

    .dict-item:hover {
        background-color: #f0eaf9; /* –°–≤–µ—Ç–ª–æ-—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π —Ö–æ–≤–µ—Ä */
        border-color: #d9d4e7;
    }

    .dict-char {
        font-size: 16px;
        font-weight: bold;
        color: #7c6b96;
        margin-bottom: 4px;
    }

    .dict-pinyin {
        font-size: 11px;
        color: #999999;
        margin-bottom: 2px;
    }

    .dict-meaning {
        font-size: 10px;
        color: #777777;
    }

    .task-container {
        background-color: #fffdfb;
        padding: 12px;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        margin-bottom: 12px;
    }

    .source-text {
        font-size: 16px;
        font-weight: bold;
        text-align: center;
        padding: 10px;
        margin-bottom: 12px;
        background-color: #f8f6fb;
        border-radius: 6px;
        min-height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid #eae5f3;
    }

    .task-type {
        display: inline-block;
        background-color: #e6f4f1;
        color: #5a9a8f;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 11px;
        margin-bottom: 8px;
        border: 1px solid #c2e3dd;
    }

    .words-container, .answer-container {
        border: 1px dashed #d9d4e7;
        border-radius: 6px;
        padding: 10px;
        min-height: 50px;
        margin-bottom: 12px;
        background-color: #f9f7fc;
        font-size: 13px;
    }

    .words-container {
        background-color: #f9f7fc;
    }

    .answer-container {
        background-color: #f0faf8; /* –ú—è—Ç–Ω–æ-–∫—Ä–µ–º–æ–≤—ã–π */
        border-color: #a8d8ce;
    }

    .word-list {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
    }

    .word {
        padding: 6px 10px;
        background-color: #fff;
        border: 1px solid #e0d8e9;
        border-radius: 15px;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 13px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }

    .word:hover {
        background-color: #f0eaf9;
        transform: translateY(-1px);
        border-color: #d9d4e7;
    }

.word.selected {
    background-color: #ffb6c1; /* –°–≤–µ—Ç–ª–æ-—Ä–æ–∑–æ–≤—ã–π (–ø–∞—Å—Ç–µ–ª—å–Ω—ã–π) */
    color: #ffffff;
    border-color: #ff99ab; /* –ù–µ–º–Ω–æ–≥–æ –±–æ–ª–µ–µ –Ω–∞—Å—ã—â–µ–Ω–Ω—ã–π —Ä–æ–∑–æ–≤—ã–π */
    box-shadow: 0 2px 4px rgba(255, 182, 193, 0.4); /* –õ—ë–≥–∫–∞—è —Ç–µ–Ω—å –¥–ª—è –ª—É—á—à–µ–π –≤–∏–¥–∏–º–æ—Å—Ç–∏ */
}

    #resultMessage {
        min-height: 20px;
        text-align: center;
        font-weight: bold;
        margin: 10px 0;
        padding: 8px;
        border-radius: 6px;
        font-size: 13px;
    }

    .success {
        background-color: #e8f4f1;
        color: #3c766f;
        border: 1px solid #c2e3dd;
    }

    .info {
        background-color: #f0f4fb;
        color: #4a6fa5;
        border: 1px solid #d0ddf0;
    }

    .congratulations {
        text-align: center;
        padding: 20px 12px;
        background-color: #fffdfb;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        border: 1px solid #f5e1da;
    }

    .congratulations h2 {
        color: #c28e8e; /* –ü–∞—Å—Ç–µ–ª—å–Ω—ã–π —Ä–æ–∑–æ–≤–æ-–∫–æ—Ä–∏—á–Ω–µ–≤—ã–π */
        margin-bottom: 12px;
        font-size: 18px;
    }

    .congratulations p {
        font-size: 14px;
        margin-bottom: 15px;
        color: #777;
    }

    .btn {
        display: block;
        width: 100%;
        padding: 12px;
        background-color: #a8c8d8; /* –ü–∞—Å—Ç–µ–ª—å–Ω—ã–π —Å–∏–Ω–µ–≤–∞—Ç–æ-–≥–æ–ª—É–±–æ–π */
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 15px;
        cursor: pointer;
        transition: background-color 0.3s;
        margin-top: 8px;
        border: 1px solid #8fb8cc;
    }

    .btn:hover {
        background-color: #8fb8cc;
    }

    .btn-success {
        background-color: #c2e3dd; /* –ü–∞—Å—Ç–µ–ª—å–Ω—ã–π –º—è—Ç–Ω—ã–π */
        border: 1px solid #a8d8ce;
    }

    .btn-success:hover {
        background-color: #a8d8ce;
    }

    /* Glow Animation */
    @keyframes glow {
        0% { box-shadow: 0 0 5px #c2e3dd, 0 0 10px #c2e3dd; }
        50% { box-shadow: 0 0 15px #c2e3dd, 0 0 25px #c2e3dd; }
        100% { box-shadow: 0 0 5px #c2e3dd, 0 0 10px #c2e3dd; }
    }

    .dict-item.glow {
        animation: glow 0.3s ease-in-out;
    }

    /* Hint styles */
    .hint-container {
        margin-top: 10px;
        padding: 8px;
        background-color: #fff9e6; /* –ü–∞—Å—Ç–µ–ª—å–Ω—ã–π –∂—ë–ª—Ç–æ-–∫—Ä–µ–º–æ–≤—ã–π */
        border: 1px solid #f5e6c8;
        border-radius: 6px;
        font-size: 12px;
        color: #9a8c5a;
        display: none;
    }
    .hint-container.show {
        display: block;
    }
    #hintBtn {
        background-color: #f5e6c8;
        color: #5a5a5a;
        border: 1px solid #f5e6c8;
    }
    #hintBtn:hover:not(:disabled) {
        background-color: #e6d4b0;
        border-color: #d9c69e;
    }
    #hintBtn:disabled {
        background-color: #c0c0c0;
        border-color: #a0a0a0;
        cursor: not-allowed;
    }

    /* Adaptation for very small screens */
    @media (max-width: 360px) {
        .dictionary-content {
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 6px;
        }
        .dict-item {
            padding: 5px;
            min-height: 50px;
        }
        .dict-char {
            font-size: 15px;
        }
        .dict-pinyin {
            font-size: 10px;
        }
        .dict-meaning {
            font-size: 9px;
        }
    }
</style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>–ö–≤–∏–∑ –ø–æ –ø–µ—Ä–µ–≤–æ–¥—É</h1>
            <p>–°–æ–ø–æ—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç —Å –ø–µ—Ä–µ–≤–æ–¥–æ–º</p>
        </div>

        <div class="progress">
            –û—Å—Ç–∞–ª–æ—Å—å: <span id="tasksLeft">0</span>
        </div>

        <!-- –°–≤–æ—Ä–∞—á–∏–≤–∞–µ–º—ã–π —Å–ª–æ–≤–∞—Ä—å -->
        <div class="collapsible-container">
            <div class="collapsible-header" id="collapsibleHeader"> <!-- ID –¥–ª—è JS -->
                <span>üìö –°–ª–æ–≤–∞—Ä—å (–Ω–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å)</span>
            </div>
            <div class="collapsible-content" id="collapsibleContent"> <!-- ID –¥–ª—è JS -->
                <div class="dictionary-content" id="dictionaryContent"></div>
            </div>
        </div>

        <div id="mainContent">
            <div class="task-container">

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
    <div class="task-type" id="taskType">–ü–µ—Ä–µ–≤–æ–¥ —Å –∫–∏—Ç–∞–π—Å–∫–æ–≥–æ</div>
    <button id="sendTaskBtn" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ" style="padding: 2px 6px; font-size: 14px; background-color: #a8c8d8; border: 1px solid #8fb8cc; border-radius: 4px; cursor: pointer; min-width: auto; width: auto;">–ü–æ—Å–ª–∞—Ç—å –≤ –ª–∏—á–∫—É ‚úâÔ∏è</button>
</div>
                <div class="source-text" id="sourceText">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

                <div class="words-container">
                    <div class="word-list" id="wordsList"></div>
                </div>

                <div class="answer-container">
                    <div class="word-list" id="answerList"></div>
                </div>

                <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø–æ–¥—Å–∫–∞–∑–∫–∏ -->
                <div class="hint-container" id="hintContainer">
                    –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: <span id="hintText"></span>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∞ –ø–æ–¥—Å–∫–∞–∑–∫–∏ -->
                <button id="hintBtn" class="btn">–ü–æ–¥—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç (-7 –±–∞–ª–ª–æ–≤)</button>

                <div id="resultMessage"></div>
            </div>
        </div>

        <div id="congratulations" class="congratulations" style="display: none;">
            <h2>üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!</h2>
            <p>–í—ã –ø—Ä–æ—à–ª–∏ –≤—Å–µ –∑–∞–¥–∞–Ω–∏—è!</p>
            <button class="btn btn-success" id="returnBtn">–ù–∞ –≥–ª–∞–≤–Ω—É—é</button>
        </div>
    </div>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ -->
<script src="segmentation.js"></script>
<script src="extra.js"></script>

<script>
        // ==================== FIREBASE INIT ====================
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è Firebase
        let auth = null;
        let db = null;
        let currentUser = null;
        let docRef = null;
        let getDocRef = null;
        let updateDocRef = null;


        function getRandomDecoyCount(min = 1, max = 5) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
}

        // –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase
        async function initFirebase() {
            try {
                // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –º–æ–¥—É–ª–∏ Firebase
                const { initializeApp } = await import('https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js  ');
                const { getAuth, onAuthStateChanged } = await import('https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js  ');
                const { getFirestore, doc, getDoc, updateDoc } = await import('https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js  ');

                const firebaseConfig = {
                    apiKey: "AIzaSyBvyxPtx5PICYk60HUCERw5Cxh1TyCcZCY",
                    authDomain: "antient-9bff0.firebaseapp.com",
                    projectId: "antient-9bff0",
                    storageBucket: "antient-9bff0.firebasestorage.app",
                    messagingSenderId: "311792589414",
                    appId: "1:311792589414:web:5fff3154735007c2006ba7",
                    measurementId: "G-W4ZQXWRTKK"
                };

                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                // –ü—Ä–∏—Å–≤–∞–∏–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ Firebase –≥–ª–æ–±–∞–ª—å–Ω—ã–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º
                docRef = doc;
                getDocRef = getDoc;
                updateDocRef = updateDoc;

                onAuthStateChanged(auth, (user) => {
                    currentUser = user;
                    if (user) {
                        console.log('üîê –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω:', user.displayName);
                    } else {
                        console.log('üîê –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
                    }
                });
                console.log("Firebase –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω");
            } catch (e) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase:", e);
                // –î–∞–∂–µ –µ—Å–ª–∏ Firebase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω, –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Ä–∞–±–æ—Ç—É
            }
        }


        // ==================== –°–ò–°–¢–ï–ú–ê –ë–ê–õ–õ–û–í ====================
        async function updateUserPoints(pointsChange) {
            // –ï—Å–ª–∏ Firebase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
            if (!auth || !db || !currentUser || !docRef || !getDocRef || !updateDocRef) {
                const message = pointsChange !== 0 ?
                    `–ò–∑–º–µ–Ω–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤: ${pointsChange} (–Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ - Firebase –Ω–µ –≥–æ—Ç–æ–≤)` :
                    '';
                if(message) console.log(message);
                return;
            }

            try {
                const userRef = docRef(db, 'users', currentUser.uid);

                // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –±–∞–ª–ª—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const userDoc = await getDocRef(userRef);
                let currentPoints = 0;

                if (userDoc.exists()) {
                    currentPoints = userDoc.data().points || 0;
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–ª—ã —Å —É—á–µ—Ç–æ–º —Ç–µ–∫—É—â–∏—Ö
                const newPoints = currentPoints + pointsChange;

                await updateDocRef(userRef, {
                    points: newPoints
                });

                currentUser.points = newPoints;
                console.log(`[–ë–∞–ª–ª—ã] –ò–∑–º–µ–Ω–µ–Ω–∏–µ: ${pointsChange}. –¢–µ–ø–µ—Ä—å: ${newPoints}`);
                // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –æ–±–Ω–æ–≤–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ, –µ—Å–ª–∏ –µ—Å—Ç—å
            } catch (e) {
                console.error("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –±–∞–ª–ª—ã –≤ Firestore:", e);
            }
        }


        // ==================== –ó–í–£–ö–ò –ò–ù–¢–ï–†–§–ï–ô–°–ê ====================
        const uiSounds = {
            click: null,
            hover: null,
            success: null,
            expand: null,
            collapse: null,
            hint: null // –ù–æ–≤—ã–π –∑–≤—É–∫ –¥–ª—è –ø–æ–¥—Å–∫–∞–∑–∫–∏
        };

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∏ –æ–¥–Ω–æ–≥–æ –∑–≤—É–∫–∞
        function preloadSound(path) {
            return new Promise((resolve, reject) => {
                const audio = new Audio();
                audio.src = path;
                audio.preload = 'auto';
                audio.addEventListener('canplaythrough', () => resolve(audio));
                audio.addEventListener('error', reject);
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö –∑–≤—É–∫–æ–≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        async function preloadUISounds() {
            try {
                // –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å –æ—Ç translateall.html –∫ –ø–∞–ø–∫–µ Wav
                const basePath = '../Wav/';

                // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∂–∞–µ–º –∑–≤—É–∫–∏
                uiSounds.click = await preloadSound(basePath + 'Click_Standard_00.wav');
                uiSounds.hover = await preloadSound(basePath + 'Click_Soft_00.wav');
                uiSounds.success = await preloadSound(basePath + 'Click_Electronic/Click_Electronic_05.wav');
                uiSounds.expand = await preloadSound(basePath + 'Slide_Electronic_00.wav');
                uiSounds.collapse = await preloadSound(basePath + 'Slide_Electronic_01.wav');
                // –ó–≤—É–∫ –¥–ª—è –ø–æ–¥—Å–∫–∞–∑–∫–∏
                uiSounds.hint = await preloadSound(basePath + 'Click_Mechanical_00.wav');

                console.log('–í—Å–µ –∑–≤—É–∫–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
            } catch (error) {
                console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –∑–≤—É–∫–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞:', error);
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∑–≤—É–∫–∞
        function playSound(sound) {
            if (sound) {
                // –°–æ–∑–¥–∞–µ–º –∫–ª–æ–Ω –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ–≥–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
                const soundClone = sound.cloneNode();
                soundClone.volume = 0.3; // –£–º–µ–Ω—å—à–∞–µ–º –≥—Ä–æ–º–∫–æ—Å—Ç—å
                soundClone.play().catch(e => {
                    console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –∑–≤—É–∫:', e);
                });
            }
        }

        // ==================== –°–£–©–ï–°–¢–í–£–Æ–©–ò–ô –ö–û–î ====================

        // –ö—ç—à –¥–ª—è –∞—É–¥–∏–æ—Ñ–∞–π–ª–æ–≤
        const audioCache = new Map();
        let hintUsedForCurrentTask = false; // –§–ª–∞–≥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–æ–¥—Å–∫–∞–∑–∫–∏

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∏ –∞—É–¥–∏–æ
        function preloadAudioForCharacters(characters) {
            characters.forEach(hanzi => {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∏–µ—Ä–æ–≥–ª–∏—Ñ –≤ —Å–ª–æ–≤–∞—Ä–µ charData
                if (!charData || !charData.hasOwnProperty(hanzi)) return;

                const charInfo = charData[hanzi];
                if (!charInfo || !charInfo.pinyin) return;

                const pinyin = charInfo.pinyin;

                let cleanPinyin = pinyin
                    .normalize('NFD')
                    .replace(/[\u0300-\u036f]/g, '')
                    .replace(/√º/g, 'u')
                    .replace(/v/g, 'u');

                let tone = '1';
                if (pinyin.includes('ƒÅ') || pinyin.includes('≈ç') || pinyin.includes('ƒì') || pinyin.includes('ƒ´') || pinyin.includes('≈´') || pinyin.includes('«ñ')) tone = '1';
                else if (pinyin.includes('√°') || pinyin.includes('√≥') || pinyin.includes('√©') || pinyin.includes('√≠') || pinyin.includes('√∫') || pinyin.includes('«ò')) tone = '2';
                else if (pinyin.includes('«é') || pinyin.includes('«í') || pinyin.includes('ƒõ') || pinyin.includes('«ê') || pinyin.includes('«î') || pinyin.includes('«ö')) tone = '3';
                else if (pinyin.includes('√†') || pinyin.includes('√≤') || pinyin.includes('√®') || pinyin.includes('√¨') || pinyin.includes('√π') || pinyin.includes('«ú')) tone = '4';

                const pinyinKey = cleanPinyin + tone;
                // –ò—Å–ø—Ä–∞–≤–ª—è–µ–º URL - —É–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã
                const url = `https://data.dong-chinese.com/pinyin/b/${pinyinKey}.mp3`;

                if (!audioCache.has(hanzi)) {
                    const audio = new Audio();
                    audio.src = url;
                    audio.preload = 'auto';
                    audioCache.set(hanzi, audio);

                    audio.addEventListener('error', (e) => {
                        console.warn(`–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∏—Ç—å –∞—É–¥–∏–æ –¥–ª—è ${hanzi}`);
                    });
                }
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–∑–≤—É—á–∏–≤–∞–Ω–∏—è –∏–µ—Ä–æ–≥–ª–∏—Ñ–æ–≤ —Å –≤–∏–∑—É–∞–ª—å–Ω–æ–π –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑—å—é
        function playHanziSound(hanzi, element) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∏–µ—Ä–æ–≥–ª–∏—Ñ –≤ —Å–ª–æ–≤–∞—Ä–µ charData
            if (!charData || !charData.hasOwnProperty(hanzi)) return;

            // –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å - –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –ø–µ—Ä–ª–∞–º—É—Ç—Ä–æ–º
            if (element) {
                const originalBg = element.style.backgroundColor || (element.classList.contains('selected') ? '#2ecc71' : '#fff');
                element.style.backgroundColor = '#e0f7fa';
                setTimeout(() => {
                    element.style.backgroundColor = originalBg;
                }, 300);
            }

            if (audioCache.has(hanzi)) {
                const audio = audioCache.get(hanzi);
                const audioClone = audio.cloneNode();
                audioClone.play().catch(e => {
                    console.warn(`–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∞—É–¥–∏–æ –¥–ª—è ${hanzi}`);
                });
            } else {
                const charInfo = charData[hanzi];
                if (!charInfo || !charInfo.pinyin) return;

                const pinyin = charInfo.pinyin;

                let cleanPinyin = pinyin
                    .normalize('NFD')
                    .replace(/[\u0300-\u036f]/g, '')
                    .replace(/√º/g, 'u')
                    .replace(/v/g, 'u');

                let tone = '1';
                if (pinyin.includes('ƒÅ') || pinyin.includes('≈ç') || pinyin.includes('ƒì') || pinyin.includes('ƒ´') || pinyin.includes('≈´') || pinyin.includes('«ñ')) tone = '1';
                else if (pinyin.includes('√°') || pinyin.includes('√≥') || pinyin.includes('√©') || pinyin.includes('√≠') || pinyin.includes('√∫') || pinyin.includes('«ò')) tone = '2';
                else if (pinyin.includes('«é') || pinyin.includes('«í') || pinyin.includes('ƒõ') || pinyin.includes('«ê') || pinyin.includes('«î') || pinyin.includes('«ö')) tone = '3';
                else if (pinyin.includes('√†') || pinyin.includes('√≤') || pinyin.includes('√®') || pinyin.includes('√¨') || pinyin.includes('√π') || pinyin.includes('«ú')) tone = '4';

                const pinyinKey = cleanPinyin + tone;
                // –ò—Å–ø—Ä–∞–≤–ª—è–µ–º URL - —É–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã
                const url = `https://data.dong-chinese.com/pinyin/b/${pinyinKey}.mp3`;

                const audio = new Audio(url);
                audio.play().catch(e => {
                    console.warn(`–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –∑–≤—É–∫ –¥–ª—è ${hanzi}: ${url}`);
                });
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–∑–≤—É—á–∏–≤–∞–Ω–∏—è –∏–µ—Ä–æ–≥–ª–∏—Ñ–∞ –∏–∑ —Å–ª–æ–≤–∞—Ä—è —Å —ç—Ñ—Ñ–µ–∫—Ç–æ–º —Å–≤–µ—á–µ–Ω–∏—è
        function playDictionaryHanziSound(hanzi, element) {
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å —Å–≤–µ—á–µ–Ω–∏—è
            element.classList.add('glow');

            // –£–¥–∞–ª—è–µ–º –∫–ª–∞—Å—Å —á–µ—Ä–µ–∑ 300–º—Å
            setTimeout(() => {
                element.classList.remove('glow');
            }, 300);

            // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∑–≤—É–∫
            playHanziSound(hanzi, element);
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–ª–æ–≤–∞—Ä—è
        function renderDictionary() {
            const dictionaryContent = document.getElementById('dictionaryContent');
            dictionaryContent.innerHTML = '';

            // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç –∏–∑ –≤—Å–µ—Ö –Ω—É–∂–Ω—ã—Ö –º–µ—Å—Ç
            const sourceText = document.getElementById('sourceText').textContent;
            const wordsList = document.getElementById('wordsList').textContent;
            const answerList = document.getElementById('answerList').textContent;

            const allText = sourceText + wordsList + answerList;
            const chars = [...allText]; // —Ä–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ —Å–∏–º–≤–æ–ª—ã

            // –ü–æ–ª—É—á–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –µ—Å—Ç—å –≤ charData
            const uniqueChars = [...new Set(chars)]
                .filter(char => charData && charData.hasOwnProperty(char));

            uniqueChars.forEach(char => {
                const charInfo = charData[char];
                const dictItem = document.createElement('div');
                dictItem.className = 'dict-item';
                dictItem.dataset.hanzi = char;
                dictItem.innerHTML = `
                    <div class="dict-char">${char}</div>
                    <div class="dict-pinyin">${charInfo.pinyin}</div>
                    <div class="dict-meaning">${charInfo.meaning}</div>
                `;

                // –î–æ–±–∞–≤–ª—è–µ–º –∑–≤—É–∫ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç —Å–ª–æ–≤–∞—Ä—è
                dictItem.addEventListener('click', function() {
                    playSound(uiSounds.click); // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∑–≤—É–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
                    playDictionaryHanziSound(char, this);
                });

                dictionaryContent.appendChild(dictItem);
            });
        }

        document.addEventListener('DOMContentLoaded', async function() { // async
            // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
            await initFirebase(); // –î–æ–∂–∏–¥–∞–µ–º—Å—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase
            await preloadUISounds(); // –î–æ–∂–∏–¥–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∫–∏ –∑–≤—É–∫–æ–≤

            // ==================== –§–£–ù–ö–¶–ò–ò ====================
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ç—Ä–æ–∫–∏ –∑–∞–¥–∞–Ω–∏—è
function getTaskShareString(task, currentAnswerWords) {
    const tokens = task.words.map(w => `"${w}"`).join(', ');
    if (task.type === 'toTranslation') {
        // –ü—Ä—è–º–æ–µ: [original]->[translation]
        return `''''[original]->[translation]: {"${task.source}"}->{"${task.correctAnswer}"}; [tokens]: {${tokens}}''''`;
    } else {
        // –û–±—Ä–∞—Ç–Ω–æ–µ: [translation]->[original]
        return `''''[translation]->[original]: {"${task.source}"}->{"${task.correctAnswer}"}; [tokens]: {${tokens}}''''`;
    }
}

            // ==================== –°–û–ë–´–¢–ò–Ø –ò–ù–¢–ï–†–§–ï–ô–°–ê ====================
            // –°–≤–æ—Ä–∞—á–∏–≤–∞–µ–º—ã–π —Å–ª–æ–≤–∞—Ä—å
            const collapsibleHeader = document.getElementById('collapsibleHeader');
            const collapsibleContent = document.getElementById('collapsibleContent');
            const sendTaskBtn = document.getElementById('sendTaskBtn');
            const modalShareTask = document.getElementById('modalShareTask');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const shareTaskFrame = document.getElementById('shareTaskFrame');
            const loadingIframe = document.getElementById('loadingIframe');

            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏
            closeModalBtn.addEventListener('click', () => {
                modalShareTask.style.display = 'none';
                shareTaskFrame.src = ''; // –û—á–∏—â–∞–µ–º iframe –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
            });

            // –ö–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ "–û—Ç–ø—Ä–∞–≤–∏—Ç—å"
            sendTaskBtn.addEventListener('click', async function() {
                playSound(uiSounds.click);

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                if (!currentUser || !currentUser.uid) {
                    alert('‚õî –°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç, —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è.');
                    return;
                }

                const task = tasks[currentTaskIndex];
                const shareString = getTaskShareString(task, currentAnswer); // currentAnswer ‚Äî –º–∞—Å—Å–∏–≤ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å–ª–æ–≤

                // URL-–∫–æ–¥–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É –∑–∞–¥–∞–Ω–∏—è
                const encodedShareString = encodeURIComponent(shareString);

                // –§–æ—Ä–º–∏—Ä—É–µ–º URL –¥–ª—è iframe
                const chatUrl = `../chat.html#chat/${currentUser.uid}/${encodedShareString}`;

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É, —Å–∫—Ä—ã–≤–∞–µ–º iframe
                if (loadingIframe) {
                    loadingIframe.style.display = 'block';
                }
                shareTaskFrame.style.display = 'none';
                shareTaskFrame.src = ''; // –°–Ω–∞—á–∞–ª–∞ –æ—á–∏—â–∞–µ–º

                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º src iframe
                setTimeout(() => {
                    shareTaskFrame.src = chatUrl;
                    shareTaskFrame.onload = () => {
                        if (loadingIframe) {
                            loadingIframe.style.display = 'none';
                        }
                        shareTaskFrame.style.display = 'block';
                    };
                }, 10);

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
                modalShareTask.style.display = 'flex';
            });

            collapsibleHeader.addEventListener('click', function() {
                this.classList.toggle('active');
                collapsibleContent.classList.toggle('show');

                // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∑–≤—É–∫ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è
                if (collapsibleContent.classList.contains('show')) {
                    playSound(uiSounds.expand);
                } else {
                    playSound(uiSounds.collapse);
                }
            });

            // –ö–Ω–æ–ø–∫–∞ "–ù–∞ –≥–ª–∞–≤–Ω—É—é"
            const returnBtn = document.getElementById('returnBtn');
            returnBtn.addEventListener('click', function() {
                playSound(uiSounds.click);
                window.location.href = '../index.html';
            });

            // Hover —ç—Ñ—Ñ–µ–∫—Ç—ã –¥–ª—è –∫–Ω–æ–ø–æ–∫ (–∫—Ä–æ–º–µ hintBtn)
            document.querySelectorAll('.btn:not(#hintBtn), .word, .dict-item').forEach(el => {
                el.addEventListener('mouseenter', () => playSound(uiSounds.hover));
            });

            // ==================== –õ–û–ì–ò–ö–ê –ü–û–î–°–ö–ê–ó–ö–ò ====================
            const hintBtn = document.getElementById('hintBtn');
            const hintContainer = document.getElementById('hintContainer');
            const hintText = document.getElementById('hintText');

            hintBtn.addEventListener('click', async function() {
                if (hintUsedForCurrentTask) return; // –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

                playSound(uiSounds.hint); // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∑–≤—É–∫ –ø–æ–¥—Å–∫–∞–∑–∫–∏
                hintUsedForCurrentTask = true;
                this.disabled = true;

                // –°–Ω–∏–º–∞–µ–º –±–∞–ª–ª—ã
                await updateUserPoints(-7);

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É
                const currentTask = tasks[currentTaskIndex];
                if (currentTask.type === 'toTranslation') {
                    hintText.textContent = currentTask.correctAnswer;
                } else {
                    // –î–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ —Å —Ä—É—Å—Å–∫–æ–≥–æ –Ω–∞ –∫–∏—Ç–∞–π—Å–∫–∏–π –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–∏–º–≤–æ–ª—ã —Ä–∞–∑–¥–µ–ª—å–Ω–æ
                    hintText.textContent = currentTask.correctAnswer.split('').join(' ');
                }
                hintContainer.classList.add('show');
            });

            // ==================== –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê ====================
            // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ SentenceData —Ç–µ–ø–µ—Ä—å –≤–Ω—É—Ç—Ä–∏ DOMContentLoaded, –≥–¥–µ –æ–Ω–∞ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞
// –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
if (typeof SentenceData === 'undefined' || !SentenceData.sentences || !Array.isArray(SentenceData.sentences)) {
    console.error("SentenceData –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∏–ª–∏ –∏–º–µ–µ—Ç –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç!");
    document.getElementById('sourceText').textContent = "–û—à–∏–±–∫–∞: –¥–∞–Ω–Ω—ã–µ —É—Ä–æ–∫–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.";
    return;
}

// –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ, –Ω–æ –µ—Å–ª–∏ –µ—Å—Ç—å ‚Äî –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤–∞–ª–∏–¥–Ω—ã)
let extraSentences = [];
if (typeof extra !== 'undefined' && extra.sentences && Array.isArray(extra.sentences)) {
    console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${extra.sentences.length} –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –∏–∑ extra.js`);
    extraSentences = extra.sentences;
} else {
    console.warn("‚ö†Ô∏è –§–∞–π–ª extra.js –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω –∏–ª–∏ –∏–º–µ–µ—Ç –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π.");
}


// –û–±—ä–µ–¥–∏–Ω—è–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞
const allSentences = [...SentenceData.sentences, ...extraSentences];

const allOriginals = allSentences.map(s => s.original);
const allTranslations = allSentences.map(s => s.translation);

function cleanRussian(text) {
    return text.replace(/[^\p{L}\p{N}\s]/gu, '').toLowerCase().trim();
}

            const allRussianWords = [];
            allTranslations.forEach(trans => {
                const cleaned = cleanRussian(trans);
                allRussianWords.push(...cleaned.split(' ').filter(word => word));
            });

            const allChineseChars = [];
            allOriginals.forEach(orig => {
                allChineseChars.push(...orig.split(''));
            });

            function shuffleArray(array) {
                const arr = [...array];
                for (let i = arr.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [arr[i], arr[j]] = [arr[j], arr[i]];
                }
                return arr;
            }

let tasks = [];
allSentences.forEach(sentence => {
    const actualRussianWords = cleanRussian(sentence.translation).split(' ').filter(w => w);
    const actualChineseChars = sentence.original.split('');

    // --- –î–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ —Å –∫–∏—Ç–∞–π—Å–∫–æ–≥–æ –Ω–∞ —Ä—É—Å—Å–∫–∏–π ---
    // –§–∏–ª—å—Ç—Ä—É–µ–º –æ–±—â–∏–π –ø—É–ª —Å–ª–æ–≤: —Ç–æ–ª—å–∫–æ —Ç–µ, –∫–æ—Ç–æ—Ä—ã—Ö –ù–ï–¢ –≤ –Ω–∞—Å—Ç–æ—è—â–µ–º –æ—Ç–≤–µ—Ç–µ
    const availableRussianDecoys = allRussianWords.filter(word => !actualRussianWords.includes(word));
    // –£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –∏–∑ –ø—É–ª–∞ –æ–±–º–∞–Ω–æ–∫
    const uniqueRussianDecoys = [...new Set(availableRussianDecoys)];
    // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º
    const shuffledRussianDecoys = shuffleArray(uniqueRussianDecoys);
    // –ë–µ—Ä—ë–º —Å–ª—É—á–∞–π–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç 1 –¥–æ 5, –Ω–æ –Ω–µ –±–æ–ª—å—à–µ, —á–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ
    const russianDecoyCount = Math.min(getRandomDecoyCount(), shuffledRussianDecoys.length);
    const russianDecoys = shuffledRussianDecoys.slice(0, russianDecoyCount);

    tasks.push({
        type: 'toTranslation',
        source: sentence.original,
        correctAnswer: cleanRussian(sentence.translation),
        words: shuffleArray([...actualRussianWords, ...russianDecoys]),
        direction: '—Å –∫–∏—Ç–∞–π—Å–∫–æ–≥–æ –Ω–∞ —Ä—É—Å—Å–∫–∏–π'
    });

    // --- –î–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ —Å —Ä—É—Å—Å–∫–æ–≥–æ –Ω–∞ –∫–∏—Ç–∞–π—Å–∫–∏–π ---
    const availableChineseDecoys = allChineseChars.filter(char => !actualChineseChars.includes(char));
    const uniqueChineseDecoys = [...new Set(availableChineseDecoys)];
    const shuffledChineseDecoys = shuffleArray(uniqueChineseDecoys);
    const chineseDecoyCount = Math.min(getRandomDecoyCount(), shuffledChineseDecoys.length);
    const chineseDecoys = shuffledChineseDecoys.slice(0, chineseDecoyCount);

    tasks.push({
        type: 'toOriginal',
        source: sentence.translation,
        correctAnswer: sentence.original,
        words: shuffleArray([...actualChineseChars, ...chineseDecoys]),
        direction: '—Å —Ä—É—Å—Å–∫–æ–≥–æ –Ω–∞ –∫–∏—Ç–∞–π—Å–∫–∏–π'
    });
});

            tasks = shuffleArray(tasks);

            let currentTaskIndex = 0;
            let currentAnswer = [];

            const sourceText = document.getElementById('sourceText');
            const wordsList = document.getElementById('wordsList');
            const answerList = document.getElementById('answerList');
            const resultMessage = document.getElementById('resultMessage');
            const tasksLeft = document.getElementById('tasksLeft');
            const taskType = document.getElementById('taskType');
            const mainContent = document.getElementById('mainContent');
            const congratulations = document.getElementById('congratulations');
            const returnBtnCongrats = document.getElementById('returnBtn'); // –£–∂–µ –µ—Å—Ç—å, –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º

            function renderTask() {
                if (currentTaskIndex >= tasks.length) {
                    showCompletionScreen();
                    return;
                }

                // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–¥—Å–∫–∞–∑–∫–∏ –¥–ª—è –Ω–æ–≤–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è
                hintUsedForCurrentTask = false;
                hintBtn.disabled = false;
                hintContainer.classList.remove('show');

                const task = tasks[currentTaskIndex];
                taskType.textContent = `–ü–µ—Ä–µ–≤–æ–¥ ${task.direction}`;
                sourceText.textContent = task.source;
                tasksLeft.textContent = tasks.length - currentTaskIndex;

                currentAnswer = [];
                answerList.innerHTML = '';
                wordsList.innerHTML = '';

                if (task.type === 'toOriginal') {
                    // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∂–∞–µ–º –∞—É–¥–∏–æ –¥–ª—è –∫–∏—Ç–∞–π—Å–∫–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤
                    const chineseCharacters = task.words.filter(word => charData && charData.hasOwnProperty(word));
                    preloadAudioForCharacters(chineseCharacters);
                }

                task.words.forEach(word => {
                    const el = document.createElement('div');
                    el.className = 'word';
                    el.textContent = word;
                    el.dataset.word = word;
                    wordsList.appendChild(el);
                });

                document.querySelectorAll('#wordsList .word').forEach(el => {
                    el.addEventListener('click', async function() { // async
                        playSound(uiSounds.click); // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∑–≤—É–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
                        const word = this.dataset.word;

                        // –û–∑–≤—É—á–∏–≤–∞–µ–º —Å –≤–∏–∑—É–∞–ª—å–Ω–æ–π –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑—å—é
                        playHanziSound(word, this);

                        this.remove();

                        const answerEl = document.createElement('div');
                        answerEl.className = 'word selected';
                        answerEl.textContent = word;
                        answerEl.dataset.word = word;
                        answerList.appendChild(answerEl);

                        currentAnswer.push(word);
                        await checkAnswer(); // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
                    });
                });

                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–ª–æ–≤–∞—Ä—å –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –∑–∞–¥–∞—á–∏
                setTimeout(renderDictionary, 100);

                resultMessage.className = 'info';
                resultMessage.textContent = '–°–æ–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–µ–≤–æ–¥. –ö–ª–∏–∫ –ø–æ –∏–µ—Ä–æ–≥–ª–∏—Ñ—É –æ–∑–≤—É—á–∏–≤–∞–µ—Ç –µ–≥–æ.';
            }

            // ========== –ò–ó–ú–ï–ù–ï–ù–ê –õ–û–ì–ò–ö–ê –ü–†–û–í–ï–†–ö–ò ==========
            async function checkAnswer() {
                const task = tasks[currentTaskIndex];
                const currentText = currentAnswer.join(' ').trim();

                if (task.type === 'toTranslation') {
                    if (currentText === task.correctAnswer) {
                        playSound(uiSounds.success); // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∑–≤—É–∫ —É—Å–ø–µ—Ö–∞
                        await updateUserPoints(5); // –ù–∞—á–∏—Å–ª—è–µ–º 5 –±–∞–ª–ª–æ–≤
                        showSuccess();
                    }
                } else { 
                    const currentTextOriginal = currentAnswer.join(''); // –î–ª—è –∫–∏—Ç–∞–π—Å–∫–æ–≥–æ —Å–∫–ª–µ–∏–≤–∞–µ–º –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤
                    if (currentTextOriginal === task.correctAnswer) {
                        playSound(uiSounds.success); // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∑–≤—É–∫ —É—Å–ø–µ—Ö–∞
                        await updateUserPoints(5); // –ù–∞—á–∏—Å–ª—è–µ–º 5 –±–∞–ª–ª–æ–≤
                        showSuccess();
                    }
                    // –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ —Å —Ä—É—Å—Å–∫–æ–≥–æ –Ω–∞ –∫–∏—Ç–∞–π—Å–∫–∏–π
                    // else if (currentAnswer.length >= task.correctAnswer.length) {
                    //    // —Ç–µ—Ä–ø–∏–º - –ù–∏–∫–∞–∫–æ–π —Ä–µ–∞–∫—Ü–∏–∏
                    // }
                }
            }

            function showSuccess() {
                resultMessage.className = 'success';
                resultMessage.textContent = '‚úÖ –í–µ—Ä–Ω–æ! +5 –±–∞–ª–ª–æ–≤. –°–ª–µ–¥—É—é—â–µ–µ –∑–∞–¥–∞–Ω–∏–µ...';

                setTimeout(() => {
                    currentTaskIndex++;
                    renderTask();
                }, 1200);
            }

            answerList.addEventListener('click', async function(e) { // async
                if (e.target.classList.contains('word')) {
                    playSound(uiSounds.click); // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∑–≤—É–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
                    const word = e.target.dataset.word;

                    // –û–∑–≤—É—á–∏–≤–∞–µ–º —Å –≤–∏–∑—É–∞–ª—å–Ω–æ–π –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑—å—é
                    playHanziSound(word, e.target);

                    e.target.remove();

                    const wordEl = document.createElement('div');
                    wordEl.className = 'word';
                    wordEl.textContent = word;
                    wordEl.dataset.word = word;
                    wordsList.appendChild(wordEl);

                    const index = currentAnswer.indexOf(word);
                    if (index !== -1) currentAnswer.splice(index, 1);

                    wordEl.addEventListener('click', async function() { // async
                        playSound(uiSounds.click); // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∑–≤—É–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
                        const w = this.dataset.word;

                        // –û–∑–≤—É—á–∏–≤–∞–µ–º —Å –≤–∏–∑—É–∞–ª—å–Ω–æ–π –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑—å—é
                        playHanziSound(w, this);

                        this.remove();
                        const aEl = document.createElement('div');
                        aEl.className = 'word selected';
                        aEl.textContent = w;
                        aEl.dataset.word = w;
                        answerList.appendChild(aEl);
                        currentAnswer.push(w);
                        await checkAnswer(); // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
                    });

                }
            });

            function showCompletionScreen() {
                mainContent.style.display = 'none';
                congratulations.style.display = 'block';
            }

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–µ—Ä–≤—É—é –∑–∞–¥–∞—á—É
            renderTask();
        });
    </script>
    <script src="../uploader.js"></script>
<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–¥–∞–Ω–∏—è -->
<div id="modalShareTask" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; flex-direction: column; padding: 20px;">
    <div style="background: white; padding: 20px; border-radius: 12px; width: 90%; max-width: 800px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); display: flex; flex-direction: column; gap: 15px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0; color: #5a5a5a;">‚úâÔ∏è –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ</h3>
            <button id="closeModalBtn" style="background: none; border: none; font-size: 20px; cursor: pointer;">√ó</button>
        </div>
        <iframe id="shareTaskFrame" src="" style="flex: 1; width: 100%; min-height: 500px; border: none; border-radius: 8px;"></iframe>
    </div>
</div>
</body>
</html>