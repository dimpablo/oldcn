<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ß–∞—Ç</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', sans-serif;
      background: #f0f2f5;
      color: #333;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    #chat-header {
      background: #00838f;
      color: white;
      padding: 15px;
      text-align: center;
    }
    #messages-list {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .msg-bubble {
      max-width: 70%;
      padding: 10px 14px;
      border-radius: 18px;
      margin: 4px 0;
      word-wrap: break-word;
    }
    .msg-from-me {
      background: #00838f;
      color: white;
      align-self: flex-end;
    }
    .msg-from-them {
      background: #e0e0e0;
      color: black;
      align-self: flex-start;
    }
    .msg-read-indicator {
      font-size: 9px;
      opacity: 0.6;
      margin-top: 2px;
      color: #666;
      text-align: right;
    }
    #chat-controls {
      display: flex;
      padding: 10px;
      gap: 10px;
      background: white;
      border-top: 1px solid #ddd;
    }
    #message-input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
    }
    #send-message-btn {
      padding: 10px 16px;
      background: #00838f;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    #send-message-btn:hover {
      background: #006064;
    }
    #debug-panel {
      background: #ffeb3b;
      color: #333;
      padding: 8px;
      font-size: 12px;
      font-family: monospace;
      overflow-x: auto;
      white-space: pre-wrap;
      border-top: 1px solid #ddd;
      display: none;
    }
    .debug-title {
      font-weight: bold;
      margin-bottom: 4px;
    }
  </style>
</head>
<body>

  <div id="chat-header">
    <h3 id="chat-name">–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞</h3>
  </div>

  <div id="messages-list"></div>

  <div id="chat-controls">
    <input type="text" id="message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." />
    <button id="send-message-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  </div>

  <div id="debug-panel">
    <div class="debug-title">üîç –û–¢–õ–ê–î–ö–ê: –ü–†–û–ß–ò–¢–ê–ù–ù–´–ï –°–û–û–ë–©–ï–ù–ò–Ø</div>
    <div id="debug-log"></div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js';
    import {
      getFirestore,
      collection,
      query,
      where,
      onSnapshot,
      addDoc,
      doc,
      getDoc,
      updateDoc,
      arrayUnion,
      getDocs
    } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBvyxPtx5PICYk60HUCERw5Cxh1TyCcZCY",
      authDomain: "antient-9bff0.firebaseapp.com",
      projectId: "antient-9bff0",
      storageBucket: "antient-9bff0.firebasestorage.app",
      messagingSenderId: "311792589414",
      appId: "1:311792589414:web:5fff3154735007c2006ba7",
      measurementId: "G-W4ZQXWRTKK"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;
    let otherUser = null;

    // === DEBUG UTILITY ===
    const debugLog = document.getElementById('debug-log');
    function logDebug(message) {
      const now = new Date().toISOString().slice(11, 23);
      const line = `[${now}] ${message}`;
      debugLog.innerHTML += line + '<br>';
      debugLog.scrollTop = debugLog.scrollHeight;
      console.log('[DEBUG]', message);
    }

    function showDebugPanel() {
      document.getElementById('debug-panel').style.display = 'block';
    }

    function getOtherUserIdFromHash() {
      const match = window.location.hash.match(/^#chat\/([^\/]+)$/);
      return match ? match[1] : null;
    }

    function onHashChange() {
      const otherUserId = getOtherUserIdFromHash();
      if (!otherUserId) {
        document.getElementById('chat-name').textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞';
        document.getElementById('messages-list').innerHTML = '';
        logDebug('‚ö†Ô∏è –•—ç—à –ø—É—Å—Ç ‚Äî —á–∞—Ç –Ω–µ –≤—ã–±—Ä–∞–Ω');
        return;
      }

      if (currentUser && otherUserId !== currentUser.uid) {
        logDebug(`üîÑ –ó–∞–≥—Ä—É–∂–∞–µ–º —á–∞—Ç —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º: ${otherUserId}`);
        loadChatAndStartListening(otherUserId);
      } else if (otherUserId === currentUser?.uid) {
        logDebug('‚ùå –ù–µ–ª—å–∑—è –æ–±—â–∞—Ç—å—Å—è —Å —Å–∞–º–∏–º —Å–æ–±–æ–π!');
        document.getElementById('chat-name').textContent = '–ù–µ–ª—å–∑—è —á–∞—Ç–∏—Ç—å—Å—è —Å —Å–æ–±–æ–π';
      }
    }

    async function loadChatAndStartListening(otherUserId) {
      try {
        logDebug(`üì• –ó–∞–ø—Ä–æ—Å –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${otherUserId}`);
        const userRef = doc(db, 'users', otherUserId);
        const userSnap = await getDoc(userRef);

        if (userSnap.exists()) {
          otherUser = { id: userSnap.id, ...userSnap.data() };
          document.getElementById('chat-name').textContent = otherUser.displayName || otherUser.email || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π';
          logDebug(`‚úÖ –£—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω –ø—Ä–æ—Ñ–∏–ª—å: ${otherUser.displayName || otherUser.email}`);
        } else {
          document.getElementById('chat-name').textContent = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω';
          logDebug(`‚ùå –ü—Ä–æ—Ñ–∏–ª—å —Å ID ${otherUserId} –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ 'users'`);
          alert(`–û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å ID ${otherUserId} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ.`);
          return;
        }

        logDebug(`üì° –ù–∞—á–∏–Ω–∞–µ–º —Å–ª—É—à–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –¥–∏–∞–ª–æ–≥–∞ —Å ${otherUserId}`);
        startListeningToMessages(otherUserId);

      } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–∞:', e);
        document.getElementById('chat-name').textContent = '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è';
        logDebug(`üö® –û–®–ò–ë–ö–ê –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–æ—Ñ–∏–ª—è: ${e.message || JSON.stringify(e)}`);
      }
    }

    function startListeningToMessages(otherUserId) {
      const chatQuery = query(
        collection(db, 'messages'),
        where('participants', 'array-contains', currentUser.uid)
      );

      logDebug(`üîé –ò—â–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è, –≥–¥–µ —É—á–∞—Å—Ç–≤—É–µ—Ç —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (${currentUser.uid})`);

      onSnapshot(chatQuery, (snapshot) => {
        logDebug(`üìä –ü–æ–ª—É—á–µ–Ω–æ ${snapshot.size} —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ –æ–±—â–µ–≥–æ –Ω–∞–±–æ—Ä–∞ (–≤—Å–µ, –≥–¥–µ –µ—Å—Ç—å —è)`);

        const messages = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          const participants = data.participants || [];
          const hasMe = participants.includes(currentUser.uid);
          const hasOther = participants.includes(otherUserId);

          if (hasMe && hasOther) {
            messages.push({ id: doc.id, ...data });
            logDebug(`üìÑ –ù–∞–π–¥–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ (${doc.id}): –æ—Ç ${data.from}, —É—á–∞—Å—Ç–Ω–∏–∫–∏: [${participants.join(', ')}], seenBy: ${JSON.stringify(data.seenBy || [])}`);
          } else {
            logDebug(`üîá –ü—Ä–æ–ø—É—â–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ (${doc.id}): —É—á–∞—Å—Ç–Ω–∏–∫–∏ [${participants.join(', ')}] ‚Äî –Ω–µ—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è —Å ${otherUserId}`);
          }
        });

        messages.sort((a, b) => a.timestamp - b.timestamp);
        renderMessages(messages, otherUserId);

        // ‚úÖ –ü–æ–º–µ—á–∞–µ–º –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —ç—Ç–æ–º –¥–∏–∞–ª–æ–≥–µ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ
        logDebug(`üîñ –ù–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å –ø–æ–º–µ—Ç–∫–∏ –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö –¥–ª—è –¥–∏–∞–ª–æ–≥–∞ —Å ${otherUserId}`);
        markMessagesAsRead(otherUserId);

      }, (error) => {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
        logDebug(`üö® –û–®–ò–ë–ö–ê –ø—Ä–∏ –ø–æ–¥–ø–∏—Å–∫–µ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è: ${error.message}`);
        alert('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å.');
      });
    }

    function renderMessages(msgs, otherUserId) {
      const list = document.getElementById('messages-list');
      list.innerHTML = '';

      msgs.forEach(msg => {
        const fromMe = msg.from === currentUser.uid;
        const div = document.createElement('div');
        div.className = 'msg-bubble ' + (fromMe ? 'msg-from-me' : 'msg-from-them');

        const timestamp = new Date(msg.timestamp).toLocaleTimeString();

        let readStatus = '';
        if (!fromMe && msg.seenBy && msg.seenBy.includes(currentUser.uid)) {
          readStatus = '<div class="msg-read-indicator">‚úì –ü—Ä–æ—á–∏—Ç–∞–Ω–æ</div>';
        }

        div.innerHTML = `
          <div>${msg.text}</div>
          <div style="font-size:11px;opacity:0.7;margin-top:4px;">
            ${timestamp}
          </div>
          ${readStatus}
        `;
        list.appendChild(div);
      });

      list.scrollTop = list.scrollHeight;
      logDebug(`üñºÔ∏è –û—Ç—Ä–µ–Ω–¥–µ—Ä–µ–Ω–æ ${msgs.length} —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ`);
    }

    // ‚úÖ –ü–û–õ–ù–ê–Ø –û–¢–õ–ê–î–ö–ê –ü–û–ú–ï–¢–ö–ò –ö–ê–ö –ü–†–û–ß–ò–¢–ê–ù–ù–´–•

// ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø: –ë–µ–∑ –¥–≤—É—Ö array-contains!
async function markMessagesAsRead(otherUserId) {
  logDebug(`======== –ü–û–ú–ï–¢–ö–ê –ö–ê–ö –ü–†–û–ß–ò–¢–ê–ù–ù–´–ï: –ù–ê–ß–ê–õ–û ========`);
  logDebug(`üë§ –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${currentUser.uid}`);
  logDebug(`üë• –°–æ–±–µ—Å–µ–¥–Ω–∏–∫: ${otherUserId}`);

  if (!currentUser || !otherUserId) {
    logDebug(`‚ùå –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø–æ–º–µ—Ç–∏—Ç—å: currentUser –∏–ª–∏ otherUserId –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã`);
    return;
  }

  // üö´ –£–ë–†–ê–õ–ò –≤—Ç–æ—Ä–æ–π array-contains ‚Äî —Ç–µ–ø–µ—Ä—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω!
  const q = query(
    collection(db, 'messages'),
    where('participants', 'array-contains', currentUser.uid)
  );

  logDebug(`üîé –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ Firestore: –ø–æ–∏—Å–∫ –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π, –≥–¥–µ —É—á–∞—Å—Ç–≤—É–µ—Ç —è (${currentUser.uid})`);

  try {
    const snapshot = await getDocs(q);
    logDebug(`‚úÖ –ü–æ–ª—É—á–µ–Ω–æ ${snapshot.size} –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤, –≥–¥–µ —É—á–∞—Å—Ç–≤—É–µ—Ç —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å`);

    const docsToUpdate = [];
    let totalRelevant = 0;

    snapshot.forEach((doc) => {
      const data = doc.data();
      const participants = data.participants || [];

      // üîç –ü–†–û–í–ï–†–ö–ê: –°–û–î–ï–†–ñ–ò–¢ –õ–ò –≠–¢–û –°–û–û–ë–©–ï–ù–ò–ï –¢–û–ñ–ï –°–û–ë–ï–°–ï–î–ù–ò–ö–ê?
      if (participants.includes(otherUserId)) {
        totalRelevant++;
        const currentSeenBy = data.seenBy || [];

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø –¥–∞–Ω–Ω—ã—Ö
        if (!Array.isArray(currentSeenBy)) {
          logDebug(`‚ö†Ô∏è –ù–ï–û–ñ–ò–î–ê–ù–ù–´–ô –¢–ò–ü seenBy –≤ –¥–æ–∫—É–º–µ–Ω—Ç–µ ${doc.id}: ${typeof currentSeenBy} ‚Äî –æ–∂–∏–¥–∞–ª—Å—è Array`);
          logDebug(`   –î–∞–Ω–Ω—ã–µ: ${JSON.stringify(data)}`);
        }

        const alreadyRead = currentSeenBy.includes(currentUser.uid);

        logDebug(`üìÑ –°–æ–æ–±—â–µ–Ω–∏–µ ${doc.id}: —É—á–∞—Å—Ç–Ω–∏–∫–∏ [${participants.join(', ')}] | —É–∂–µ –ø—Ä–æ—á–∏—Ç–∞–Ω–æ? ${alreadyRead ? '‚úÖ' : '‚ùå'} | seenBy: [${currentSeenBy.join(', ')}]`);

        if (!alreadyRead) {
          docsToUpdate.push({
            ref: doc.ref,
            currentSeenBy: [...currentSeenBy],
            docId: doc.id,
            participants: participants
          });
        }
      } else {
        logDebug(`üîá –ü—Ä–æ–ø—É—â–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ ${doc.id}: —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏ —è–≤–ª—è—é—Ç—Å—è [${participants.join(', ')}], –Ω–æ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ ${otherUserId} –Ω–µ—Ç`);
      }
    });

    logDebug(`üìä –ò–∑ ${snapshot.size} –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π: ${totalRelevant} ‚Äî –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞—Ç –¥–∏–∞–ª–æ–≥—É —Å ${otherUserId}`);
    logDebug(`üìã –í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ${docsToUpdate.length}`);

    if (docsToUpdate.length === 0) {
      logDebug(`üéâ –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —ç—Ç–æ–º –¥–∏–∞–ª–æ–≥–µ —É–∂–µ –ø—Ä–æ—á–∏—Ç–∞–Ω—ã!`);
      return;
    }

    // üîß –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ –æ–¥–Ω–æ–º—É
    let updatedCount = 0;
    for (const { ref, currentSeenBy, docId } of docsToUpdate) {
      const newSeenBy = [...currentSeenBy, currentUser.uid];
      logDebug(`üîß –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ ${docId}: –¥–æ–±–∞–≤–ª—è–µ–º ${currentUser.uid} –≤ seenBy ‚Üí [${newSeenBy.join(', ')}]`);

      try {
        await updateDoc(ref, {
          seenBy: newSeenBy
        });
        updatedCount++;
        logDebug(`‚úÖ –£—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω –¥–æ–∫—É–º–µ–Ω—Ç ${docId}`);
      } catch (err) {
        logDebug(`üö® –û–®–ò–ë–ö–ê –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞ ${docId}: ${err.message}`);
        console.error(`–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è ${docId}:`, err);
      }
    }

    logDebug(`======== –ü–û–ú–ï–¢–ö–ê –ö–ê–ö –ü–†–û–ß–ò–¢–ê–ù–ù–´–ï: –ó–ê–í–ï–†–®–ï–ù–û ========`);
    logDebug(`üìä –†–µ–∑—É–ª—å—Ç–∞—Ç: ${updatedCount}/${docsToUpdate.length} —Å–æ–æ–±—â–µ–Ω–∏–π –æ–±–Ω–æ–≤–ª–µ–Ω–æ`);

  } catch (e) {
    logDebug(`üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ getDocs(): ${e.message}`);
    console.error('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ markMessagesAsRead:', e);
    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –æ—Ç–º–µ—Ç–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å.');
  }
}

    async function sendMessage() {
      const input = document.getElementById('message-input');
      const text = input.value.trim();
      if (!text || !otherUser || otherUser.id === currentUser.uid) return;

      const [id1, id2] = [currentUser.uid, otherUser.id].sort();
      const userPair = `${id1}_${id2}`;

      const messageData = {
        from: currentUser.uid,
        to: otherUser.id,
        text,
        timestamp: Date.now(),
        participants: [currentUser.uid, otherUser.id].sort(),
        userPair: userPair,
        seenBy: [currentUser.uid] // ‚úÖ –°–∞–º –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å —Å—Ä–∞–∑—É –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–≤—à–∏–π
      };

      logDebug(`üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è: "${text}" | —É—á–∞—Å—Ç–Ω–∏–∫–∏: [${messageData.participants.join(', ')}] | seenBy: [${messageData.seenBy.join(', ')}]`);

      try {
        const docRef = await addDoc(collection(db, 'messages'), messageData);
        logDebug(`‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ. ID: ${docRef.id}`);
        input.value = '';
      } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', e);
        logDebug(`üö® –û–®–ò–ë–ö–ê –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è: ${e.message}`);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞.');
      }
    }

    document.getElementById('send-message-btn').addEventListener('click', sendMessage);
    document.getElementById('message-input').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });

    window.addEventListener('load', () => {
      logDebug('üåê –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ñ–¥—ë–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...');
      onHashChange();
    });

    window.addEventListener('hashchange', onHashChange);

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        logDebug(`üîë –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω: ${user.uid}`);
        const userDoc = await getDoc(doc(db, 'users', user.uid));
        if (userDoc.exists()) {
          currentUser = { uid: user.uid, ...userDoc.data() };
          logDebug(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${currentUser.displayName || currentUser.email}`);
          showDebugPanel(); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å –æ—Ç–ª–∞–¥–∫–∏ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
          onHashChange();
        } else {
          logDebug(`‚ùå –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ 'users' –Ω–µ –Ω–∞–π–¥–µ–Ω: ${user.uid}`);
          alert('–ü—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –∑–∞–Ω–æ–≤–æ.');
          window.location.href = './index.html';
        }
      } else {
        logDebug('üîì –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω. –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ index.html');
        window.location.href = './index.html';
      }
    });

  </script>
</body>
</html>