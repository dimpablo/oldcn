<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ß–∞—Ç</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', sans-serif;
      background: #f0f2f5;
      color: #333;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    #chat-header {
      background: #00838f;
      color: white;
      padding: 15px;
      text-align: center;
    }
    #messages-list {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .msg-bubble {
      max-width: 70%;
      padding: 10px 14px;
      border-radius: 18px;
      margin: 4px 0;
      word-wrap: break-word;
    }
    .msg-from-me {
      background: #00838f;
      color: white;
      align-self: flex-end;
    }
    .msg-from-them {
      background: #e0e0e0;
      color: black;
      align-self: flex-start;
    }
    #chat-controls {
      display: flex;
      padding: 10px;
      gap: 10px;
      background: white;
      border-top: 1px solid #ddd;
    }
    #message-input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
    }
    #send-message-btn {
      padding: 10px 16px;
      background: #00838f;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    #send-message-btn:hover {
      background: #006064;
    }
  </style>
</head>
<body>

  <div id="chat-header">
    <h3 id="chat-name">–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞</h3>
  </div>

  <div id="messages-list"></div>

  <div id="chat-controls">
    <input type="text" id="message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." />
    <button id="send-message-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js';
    import {
      getFirestore,
      collection,
      query,
      where,
      onSnapshot,
      addDoc,
      doc,
      getDoc,
      updateDoc,
      arrayUnion,
      getDocs,
      runTransaction
    } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBvyxPtx5PICYk60HUCERw5Cxh1TyCcZCY",
      authDomain: "antient-9bff0.firebaseapp.com",
      projectId: "antient-9bff0",
      storageBucket: "antient-9bff0.firebasestorage.app",
      messagingSenderId: "311792589414",
      appId: "1:311792589414:web:5fff3154735007c2006ba7",
      measurementId: "G-W4ZQXWRTKK"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;
    let otherUser = null;

    function getOtherUserIdFromHash() {
      const match = window.location.hash.match(/^#chat\/([^\/]+)$/);
      return match ? match[1] : null;
    }

    function onHashChange() {
      console.log("[onHashChange] –í—ã–∑–≤–∞–Ω–æ");
      const otherUserId = getOtherUserIdFromHash();
      if (!otherUserId) {
        document.getElementById('chat-name').textContent = "–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞";
        document.getElementById('messages-list').innerHTML = '';
        return;
      }

      if (!currentUser) {
        console.log("[onHashChange] currentUser –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω, –∂–¥—ë–º...");
        return;
      }

      console.log(`[onHashChange] –ó–∞–≥—Ä—É–∂–∞–µ–º —á–∞—Ç —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º: ${otherUserId}`);
      loadChatAndStartListening(otherUserId);
    }

    async function loadChatAndStartListening(otherUserId) {
      console.log(`[loadChatAndStartListening] –ù–∞—á–∞–ª–æ –¥–ª—è ${otherUserId}`);
      try {
        console.log(`[loadChatAndStartListening] –ó–∞–ø—Ä–æ—Å –ø—Ä–æ—Ñ–∏–ª—è: ${otherUserId}`);
        const userRef = doc(db, 'users', otherUserId);
        const userSnap = await getDoc(userRef);

        if (userSnap.exists()) {
          otherUser = { id: userSnap.id, ...userSnap.data() };
          document.getElementById('chat-name').textContent = otherUser.displayName || otherUser.email || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π';
          console.log(`[loadChatAndStartListening] –ü—Ä–æ—Ñ–∏–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω: ${otherUser.displayName || otherUser.email}`);
        } else {
          document.getElementById('chat-name').textContent = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω";
          console.warn(`[loadChatAndStartListening] –ü—Ä–æ—Ñ–∏–ª—å ${otherUserId} –Ω–µ –Ω–∞–π–¥–µ–Ω`);
          return;
        }

        startListeningToMessages(otherUserId);
        markMessagesAsRead(otherUserId);
        runDiagnostics(otherUserId); // ‚úÖ –ó–∞–ø—É—Å–∫ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
      } catch (e) {
        console.error("[loadChatAndStartListening] –û—à–∏–±–∫–∞:", e);
        document.getElementById('chat-name').textContent = "–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è";
      }
    }

    function startListeningToMessages(otherUserId) {
      console.log(`[startListeningToMessages] –ù–∞—á–∞–ª–æ –¥–ª—è ${otherUserId}`);
      if (!currentUser) {
        console.error("[startListeningToMessages] currentUser is null!");
        return;
      }

      const chatQuery = query(
        collection(db, 'messages'),
        where('participants', 'array-contains', currentUser.uid)
      );

      console.log(`[startListeningToMessages] –ó–∞–ø—Ä–æ—Å —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è ${currentUser.uid}`);

      onSnapshot(chatQuery, (snapshot) => {
        console.log(`[onSnapshot] –ü–æ–ª—É—á–µ–Ω–æ ${snapshot.size} —Å–æ–æ–±—â–µ–Ω–∏–π`);
        const messages = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          if (
            data.participants.includes(currentUser.uid) &&
            data.participants.includes(otherUserId)
          ) {
            messages.push({ id: doc.id, ...data });
          }
        });

        messages.sort((a, b) => a.timestamp - b.timestamp);
        renderMessages(messages);
      }, (error) => {
        console.error("[onSnapshot] –û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏:", error);
      });
    }

    function renderMessages(msgs) {
      const list = document.getElementById('messages-list');
      list.innerHTML = '';
      msgs.forEach(msg => {
        const fromMe = msg.from === currentUser.uid;
        const div = document.createElement('div');
        div.className = 'msg-bubble ' + (fromMe ? 'msg-from-me' : 'msg-from-them');
        div.innerHTML = `
          <div>${msg.text}</div>
          <div style="font-size:11px;opacity:0.7;margin-top:4px;">
            ${new Date(msg.timestamp).toLocaleTimeString()}
          </div>
        `;
        list.appendChild(div);
      });
      list.scrollTop = list.scrollHeight;
      console.log(`[renderMessages] –û—Ç—Ä–µ–Ω–¥–µ—Ä–µ–Ω–æ ${msgs.length} —Å–æ–æ–±—â–µ–Ω–∏–π`);
    }

    async function markMessagesAsRead(otherUserId) {
      console.log(`[markMessagesAsRead] –ù–∞—á–∞–ª–æ –¥–ª—è ${otherUserId}`);
      if (!currentUser) {
        console.error("[markMessagesAsRead] currentUser is null!");
        return;
      }

      const q = query(
        collection(db, 'messages'),
        where('participants', 'array-contains', currentUser.uid)
      );

      console.log(`[markMessagesAsRead] –ó–∞–ø—Ä–æ—Å –∫ Firestore –¥–ª—è ${currentUser.uid}`);

      try {
        const snapshot = await getDocs(q);
        console.log(`[markMessagesAsRead] –ù–∞–π–¥–µ–Ω–æ ${snapshot.size} –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤`);

        for (const doc of snapshot.docs) {
          const data = doc.data();
          if (
            data.participants.includes(currentUser.uid) &&
            data.participants.includes(otherUserId) &&
            (!data.seenBy || !data.seenBy.includes(currentUser.uid))
          ) {
            console.log(`[markMessagesAsRead] –û–±–Ω–æ–≤–ª—è–µ–º seenBy –¥–ª—è ${doc.id}`);
            try {
              await updateDoc(doc.ref, {
                seenBy: arrayUnion(currentUser.uid)
              });
              console.log(`[markMessagesAsRead] –£—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª—ë–Ω seenBy –≤ ${doc.id}`);
            } catch (err) {
              console.error(`[markMessagesAsRead] –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è ${doc.id}:`, err);
            }
          }
        }

        console.log("[markMessagesAsRead] –ó–∞–≤–µ—Ä—à–µ–Ω–æ");
      } catch (e) {
        console.error("[markMessagesAsRead] –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:", e);
      }
    }

    // ‚úÖ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–∞–≤–∏–ª Firestore
    async function runDiagnostics(otherUserId) {
      console.log('%cüîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ Firestore create rules', 'font-weight: bold; color: #0066cc; font-size: 14px;');

      if (!currentUser || !otherUserId) {
        console.warn('‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏');
        return;
      }

      // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
      const [id1, id2] = [currentUser.uid, otherUserId].sort();
      const userPair = `${id1}_${id2}`;
      const messageData = {
        from: currentUser.uid,
        to: otherUserId,
        text: "Test message",
        timestamp: Date.now(),
        participants: [currentUser.uid, otherUserId],
        userPair: userPair,
        seenBy: [currentUser.uid]
      };

      console.log('üì§ –î–∞–Ω–Ω—ã–µ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è:', messageData);

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ 1: participants.size == 2
      if (messageData.participants.length !== 2) {
        console.error('‚ùå participants.size != 2 ‚Üí –±—É–¥–µ—Ç –æ—à–∏–±–∫–∞ –≤ –ø—Ä–∞–≤–∏–ª–∞—Ö');
      } else {
        console.log('‚úÖ participants.size == 2');
      }

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ 2: participants.hasAll([from, to])
      const hasAllParticipants = [currentUser.uid, otherUserId].every(id => messageData.participants.includes(id));
      if (!hasAllParticipants) {
        console.error('‚ùå participants –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–±–æ–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π');
      } else {
        console.log('‚úÖ participants —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–±–æ–∏—Ö');
      }

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ 3: userPair –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω
      const expectedUserPair = [currentUser.uid, otherUserId].sort().join('_');
      if (messageData.userPair !== expectedUserPair) {
        console.error(`‚ùå userPair –Ω–µ–≤–µ—Ä–Ω—ã–π: "${messageData.userPair}" ‚â† "${expectedUserPair}"`);
      } else {
        console.log('‚úÖ userPair –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω');
      }

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ 4: seenBy
      if (!Array.isArray(messageData.seenBy)) {
        console.error('‚ùå seenBy –Ω–µ –º–∞—Å—Å–∏–≤');
      } else if (messageData.seenBy.length !== 1) {
        console.error(`‚ùå seenBy.size != 1 ‚Üí ${messageData.seenBy.length}`);
      } else if (!messageData.seenBy.includes(currentUser.uid)) {
        console.error('‚ùå seenBy –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
      } else {
        console.log('‚úÖ seenBy –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω');
      }

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ 5: to != from
      if (messageData.to === messageData.from) {
        console.error('‚ùå to == from ‚Üí –∑–∞–ø—Ä–µ—â–µ–Ω–æ –ø—Ä–∞–≤–∏–ª–∞–º–∏');
      } else {
        console.log('‚úÖ to != from');
      }

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ 6: —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö
      if (typeof messageData.from !== 'string') console.warn('‚ö†Ô∏è from –Ω–µ —Å—Ç—Ä–æ–∫–∞');
      if (typeof messageData.to !== 'string') console.warn('‚ö†Ô∏è to –Ω–µ —Å—Ç—Ä–æ–∫–∞');
      if (typeof messageData.userPair !== 'string') console.warn('‚ö†Ô∏è userPair –Ω–µ —Å—Ç—Ä–æ–∫–∞');

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ 7: –º–æ–∂–Ω–æ –ª–∏ –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Å–≤–æ–∏ –∂–µ –¥–∞–Ω–Ω—ã–µ (–¥–ª—è —Ç–µ—Å—Ç–∞ –¥–æ—Å—Ç—É–ø–∞)
      console.log('üì° –¢–µ—Å—Ç–∏—Ä—É–µ–º –¥–æ—Å—Ç—É–ø –∫ —Å–æ–∑–¥–∞–Ω–∏—é –¥–æ–∫—É–º–µ–Ω—Ç–∞...');

      const testRef = doc(collection(db, 'messages'));

      try {
        await runTransaction(db, async (t) => {
          await t.set(testRef, messageData);
          console.log('%cüéâ –£–°–ü–ï–•: –í—ã –º–æ–∂–µ—Ç–µ —Å–æ–∑–¥–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ!', 'color: green; font-weight: bold;');
          await t.delete(testRef); // —É–¥–∞–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç
        });
      } catch (e) {
        if (e.code === 'permission-denied') {
          console.error('‚ùå –û–®–ò–ë–ö–ê –ü–†–ê–í: Missing or insufficient permissions');
          console.info('üí° –í–µ—Ä–æ—è—Ç–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞: –ø—Ä–∞–≤–∏–ª–æ create –∏—Å–ø–æ–ª—å–∑—É–µ—Ç .sort() –∏–ª–∏ –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏');
        } else {
          console.error('‚ùå –û—à–∏–±–∫–∞:', e);
        }
      }
    }

    async function sendMessage() {
      console.log("[sendMessage] –í—ã–∑–≤–∞–Ω–æ");
      const input = document.getElementById('message-input');
      const text = input.value.trim();
      console.log(`[sendMessage] –¢–µ–∫—Å—Ç: "${text}"`);

      if (!text) {
        console.warn("[sendMessage] –ü—É—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ");
        return;
      }
      if (!otherUser) {
        console.warn("[sendMessage] otherUser –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω");
        alert("–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞");
        return;
      }
      if (!currentUser) {
        console.warn("[sendMessage] currentUser –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω");
        alert("–û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω");
        return;
      }

      const userPair = [currentUser.uid, otherUser.id].sort().join('_');

      const messageData = {
        from: currentUser.uid,
        to: otherUser.id,
        text: text,
        timestamp: Date.now(),
        participants: [currentUser.uid, otherUser.id],
        userPair: userPair,
        seenBy: [currentUser.uid]
      };

      console.log("[sendMessage] –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö:", messageData);

      try {
        const docRef = await addDoc(collection(db, 'messages'), messageData);
        console.log(`[sendMessage] –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ. ID: ${docRef.id}`);
        input.value = '';
      } catch (e) {
        console.error("[sendMessage] –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:", e);
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: " + e.message);
      }
    }

    document.getElementById('send-message-btn').addEventListener('click', () => {
      console.log("[EventListener] –ö–Ω–æ–ø–∫–∞ '–û—Ç–ø—Ä–∞–≤–∏—Ç—å' –Ω–∞–∂–∞—Ç–∞");
      sendMessage();
    });
    document.getElementById('message-input').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        console.log("[EventListener] Enter –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞");
        sendMessage();
      }
    });

    window.addEventListener('load', () => {
      console.log('[EventListener] –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ñ–¥—ë–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...');
      onHashChange();
    });
    window.addEventListener('hashchange', onHashChange);

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        console.log(`[onAuthStateChanged] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω: ${user.uid}`);
        const userDoc = await getDoc(doc(db, 'users', user.uid));
        if (userDoc.exists()) {
          currentUser = { uid: user.uid, ...userDoc.data() };
          console.log(`[onAuthStateChanged] –ü—Ä–æ—Ñ–∏–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω: ${currentUser.displayName || currentUser.email}`);
          onHashChange();
        } else {
          console.warn(`[onAuthStateChanged] –ü—Ä–æ—Ñ–∏–ª—å ${user.uid} –Ω–µ –Ω–∞–π–¥–µ–Ω`);
          alert("–ü—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω");
          window.location.href = './index.html';
        }
      } else {
        console.log('[onAuthStateChanged] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω. –†–µ–¥–∏—Ä–µ–∫—Ç.');
        window.location.href = './index.html';
      }
    });
  </script>
</body>
</html>