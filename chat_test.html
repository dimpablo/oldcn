<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Чат с заданиями</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', sans-serif;
      background: #f0f2f5;
      color: #333;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    #chat-header {
      background: #00838f;
      color: white;
      padding: 15px;
      text-align: center;
    }
    #messages-list {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .msg-bubble {
      max-width: 70%;
      padding: 10px 14px;
      border-radius: 18px;
      margin: 4px 0;
      word-wrap: break-word;
    }
    .msg-from-me {
      background: #00838f;
      color: white;
      align-self: flex-end;
    }
    .msg-from-them {
      background: #e0e0e0;
      color: black;
      align-self: flex-start;
    }
    #chat-controls {
      display: flex;
      padding: 10px;
      gap: 10px;
      background: white;
      border-top: 1px solid #ddd;
    }
    #message-input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
    }
    #send-message-btn {
      padding: 10px 16px;
      background: #00838f;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    #send-message-btn:hover {
      background: #006064;
    }
  </style>
</head>
<body>

  <div id="chat-header">
    <h3 id="chat-name">Тест интерактивных заданий</h3>
  </div>

  <div id="messages-list"></div>

  <div id="chat-controls">
    <input type="text" id="message-input" placeholder="Введите сообщение... Пример: ’‘’‘ [original]->[translation]: {其雨}->{Будет дождь}; [tokens]: {будет, дождь, пошёл} ’‘’‘" />
    <button id="send-message-btn">Отправить</button>
  </div>

  <script>
    // Парсер структурированных сообщений
    function parseStructuredMessage(text) {
      const pattern = /’‘’‘([\s\S]*?)’‘’‘/g;
      const parts = [];
      let lastIndex = 0;
      let match;

      while ((match = pattern.exec(text)) !== null) {
        // Текст до блока
        if (match.index > lastIndex) {
          parts.push({ type: 'text', content: text.slice(lastIndex, match.index) });
        }

        // Обработка блока
        const blockContent = match[1].trim();
        const blockData = parseBlock(blockContent);
        if (blockData) {
          parts.push({ type: 'block', content: blockData });
        } else {
          // Если парсинг провалился — показываем как есть
          parts.push({ type: 'text', content: match[0] });
        }

        lastIndex = pattern.lastIndex;
      }

      // Остаток текста
      if (lastIndex < text.length) {
        parts.push({ type: 'text', content: text.slice(lastIndex) });
      }

      return parts;
    }

    function parseBlock(content) {
      const result = {};
      // Поддерживаем любые символы внутри [...]
      const regex = /\[([^\]]+)\]\s*:\s*\{([^}]*)\}/g;
      let match;

      while ((match = regex.exec(content)) !== null) {
        const key = match[1].trim(); // например: "original->translation"
        let value = match[2].trim();

        // Обработка стрелок: {其雨}->{Будет дождь}
        if (value.includes('}->{')) {
          const parts = value.split('}->{');
          if (parts.length === 2) {
            const from = parts[0].replace(/{/, '').trim();
            const to = parts[1].replace(/}$/, '').trim();
            result[key] = { from, to };
          }
        }
        // Обработка списков: {токен1, токен2, ...}
        else if (value.includes(',')) {
          result[key] = value.split(',').map(s => s.trim());
        }
        // Одиночное значение
        else {
          result[key] = value;
        }
      }

      return Object.keys(result).length ? result : null;
    }

    function renderMessages(msgs) {
      const list = document.getElementById('messages-list');
      list.innerHTML = '';
      
      msgs.forEach(msg => {
        const fromMe = true; // Для теста все сообщения от меня
        const wrapper = document.createElement('div');
        wrapper.className = 'msg-bubble ' + (fromMe ? 'msg-from-me' : 'msg-from-them');

        // Парсим сообщение
        const parsedParts = parseStructuredMessage(msg.text);

        parsedParts.forEach(part => {
          if (part.type === 'text') {
            const textNode = document.createElement('div');
            textNode.textContent = part.content;
            wrapper.appendChild(textNode);
          } else if (part.type === 'block') {
            const block = part.content;

            // --- Интерактивное задание: [original]->[translation] + [tokens] ---
            if (block["original->translation"] && block.tokens) {
              const tr = block["original->translation"];
              const tokens = Array.isArray(block.tokens) ? block.tokens : [];

              const taskCard = document.createElement('div');
              taskCard.style.cssText = `
                background: white;
                border: 1px solid #ccc;
                border-radius: 12px;
                padding: 14px;
                margin: 8px 0;
                font-family: sans-serif;
                max-width: 300px;
              `;

              taskCard.innerHTML = `
                <div style="font-size:16px; font-weight:bold; color:#333;">${tr.from}</div>
                <div style="margin: 10px 0; font-size:12px; color:#555;">
                  Перетащи слова в правильном порядке:
                </div>

                <!-- Контейнер с доступными словами -->
                <div class="word-bank" style="display:flex; flex-wrap:wrap; gap:6px; margin-bottom:10px; min-height:40px; padding:5px; background:#f9f9f9; border-radius:6px;"></div>

                <!-- Ответ пользователя -->
                <div class="user-answer" style="display:flex; flex-wrap:wrap; gap:6px; margin-bottom:10px; min-height:40px; padding:8px; border:1px dashed #ccc; border-radius:6px; background:#f0faf8;"></div>

                <!-- Кнопка проверки -->
                <button class="check-btn" style="
                  padding:6px 12px;
                  background:#00838f;
                  color:white;
                  border:none;
                  border-radius:6px;
                  font-size:12px;
                  cursor:pointer;
                ">Проверить</button>

                <!-- Результат -->
                <div class="result-message" style="margin-top:8px; font-size:12px; min-height:16px;"></div>
              `;

              wrapper.appendChild(taskCard);

              // === Элементы интерфейса ===
              const wordBank = taskCard.querySelector('.word-bank');
              const userAnswer = taskCard.querySelector('.user-answer');
              const checkBtn = taskCard.querySelector('.check-btn');
              const resultMsg = taskCard.querySelector('.result-message');

              let currentAnswer = [];

              // --- Заполняем банк слов ---
              const shuffledTokens = [...tokens].sort(() => Math.random() - 0.5);
              shuffledTokens.forEach(word => {
                const btn = document.createElement('div');
                btn.className = 'word-token';
                btn.textContent = word;
                btn.style.cssText = `
                  padding:6px 10px;
                  background:#fff;
                  border:1px solid #ddd;
                  border-radius:12px;
                  font-size:12px;
                  cursor:pointer;
                  transition: all 0.2s;
                `;
                btn.addEventListener('click', () => {
                  btn.remove();
                  currentAnswer.push(word);
                  renderUserAnswer();
                });
                wordBank.appendChild(btn);
              });

              function renderUserAnswer() {
                userAnswer.innerHTML = '';
                currentAnswer.forEach((word, index) => {
                  const span = document.createElement('span');
                  span.textContent = word;
                  span.style.cssText = `
                    padding:6px 10px;
                    background:#00838f;
                    color:white;
                    border-radius:12px;
                    font-size:12px;
                    position:relative;
                    cursor:pointer;
                  `;
                  // Крестик удаления
                  const remove = document.createElement('span');
                  remove.textContent = ' ×';
                  remove.style.marginLeft = '4px';
                  remove.style.fontWeight = 'bold';
                  remove.onclick = (e) => {
                    e.stopPropagation();
                    currentAnswer.splice(index, 1);
                    renderUserAnswer();
                    // Вернём слово в банк
                    const btn = document.createElement('div');
                    btn.className = 'word-token';
                    btn.textContent = word;
                    btn.style.cssText = `
                      padding:6px 10px;
                      background:#fff;
                      border:1px solid #ddd;
                      border-radius:12px;
                      font-size:12px;
                      cursor:pointer;
                    `;
                    btn.onclick = () => {
                      btn.remove();
                      currentAnswer.push(word);
                      renderUserAnswer();
                    };
                    wordBank.appendChild(btn);
                  };
                  span.appendChild(remove);
                  userAnswer.appendChild(span);
                });
              }

              // --- Проверка ответа ---
              checkBtn.addEventListener('click', () => {
                const userText = currentAnswer.join(' ').trim().toLowerCase();
                const correctText = tr.to.toLowerCase();

                if (userText === correctText) {
                  resultMsg.innerHTML = '✅ <b>Верно!</b>';
                  resultMsg.style.color = '#2ecc71';
                  checkBtn.disabled = true;
                  checkBtn.style.opacity = '0.6';
                } else {
                  resultMsg.innerHTML = '❌ Неверно. Попробуй ещё.';
                  resultMsg.style.color = '#e74c3c';
                }
              });
            }
            // --- [char]: {"雨"} ---
            else if (block.char) {
              const charBox = document.createElement('div');
              charBox.style.cssText = `
                font-size: 48px;
                text-align: center;
                margin: 10px 0;
                padding: 10px;
                background: #f9f9f9;
                border: 1px solid #ddd;
                border-radius: 8px;
                font-family: "Hiragino", serif;
              `;
              charBox.textContent = Array.isArray(block.char) ? block.char[0] : block.char;
              wrapper.appendChild(charBox);
            }
            // Любой другой тип — можно расширять
            else {
              const pre = document.createElement('pre');
              pre.style.cssText = "background:#f0f0f0; padding:8px; border-radius:6px; font-size:12px;";
              pre.textContent = JSON.stringify(block, null, 2);
              wrapper.appendChild(pre);
            }
          }
        });

        // Время
        const timeDiv = document.createElement('div');
        timeDiv.style.cssText = "font-size:11px; opacity:0.7; margin-top:6px; text-align:right";
        timeDiv.textContent = new Date().toLocaleTimeString();
        wrapper.appendChild(timeDiv);

        list.appendChild(wrapper);
      });

      list.scrollTop = list.scrollHeight;
    }

    function sendMessage() {
      const input = document.getElementById('message-input');
      const text = input.value.trim();

      if (!text) return;

      const message = {
        text: text,
        timestamp: Date.now()
      };

      // Для теста просто добавляем в список
      const messages = JSON.parse(localStorage.getItem('testMessages') || '[]');
      messages.push(message);
      localStorage.setItem('testMessages', JSON.stringify(messages));

      input.value = '';
      loadMessages();
    }

    function loadMessages() {
      const messages = JSON.parse(localStorage.getItem('testMessages') || '[]');
      renderMessages(messages);
    }

    document.getElementById('send-message-btn').addEventListener('click', sendMessage);
    document.getElementById('message-input').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        sendMessage();
      }
    });

    // Загружаем сообщения при старте
    window.addEventListener('load', loadMessages);

    // Добавим тестовое сообщение если список пуст
    window.addEventListener('load', () => {
      const messages = JSON.parse(localStorage.getItem('testMessages') || '[]');
      if (messages.length === 0) {
        const testMessage = {
          text: 'Попробуй это задание: ’‘’‘ [original]->[translation]: {其雨}->{Будет дождь}; [tokens]: {будет, дождь, пошёл} ’‘’‘',
          timestamp: Date.now()
        };
        messages.push(testMessage);
        localStorage.setItem('testMessages', JSON.stringify(messages));
        loadMessages();
      }
    });
  </script>
</body>
</html>