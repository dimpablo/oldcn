<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Синтаксис — Древний Китай</title>
    <script src="tasks.js"></script>
    <script src="../dictionary.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            touch-action: manipulation;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: #f8f9fa;
            color: #333;
            height: 100vh;
            overflow-y: auto;
        }

        h1 {
            text-align: center;
            color: #1a5fb4;
            font-size: 1.4em;
            margin: 10px 0;
            padding: 8px 0;
            border-bottom: 2px solid #e0e0e0;
        }

        #sentence-container {
            width: 100%;
            padding: 10px 15px;
            overflow-x: auto;
            white-space: nowrap;
            font-size: 1.6em;
            font-family: 'Noto Serif CJK SC', serif;
            color: #154080;
            background: #e6f2ff;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin: 10px 0;
        }

        .char {
            display: inline-block;
            padding: 0 4px;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 4px;
        }

        .char:hover {
            background: #d4e8ff;
            transform: scale(1.1);
        }

        #char-info {
            margin: 10px 15px;
            padding: 12px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
            display: none;
        }

        .info-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 8px 12px;
        }

        .info-label {
            font-weight: bold;
            color: #1a5fb4;
            text-align: right;
            padding-right: 8px;
        }

        .info-value {
            color: #333;
        }

        .lesson-link {
            color: #1976d2;
            text-decoration: none;
            font-weight: bold;
        }

        .lesson-link:hover {
            text-decoration: underline;
        }

        #workspace {
            position: relative;
            width: 100%;
            min-height: 200px;
            margin: 20px 0;
            padding: 20px 15px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .word {
            position: relative;
            display: inline-block;
            margin: 0 8px;
            padding: 6px 10px;
            background: #e6f2ff;
            border: 1px solid #9cc8ff;
            border-radius: 6px;
            font-size: 1.2em;
            font-family: 'Noto Serif CJK SC', serif;
            user-select: none;
            cursor: pointer;
            z-index: 2;
        }

        .word.selected {
            border-color: #ff9800;
            background: #fff3e0;
            box-shadow: 0 0 0 3px #ffe0b2;
            z-index: 10;
        }

        /* Стрелки между словами */
        .arrow {
            --level: 1;
            --color: #27ae60;
            position: absolute;
            left: 0;
            width: 100%;
            height: 40px;
            top: calc(var(--level) * -40px);
            pointer-events: none;
            z-index: 1;
        }

        .arrow::before {
            content: '';
            position: absolute;
            left: var(--start-x);
            right: var(--end-x);
            top: 20px;
            height: 2px;
            background: var(--color);
            border-radius: 2px;
            transform: translateY(-50%);
        }

        .arrow::after {
            content: '➤';
            position: absolute;
            right: var(--end-x);
            top: 20px;
            transform: translateY(-50%) translateX(50%);
            color: var(--color);
            font-size: 18px;
            font-weight: bold;
        }

        .syntax-label {
            position: absolute;
            font-size: 0.8em;
            color: #1a5fb4;
            background: rgba(233, 245, 255, 0.9);
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid #b3d9ff;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            pointer-events: none;
            z-index: 5;
            white-space: nowrap;
            font-weight: 600;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin: 10px 15px;
        }

        button {
            flex: 1;
            padding: 12px 0;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            background: #e74c3c;
            color: white;
            transition: background 0.2s;
        }

        button:active {
            background: #c0392b;
        }

        button.next {
            background: #27ae60;
        }

        button.next:active {
            background: #219653;
        }

        #feedback {
            height: 40px;
            line-height: 40px;
            text-align: center;
            font-weight: bold;
            margin: 10px 15px;
            border-radius: 8px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .success {
            background: #d4edda;
            color: #155724;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
        }

        .highlight {
            animation: highlight-red 0.5s ease-in-out 2;
        }

        @keyframes highlight-red {
            0% { background-color: #e6f2ff; }
            50% { background-color: #f8d7da; }
            100% { background-color: #e6f2ff; }
        }
    </style>
</head>
<body>
    <h1>Синтаксические связи</h1>

    <div id="sentence-container" id="sentence"></div>

    <div id="char-info">
        <div class="info-grid">
            <div class="info-label">Иероглиф:</div>
            <div class="info-value" id="info-char"></div>

            <div class="info-label">Транскрипция:</div>
            <div class="info-value" id="info-pinyin"></div>

            <div class="info-label">Значение:</div>
            <div class="info-value" id="info-meaning"></div>

            <div class="info-label">Урок:</div>
            <div class="info-value" id="info-lesson"></div>
        </div>
    </div>

    <div id="workspace"></div>

    <div id="feedback"></div>

    <div class="controls">
        <button id="resetBtn">Сбросить связи</button>
        <button id="nextBtn" class="next">Следующее задание</button>
    </div>

    <script>
        let currentTaskIndex = 0;
        let syntaxData = null;
        let selectedWord = null;
        let drawnLinks = [];
        let audioCache = new Map();
        let currentAudioPlayers = [];
        let taskOrder = [];

        const sentenceEl = document.getElementById('sentence');
        const workspace = document.getElementById('workspace');
        const charInfoEl = document.getElementById('char-info');
        const feedbackEl = document.getElementById('feedback');
        const resetBtn = document.getElementById('resetBtn');
        const nextBtn = document.getElementById('nextBtn');

        const infoChar = document.getElementById('info-char');
        const infoPinyin = document.getElementById('info-pinyin');
        const infoMeaning = document.getElementById('info-meaning');
        const infoLesson = document.getElementById('info-lesson');

        if (typeof charData === 'undefined') {
            console.error('❌ Не загружен dictionary.js');
            alert('Ошибка: не удалось загрузить словарь иероглифов.');
        }

        function createRandomTaskOrder() {
            taskOrder = [...Array(tasks.length).keys()];
            for (let i = taskOrder.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [taskOrder[i], taskOrder[j]] = [taskOrder[j], taskOrder[i]];
            }
        }

        function loadTask(index) {
            if (index >= tasks.length) {
                sentenceEl.innerHTML = '<div style="text-align: center; padding: 10px;">Все задания завершены!</div>';
                charInfoEl.style.display = 'none';
                return;
            }

            // Очистка
            drawnLinks = [];
            selectedWord = null;
            sentenceEl.innerHTML = '';
            workspace.innerHTML = '';

            const taskIndex = taskOrder[index];
            syntaxData = tasks[taskIndex];
            document.title = `Задание ${index + 1} — Синтаксис`;

            // Отображаем предложение как строку
            syntaxData.sentence.split('').forEach(char => {
                const span = document.createElement('span');
                span.className = 'char';
                span.textContent = char;
                span.dataset.char = char;
                span.addEventListener('click', () => showCharInfo(char));
                sentenceEl.appendChild(span);
            });

            // Размещаем слова
            syntaxData.words.forEach(word => {
                const wordEl = document.createElement('span');
                wordEl.className = 'word';
                wordEl.textContent = word;
                wordEl.dataset.word = word;
                wordEl.addEventListener('click', () => handleWordClick(wordEl));
                workspace.appendChild(wordEl);
            });

            redrawArrows();
        }

        function showCharInfo(char) {
            if (typeof charData === 'undefined') return;
            const data = charData[char];
            if (data) {
                infoChar.textContent = char;
                infoPinyin.textContent = data.pinyin || 'неизвестно';
                infoMeaning.textContent = data.meaning || 'значение не найдено';
                if (data.lesson) {
                    const lessonLink = document.createElement('a');
                    lessonLink.href = `../lesson${data.lesson}/theory.html`;
                    lessonLink.textContent = `Урок ${data.lesson}`;
                    lessonLink.className = 'lesson-link';
                    lessonLink.target = '_blank';
                    infoLesson.innerHTML = '';
                    infoLesson.appendChild(lessonLink);
                } else {
                    infoLesson.textContent = 'урок не указан';
                }
                charInfoEl.style.display = 'block';
                playHanziSound(char);
            } else {
                infoChar.textContent = char;
                infoPinyin.textContent = 'неизвестно';
                infoMeaning.textContent = 'не найдено в словаре';
                infoLesson.textContent = '—';
                charInfoEl.style.display = 'block';
            }
        }

        function playHanziSound(char) {
            const data = charData[char];
            if (!data || !data.pinyin) return;
            const audio = getAudioForChar(char);
            if (audio) {
                stopAllAudio();
                const newAudio = new Audio(audio.src);
                currentAudioPlayers.push(newAudio);
                newAudio.play().catch(e => console.error(e));
            }
        }

        function getAudioForChar(char) {
            if (audioCache.has(char)) return audioCache.get(char);
            const data = charData[char];
            if (!data || !data.pinyin) return null;
            let cleanPinyin = data.pinyin.normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/ü/g, 'u').replace(/v/g, 'u');
            let tone = '1';
            if (data.pinyin.includes('ā')) tone = '1';
            else if (data.pinyin.includes('á')) tone = '2';
            else if (data.pinyin.includes('ǎ')) tone = '3';
            else if (data.pinyin.includes('à')) tone = '4';
            const pinyinKey = cleanPinyin + tone;
            const url = `https://data.dong-chinese.com/pinyin/b/${pinyinKey}.mp3`;
            const audio = new Audio(url);
            audioCache.set(char, audio);
            return audio;
        }

        function stopAllAudio() {
            currentAudioPlayers.forEach(audio => {
                audio.pause();
                audio.currentTime = 0;
            });
            currentAudioPlayers = [];
        }

        function handleWordClick(wordEl) {
            const word = wordEl.dataset.word;

            if (!selectedWord) {
                selectedWord = wordEl;
                wordEl.classList.add('selected');
                playWordSounds(word);
            } else {
                if (selectedWord === wordEl) {
                    selectedWord.classList.remove('selected');
                    selectedWord = null;
                    return;
                }

                const fromWord = selectedWord.dataset.word;
                const toWord = word;

                const isDuplicate = drawnLinks.some(link => link.from === fromWord && link.to === toWord);
                if (isDuplicate) {
                    flash('#e74c3c');
                    showFeedback(false, "Эта связь уже существует");
                } else {
                    const isCorrect = syntaxData.links.some(link => link.from === fromWord && link.to === toWord);
                    flash(isCorrect ? '#27ae60' : '#e74c3c');
                    showFeedback(isCorrect, isCorrect ? "✅ Правильно!" : "❌ Неверно");

                    if (isCorrect) {
                        drawnLinks.push({ from: fromWord, to: toWord });
                        redrawArrows();
                    }
                }

                selectedWord.classList.remove('selected');
                selectedWord = null;
            }
        }

        function redrawArrows() {
            // Удаляем старые стрелки и метки
            document.querySelectorAll('.arrow, .syntax-label').forEach(el => el.remove());

            // Группируем связи по уровням
            const levels = new Map();

            drawnLinks.forEach((link, i) => {
                const fromEl = document.querySelector(`.word[data-word="${link.from}"]`);
                const toEl = document.querySelector(`.word[data-word="${link.to}"]`);
                if (!fromEl || !toEl) return;

                const fromRect = fromEl.getBoundingClientRect();
                const toRect = toEl.getBoundingClientRect();
                const workspaceRect = workspace.getBoundingClientRect();

                const left = fromRect.left - workspaceRect.left + fromEl.offsetWidth / 2;
                const right = workspaceRect.right - toRect.right + toEl.offsetWidth / 2;

                const level = levels.get(link.from + '-' + link.to) || 1;

                const arrow = document.createElement('div');
                arrow.className = 'arrow';
                arrow.style.setProperty('--level', level);
                arrow.style.setProperty('--start-x', left + 'px');
                arrow.style.setProperty('--end-x', right + 'px');
                workspace.appendChild(arrow);

                // Метка
                const roles = syntaxData.links.find(l => l.from === link.from && l.to === link.to);
                if (roles) {
                    const label = document.createElement('div');
                    label.className = 'syntax-label';
                    label.textContent = `${roles.fromRole}→${roles.toRole}`;
                    label.style.left = `${(left + workspaceRect.width - right) / 2}px`;
                    label.style.top = `calc(var(--level) * -40px - 10px)`;
                    workspace.appendChild(label);
                }

                // Увеличиваем уровень для следующей пары
                levels.set(link.from + '-' + link.to, level + 1);
            });
        }

        function checkCompletion() {
            const correctLinks = syntaxData.links.map(link => [link.from, link.to]);
            const drawnSet = drawnLinks.map(link => [link.from, link.to]);
            return correctLinks.every(correctLink => drawnSet.some(drawnLink => drawnLink[0] === correctLink[0] && drawnLink[1] === correctLink[1]));
        }

        function flash(color) {
            document.body.style.backgroundColor = `rgba(${hexToRgb(color)}, 0.18)`;
            setTimeout(() => document.body.style.backgroundColor = '', 300);
        }

        function hexToRgb(hex) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `${r}, ${g}, ${b}`;
        }

        function showFeedback(isCorrect, message) {
            feedbackEl.textContent = message;
            feedbackEl.className = isCorrect ? 'success' : 'error';
            feedbackEl.style.opacity = '1';
            setTimeout(() => feedbackEl.style.opacity = '0', 1500);
        }

        function highlightMissingConnections() {
            workspace.classList.add('highlight');
            setTimeout(() => workspace.classList.remove('highlight'), 1000);
            showFeedback(false, "Не все связи расставлены!");
        }

        resetBtn.addEventListener('click', () => {
            drawnLinks = [];
            selectedWord = null;
            document.querySelectorAll('.word.selected').forEach(el => el.classList.remove('selected'));
            redrawArrows();
        });

        nextBtn.addEventListener('click', () => {
            if (checkCompletion()) {
                currentTaskIndex++;
                if (currentTaskIndex >= tasks.length) {
                    alert("Поздравляем! Все задания завершены!");
                } else {
                    loadTask(currentTaskIndex);
                }
            } else {
                highlightMissingConnections();
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            if (typeof tasks === 'undefined' || !Array.isArray(tasks) || tasks.length === 0) {
                sentenceEl.innerHTML = '<div style="text-align: center; padding: 10px;">Ошибка: Данные не загружены.</div>';
                return;
            }
            createRandomTaskOrder();
            loadTask(currentTaskIndex);
        });

        workspace.addEventListener('click', () => {
            if (charInfoEl.style.display !== 'none') {
                charInfoEl.style.display = 'none';
            }
        });
    </script>
</body>
</html>