<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Таблица ПДСД - Урок 2</title>
    <style>
        * {
            box-sizing: border-box;
            touch-action: manipulation;
        }
        
        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f5f5;
            margin: 10px;
            padding: 0;
            max-width: 100%;
            overflow-x: hidden;
        }
        
        h1 {
            text-align: center;
            color: #1a5fb4;
            font-size: 1.4em;
            margin: 10px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        /* Инструкции — компактный сворачиваемый блок */
        .instructions {
            background: #e6f2ff;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            font-size: 0.9em;
            line-height: 1.5;
            cursor: pointer;
            border: 1px solid #b3d9ff;
            transition: background 0.2s ease;
        }

        .instructions::before {
            content: "▶ Инструкции";
            display: block;
            text-align: center;
            font-size: 0.9em;
            color: #1a5fb4;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .instructions:not(.collapsed)::before {
            content: "▼ Скрыть инструкции";
        }

        .instructions .content {
            display: none;
            opacity: 0;
            transition: opacity 0.1s;
        }

        .instructions:not(.collapsed) .content {
            display: block;
            opacity: 1;
            padding-top: 4px;
            border-top: 1px dashed #b3d9ff;
            margin-top: 6px;
        }

        .distribution-table-container {
            margin: 15px 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        
        .distribution-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .distribution-table th {
            background: #e6f2ff;
            padding: 8px 5px;
            font-size: 0.85em;
            border: 1px solid #ddd;
        }
        
        .distribution-table td {
            height: 40px;
            border: 1px solid #eee;
            text-align: center;
            font-size: 1.1em;
            padding: 5px;
            background: #fafafa;
            font-family: 'Noto Serif CJK SC', 'KaiTi', serif;
            vertical-align: middle;
        }
        
        .distribution-table tr:first-child td {
            background: #f0f8ff;
            font-weight: bold;
        }
        
        .source-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        
        .source-table td {
            padding: 6px 4px;
            border: 1px solid #ddd;
            text-align: center;
            font-size: 1.2em;
            font-family: 'Noto Serif CJK SC', 'KaiTi', serif;
            word-break: keep-all;
            white-space: nowrap;
            height: 40px;
        }
        
        .line-num, .col-num {
            background-color: #f0f4f8;
            color: #1a5fb4;
            font-weight: bold;
            font-size: 0.8em;
            white-space: nowrap;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }
        
        button {
            flex: 1;
            padding: 12px 0;
            background: #1a5fb4;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            touch-action: manipulation;
            box-shadow: 0 2px 5px rgba(26, 95, 180, 0.2);
        }
        
        button:active {
            background: #154a8a;
            transform: translateY(1px);
        }
        
        button.reset {
            background: #e74c3c;
        }
        
        button.check {
            background: #27ae60;
        }
        
        .message {
            text-align: center;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            font-weight: bold;
            display: none;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
        }
        
        .incorrect {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status {
            text-align: center;
            font-size: 0.9em;
            color: #666;
            margin: 5px 0;
        }
        
        @media (max-width: 480px) {
            .source-table td {
                font-size: 1.1em;
                padding: 4px 2px;
            }
            
            .distribution-table td {
                font-size: 1.0em;
                height: 36px;
            }
            
            button {
                padding: 10px 0;
                font-size: 1em;
            }
        }
    </style>
</head>
<body>
    <h1>Таблица ПДСД: Урок 2</h1>
    
    <div class="instructions collapsed">
        <div class="content">
            <h3 style="margin: 0 0 6px; font-size: 1em; color: #1a5fb4;">Как играть</h3>
            <p style="margin: 0 0 8px; font-size: 0.95em;">
                <strong>Цель:</strong> Перенести иероглифы в таблицу, сгруппировав по грамматическим функциям.
            </p>
            <ol style="margin: 0 0 8px; padding-left: 18px; font-size: 0.9em;">
                <li>Нажмите на иероглиф в таблице текста</li>
                <li>Нажмите на ячейку в таблице ПДСД</li>
                <li>Иероглиф добавится в ячейку</li>
                <li>Чтобы вернуть — нажмите на него в таблице</li>
                <li>Нажмите «Проверить»</li>
            </ol>
            <p style="margin: 0; font-size: 0.85em; color: #555; font-style: italic;">
                Подсказка: можно возвращать иероглифы
            </p>
        </div>
    </div>

    <div class="status">Выбрано: <span id="selectedChar">-</span></div>
    
    <div class="distribution-table-container">
        <table class="distribution-table" id="distributionTable">
            <thead>
                <tr>
                    <th>Подлежащее</th>
                    <th>Дополнение</th>
                    <th>Сказуемое</th>
                    <th>Дополнение</th>
                </tr>
            </thead>
            <tbody>
                <!-- Строки будут добавлены через JS -->
            </tbody>
        </table>
    </div>
    
    <div class="source-table-container">
        <table class="source-table" id="sourceTable"></table>
    </div>
    
    <div class="controls">
        <button class="reset" id="resetBtn">Сбросить</button>
        <button class="check" id="checkBtn" disabled>Проверить</button>
    </div>
    
    <div class="message success" id="successMsg">
        Отлично! Вы правильно составили таблицу ПДСД.
    </div>
    
    <div class="message incorrect" id="errorMsg">
        Есть ошибки. Проверьте ячейки и попробуйте снова.
    </div>
    
<script>
    // Текст урока 2 (без пунктуации, как в оригинале)
    const lessonText = [
        "癸卯卜爭貞今歳商受年貞來歳不其",
        "受年癸丑卜㱿貞冓受年貞冓不其受",
        "年癸卯卜亘貞我受黍年癸巳卜㱿貞",
        "我受稻年貞今來歳我不其受年貞戔",
        "受貞甫弗其受黍年",
        "貞肅來牛貞肅弗其來牛貞冓不其來",
        "犬貞今春奚來牛奚不其來牛甲辰卜",
        "㱿貞奚來白馬王占曰吉其來馬丙辰",
        "卜㱿貞今春方其自來"
    ];
    
    // Эталонная таблица ПДСД для проверки
    const referenceTable = [
        ["商", "今歳", "受", "年"],
        ["", "冓", "受", "年"],
        ["我", "", "受", "黍年"],
        ["我", "", "受", "稻年"],
        ["戔受貞甫", "", "弗其受", "黍年"],
        ["肅", "", "來", "牛"],
        ["", "今春", "来", "牛"],
        ["", "奚", "来", "白馬"],
        ["今春方", "", "其自來", ""]
    ];
    
    // Переменные состояния
    let selectedChar = null;
    let charsLeft = 0;
    
    // Инициализация после загрузки DOM
    document.addEventListener('DOMContentLoaded', function() {
        createSourceTable();
        createDistributionTable();
        setupEventListeners();

        // Обработчик клика по инструкциям
        const instructions = document.querySelector('.instructions');
        if (instructions) {
            instructions.addEventListener('click', function() {
                this.classList.toggle('collapsed');
            });
        }
    });
    
    function createSourceTable() {
        const table = document.getElementById('sourceTable');
        table.innerHTML = ''; // Очищаем таблицу
        
        // Заголовок с номерами колонок
        const headerRow = document.createElement('tr');
        const emptyCell = document.createElement('td');
        emptyCell.className = 'line-num';
        headerRow.appendChild(emptyCell);
        
        for (let i = 1; i <= 15; i++) {
            const th = document.createElement('td');
            th.className = 'col-num';
            th.textContent = i;
            headerRow.appendChild(th);
        }
        table.appendChild(headerRow);
        
        // Строки текста
        for (let i = 0; i < lessonText.length; i++) {
            const row = document.createElement('tr');
            
            const lineNumCell = document.createElement('td');
            lineNumCell.className = 'line-num';
            lineNumCell.textContent = i + 1;
            row.appendChild(lineNumCell);
            
            const chars = Array.from(lessonText[i]);
            charsLeft += chars.length;
            
            for (let j = 0; j < 15; j++) {
                const td = document.createElement('td');
                
                if (j < chars.length && chars[j].trim() !== '') {
                    td.textContent = chars[j];
                }
                row.appendChild(td);
            }
            
            table.appendChild(row);
        }
    }
    
    function createDistributionTable() {
        const table = document.getElementById('distributionTable').getElementsByTagName('tbody')[0];
        table.innerHTML = '';
        
        for (let i = 0; i < lessonText.length; i++) {
            const row = document.createElement('tr');
            
            // Создаем 4 столбца для каждой строки (ПДСД)
            for (let j = 0; j < 4; j++) {
                const td = document.createElement('td');
                td.dataset.row = i;
                td.dataset.col = j;
                row.appendChild(td);
            }
            
            table.appendChild(row);
        }
    }
    
    function setupEventListeners() {
        // Обработчик кликов по исходной таблице
        document.querySelectorAll('#sourceTable tr:not(:first-child) td:not(.line-num):not(.col-num)').forEach(cell => {
            cell.addEventListener('click', function() {
                if (this.textContent.trim() !== '') {
                    const rowIdx = this.parentElement.rowIndex - 1;
                    const colIdx = this.cellIndex - 1;
                    
                    selectedChar = {
                        char: this.textContent,
                        cell: this,
                        sourceRow: rowIdx,
                        sourceCol: colIdx
                    };
                    
                    document.getElementById('selectedChar').textContent = this.textContent;
                    
                    document.querySelectorAll('#sourceTable td.selected').forEach(el => {
                        el.classList.remove('selected');
                    });
                    this.classList.add('selected');
                }
            });
        });
        
        // Обработчик кликов по таблице ПДСД
        document.querySelectorAll('#distributionTable td').forEach(cell => {
            cell.addEventListener('click', function() {
                if (selectedChar) {
                    this.textContent += selectedChar.char;
                    
                    if (!this.dataset.sources) {
                        this.dataset.sources = '[]';
                    }
                    const sources = JSON.parse(this.dataset.sources);
                    sources.push({
                        char: selectedChar.char,
                        sourceRow: selectedChar.sourceRow,
                        sourceCol: selectedChar.sourceCol
                    });
                    this.dataset.sources = JSON.stringify(sources);
                    
                    selectedChar.cell.textContent = '';
                    selectedChar.cell.classList.remove('selected');
                    
                    selectedChar = null;
                    document.getElementById('selectedChar').textContent = '-';
                }
                // Возврат иероглифа
                else if (this.textContent.trim() !== '') {
                    if (this.dataset.sources) {
                        const sources = JSON.parse(this.dataset.sources);
                        if (sources.length > 0) {
                            const lastSource = sources.pop();
                            
                            this.textContent = this.textContent.slice(0, -1);
                            this.dataset.sources = JSON.stringify(sources);
                            
                            const sourceRows = document.querySelectorAll('#sourceTable tr');
                            if (sourceRows[lastSource.sourceRow + 1]) {
                                const rowCells = sourceRows[lastSource.sourceRow + 1].querySelectorAll('td');
                                if (rowCells[lastSource.sourceCol + 1]) {
                                    rowCells[lastSource.sourceCol + 1].textContent = lastSource.char;
                                }
                            }
                        }
                    }
                }
            });
        });
        
        // Кнопка сброса
        document.getElementById('resetBtn').addEventListener('click', resetGame);
        
        // Кнопка проверки — ВСЕГДА активна
        const checkBtn = document.getElementById('checkBtn');
        checkBtn.disabled = false;
        checkBtn.addEventListener('click', checkAnswer);
    }
    
    function checkAnswer() {
        // Сбрасываем фон только у тех ячеек, которые были подсвечены
        document.querySelectorAll('#distributionTable td').forEach(cell => {
            // Сбрасываем только inline-style фон, чтобы не трогать стилизацию из CSS
            cell.style.backgroundColor = '';
        });

        let allCorrect = true;

        // Проверяем каждую строку и столбец
        for (let i = 0; i < referenceTable.length; i++) {
            for (let j = 0; j < referenceTable[i].length; j++) {
                const cell = document.querySelector(`#distributionTable tr:nth-child(${i+1}) td:nth-child(${j+1})`);
                const expected = referenceTable[i][j];
                const actual = cell.textContent.trim();

                // Пропускаем пустые ячейки (пользователь ничего не ввёл)
                if (actual === '') {
                    continue;
                }

                // Если пользователь что-то ввёл — проверяем
                if (expected) {
                    if (actual === expected) {
                        cell.style.backgroundColor = '#d4edda'; // зелёный
                    } else {
                        cell.style.backgroundColor = '#f8d7da'; // красный
                        allCorrect = false;
                    }
                } else {
                    // Ячейка пустая по эталону, но пользователь что-то ввёл
                    cell.style.backgroundColor = '#f8d7da';
                    allCorrect = false;
                }
            }
        }

        // Показываем сообщения
        document.getElementById('successMsg').style.display = allCorrect ? 'block' : 'none';
        document.getElementById('errorMsg').style.display = allCorrect ? 'none' : 'block';
    }
    
    function resetGame() {
        document.querySelectorAll('#distributionTable td').forEach(cell => {
            cell.textContent = '';
            delete cell.dataset.sources;
            cell.style.backgroundColor = ''; // Сброс фона
        });
        
        createSourceTable();
        
        selectedChar = null;
        document.getElementById('selectedChar').textContent = '-';
        
        // Обновляем подсветку
        checkAnswer();
        
        // Скрываем сообщения
        document.getElementById('successMsg').style.display = 'none';
        document.getElementById('errorMsg').style.display = 'none';
    }
</script>
</body>
</html>