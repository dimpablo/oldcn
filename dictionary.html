<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ö–∏—Ç–∞–π—Å–∫–∏–µ –∏–µ—Ä–æ–≥–ª–∏—Ñ—ã –ø–æ —É—Ä–æ–∫–∞–º</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f9f9f9;
            margin: 0;
        }
        h1 {
            text-align: center;
            margin-bottom: 20px;
        }
        h2 {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 5px;
        }
        .lesson {
            margin-bottom: 40px;
        }
        .card-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
        .card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            width: 120px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.2s;
            cursor: pointer;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .char {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        .pinyin {
            color: #e74c3c;
            font-size: 14px;
            margin-bottom: 5px;
        }
        .meaning {
            font-size: 13px;
            color: #555;
        }

        /* –°—Ç–∏–ª–∏ –∏–∑ —Ç–≤–æ–µ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞ ‚Äî –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */
        #theory-loading-bar {
            background-color: #fffaf7;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            font-size: 13px;
            color: #a0a0a0;
            border: 1px solid #f5e1da;
        }

        #theory-tabbed-box {
            display: none;
            background-color: #fffdfb;
            padding: 0;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #f5e1da;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            overflow: hidden;
        }

        #tab-header {
            display: flex;
            align-items: flex-start;
            background-color: #f8f6fb;
            padding: 0;
            user-select: none;
            height: 36px;
        }

        .tab {
            padding: 8px 14px;
            background-color: #f8f6fb;
            color: #a0a0a0;
            font-size: 13px;
            font-weight: normal;
            border: 1px solid #eae5f3;
            border-bottom: none;
            border-radius: 6px 6px 0 0;
            margin-left: 4px;
            cursor: pointer;
        }

        .tab.active {
            background-color: white;
            color: #7c6b96;
            font-weight: bold;
            border-bottom: none;
            position: relative;
            top: 1px;
            z-index: 2;
        }

        #close-theory-btn {
            margin-left: auto;
            background-color: #ff6b6b;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            font-weight: bold;
            margin: 8px 10px 0 0;
            height: 28px;
        }

        #tab-content {
            padding: 10px;
            min-height: 60px;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        #hanzi-frame {
            width: 100%;
            height: 1px;
            border: none;
        }
    </style>
</head>
<body>
    <h1>–°–ª–æ–≤–∞—Ä—å –∏–µ—Ä–æ–≥–ª–∏—Ñ–æ–≤ –ø–æ —É—Ä–æ–∫–∞–º</h1>

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —É—Ä–æ–∫–æ–≤ -->
    <div id="lessons-container"></div>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º —Å–ª–æ–≤–∞—Ä—å -->
    <script src="dictionary.js"></script>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∫–∞—Ä—Ç–æ—á–µ–∫ -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const container = document.getElementById('lessons-container');

            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –∏–µ—Ä–æ–≥–ª–∏—Ñ—ã –ø–æ —É—Ä–æ–∫–∞–º
            const lessons = {};
            for (const char in charData) {
                const lessonNum = charData[char].lesson;
                if (!lessons[lessonNum]) {
                    lessons[lessonNum] = [];
                }
                lessons[lessonNum].push({
                    char,
                    pinyin: charData[char].pinyin,
                    meaning: charData[char].meaning
                });
            }

            const sortedLessons = Object.keys(lessons).sort((a, b) => a - b);

            // –°–æ–∑–¥–∞—ë–º HTML –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É—Ä–æ–∫–∞
            sortedLessons.forEach(lessonNum => {
                const lessonDiv = document.createElement('div');
                lessonDiv.className = 'lesson';

                const title = document.createElement('h2');
                title.textContent = `–£—Ä–æ–∫ ${lessonNum}`;
                lessonDiv.appendChild(title);

                const cardContainer = document.createElement('div');
                cardContainer.className = 'card-container';

                lessons[lessonNum].sort((a, b) => a.char.localeCompare(b.char));

                lessons[lessonNum].forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.dataset.hanzi = item.char; // ‚Üê –í–ê–ñ–ù–û: —Ç–≤–æ–π —Å–∫—Ä–∏–ø—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç dataset.hanzi

                    const charElem = document.createElement('div');
                    charElem.className = 'char';
                    charElem.textContent = item.char;

                    const pinyinElem = document.createElement('div');
                    pinyinElem.className = 'pinyin';
                    pinyinElem.textContent = item.pinyin;

                    const meaningElem = document.createElement('div');
                    meaningElem.className = 'meaning';
                    meaningElem.textContent = item.meaning;

                    card.appendChild(charElem);
                    card.appendChild(pinyinElem);
                    card.appendChild(meaningElem);

                    cardContainer.appendChild(card);
                });

                lessonDiv.appendChild(cardContainer);
                container.appendChild(lessonDiv);
            });

            // –ó–∞–ø—É—Å–∫–∞–µ–º –¢–í–û–ô —Å–∫—Ä–∏–ø—Ç –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
            setTimeout(() => {
                if (typeof mainScript === 'function') {
                    mainScript();
                }
            }, 100);
        });
    </script>

    <!-- –¢–í–û–ô –°–ö–†–ò–ü–¢ ‚Äî –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–¥ .card –∏ #lessons-container -->
    <script>
        // === –°–ö–†–ò–ü–¢ –î–õ–Ø –ö–û–ù–°–û–õ–ò: –ì–õ–û–ë–ê–õ–¨–ù–ê–Ø mainScript + –ù–ê–ë–õ–Æ–î–ê–¢–ï–õ–¨ ===
        function mainScript() {
            // –ò–ó–ú–ï–ù–ï–ù–û: –∏—â–µ–º –Ω–µ –≤ #dictionaryContent, –∞ –≤ #lessons-container
            var dictContainer = document.getElementById('lessons-container');
            if (!dictContainer) return;

            // –ò–ó–ú–ï–ù–ï–ù–û: —Å–æ–±–∏—Ä–∞–µ–º –Ω–µ .dict-item, –∞ .card
            var items = dictContainer.querySelectorAll('.card');
            var list = [];

            for (var i = 0; i < items.length; i++) {
                var item = items[i];
                var hanzi = item.dataset.hanzi;
                var pinyin = ''; // –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –ø–∏–Ω—å–∏–Ω—å –µ—Å—Ç—å, –Ω–æ –¥–ª—è —Ç–≤–æ–µ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞ –æ–Ω –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω
                if (hanzi) {
                    list.push({ hanzi: hanzi, pinyin: pinyin });
                }
            }

            if (list.length === 0) return;

            // --- –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –∏ –±–ª–æ–∫ —Ç–µ–æ—Ä–∏–∏ ---
            var oldLoading = document.getElementById('theory-loading-bar');
            if (oldLoading) oldLoading.remove();

            var oldBox = document.getElementById('theory-tabbed-box');
            if (oldBox) oldBox.remove();

            // --- –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã ---
            // –ò–ó–ú–ï–ù–ï–ù–û: –≤—Å—Ç–∞–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –∏ UI –ø—Ä—è–º–æ –≤ body, –ø–æ—Å–ª–µ lessons-container
            var container = document.body;
            var contentAnchor = document.getElementById('lessons-container');

            if (!container || !contentAnchor) return;

            // --- –°–æ–∑–¥–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä ---
            var loadingEl = document.createElement('div');
            loadingEl.id = 'theory-loading-bar';
            loadingEl.style.cssText = `
                background-color: #fffaf7;
                padding: 10px;
                border-radius: 8px;
                margin: 10px 0;
                text-align: center;
                font-size: 13px;
                color: #a0a0a0;
                border: 1px solid #f5e1da;
            `;
            loadingEl.innerHTML = 'üîç –ü–æ–∏—Å–∫ –¥–∞–Ω–Ω—ã—Ö... (0/60)';
            container.insertBefore(loadingEl, contentAnchor.nextSibling);

            function updateProgress(count) {
                if (loadingEl) {
                    loadingEl.innerHTML = `üîç –ü–æ–∏—Å–∫ –¥–∞–Ω–Ω—ã—Ö... (${count}/60)`;
                }
            }

            // --- –ö—ç—à–∏ –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã ---
            if (!window.theoryCache) window.theoryCache = {};
            if (!window.masterTheoryResults) window.masterTheoryResults = [];
            var results = [];
            var loadedCount = 0;

            // --- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ ---
            (async function () {
                try {
                    for (var lessonNum = 1; lessonNum <= 60; lessonNum++) {
                        var url = '../lesson' + lessonNum + '/theory.html';
                        try {
                            var html = window.theoryCache[url];
                            if (!html) {
                                var response = await fetch(url);
                                if (!response.ok) continue;
                                html = await response.text();
                                window.theoryCache[url] = html;
                            }

                            var parser = new DOMParser();
                            var doc = parser.parseFromString(html, 'text/html');
                            var grammarSection = doc.querySelector('.grammar');
                            if (!grammarSection) continue;

                            var blocks = grammarSection.querySelectorAll('p.original');
                            for (var j = 0; j < list.length; j++) {
                                var hanzi = list[j].hanzi;
                                for (var k = 0; k < blocks.length; k++) {
                                    var block = blocks[k];
                                    if (block.textContent.includes(hanzi)) {
                                        var h3 = null;
                                        var sibling = block.previousElementSibling;
                                        while (sibling) {
                                            if (sibling.tagName === 'H3') {
                                                h3 = sibling;
                                                break;
                                            }
                                            sibling = sibling.previousElementSibling;
                                        }
                                        var title = h3 ? h3.textContent.trim() : '(–±–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞)';
                                        var context = h3 ? '<h3>' + h3.innerHTML + '</h3>' + block.outerHTML : block.outerHTML;
                                        results.push({ hanzi: hanzi, lesson: lessonNum, title: title, context: context });
                                    }
                                }
                            }
                        } catch (err) {
                            console.warn(`–û—à–∏–±–∫–∞ –≤ —É—Ä–æ–∫–µ ${lessonNum}`, err.message);
                        } finally {
                            loadedCount++;
                            updateProgress(loadedCount);
                        }
                    }

                    // --- –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –±–∞–∑—É ---
                    window.masterTheoryResults = window.masterTheoryResults.concat(
                        results.filter(r => !window.masterTheoryResults.some(x => x.hanzi === r.hanzi && x.lesson === r.lesson && x.title === r.title))
                    );

                    // --- –£–¥–∞–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –∏ —Å–æ–∑–¥–∞–µ–º UI ---
                    if (loadingEl) loadingEl.remove();
                    createTabInterface(container, contentAnchor, results);

                } catch (err) {
                    console.error('Critical error:', err);
                    if (loadingEl) loadingEl.innerHTML = '‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
                }
            })();
        }

        function createTabInterface(container, contentAnchor, resultsForDebug) {
            var theoryBox = document.createElement('div');
            theoryBox.id = 'theory-tabbed-box';
            theoryBox.style.cssText = `
                display: none;
                background-color: #fffdfb;
                padding: 0;
                border-radius: 8px;
                margin: 10px 0;
                border: 1px solid #f5e1da;
                box-shadow: 0 1px 3px rgba(0,0,0,0.05);
                overflow: hidden;
            `;
            container.insertBefore(theoryBox, contentAnchor.nextSibling);

            theoryBox.innerHTML = `
                <div id="tab-header" style="
                    display: flex;
                    align-items: flex-start;
                    background-color: #f8f6fb;
                    padding: 0;
                    user-select: none;
                    height: 36px;
                ">
                    <div class="tab active" data-tab="theory" style="
                        padding: 8px 14px;
                        background-color: white;
                        color: #7c6b96;
                        font-size: 13px;
                        font-weight: bold;
                        border: 1px solid #eae5f3;
                        border-bottom: none;
                        border-radius: 6px 6px 0 0;
                        margin-left: 10px;
                        cursor: pointer;
                        box-shadow: 0 -1px 2px rgba(0,0,0,0.05);
                        position: relative;
                        top: 1px;
                        z-index: 2;
                    ">üìå –¢–µ–æ—Ä–∏—è</div>
                    <div class="tab" data-tab="input" style="
                        padding: 8px 14px;
                        background-color: #f8f6fb;
                        color: #a0a0a0;
                        font-size: 13px;
                        font-weight: normal;
                        border: 1px solid #eae5f3;
                        border-bottom: none;
                        border-radius: 6px 6px 0 0;
                        margin-left: 4px;
                        cursor: pointer;
                    ">‚úçÔ∏è –†—É–∫–æ–ø–∏—Å–Ω—ã–π –≤–≤–æ–¥</div>
                    <button id="close-theory-btn" style="
                        margin-left: auto;
                        background-color: #ff6b6b;
                        color: white;
                        border: none;
                        padding: 6px 12px;
                        border-radius: 6px;
                        font-size: 13px;
                        cursor: pointer;
                        font-weight: bold;
                        margin: 8px 10px 0 0;
                        height: 28px;
                    ">–ó–ê–ö–†–´–¢–¨</button>
                </div>
                <div id="tab-content" style="padding: 10px; min-height: 60px;">
                    <div id="tab-theory" class="tab-pane active"></div>
                    <div id="tab-input" class="tab-pane" style="display:none;">
                        <iframe id="hanzi-frame" style="width:100%; height:1px; border:none;" src=""></iframe>
                    </div>
                </div>
            `;

            var tabs = document.querySelectorAll('.tab');
            var panes = document.querySelectorAll('.tab-pane');
            var closeBtn = document.getElementById('close-theory-btn');
            var hanziFrame = document.getElementById('hanzi-frame');

            for (var i = 0; i < tabs.length; i++) {
                tabs[i].onclick = function () {
                    for (var tab of tabs) {
                        tab.classList.remove('active');
                        if (tab.dataset.tab === 'input') {
                            tab.style.backgroundColor = '#f8f6fb';
                            tab.style.color = '#a0a0a0';
                            tab.style.fontWeight = 'normal';
                        }
                    }
                    for (var pane of panes) pane.style.display = 'none';

                    this.classList.add('active');
                    this.style.backgroundColor = 'white';
                    this.style.color = '#7c6b96';
                    this.style.fontWeight = 'bold';

                    var targetPane = document.getElementById('tab-' + this.dataset.tab);
                    targetPane.style.display = 'block';

                    if (this.dataset.tab === 'input') {
                        var hanzi = theoryBox.dataset.hanzi;
                        hanziFrame.src = './tasks/task1.html#' + hanzi;
                        document.getElementById('tab-content').style.padding = '10px 10px 15px';
                        hanziFrame.style.height = '420px';
                    } else {
                        document.getElementById('tab-content').style.padding = '10px';
                        if (hanziFrame) hanziFrame.style.height = '1px';
                    }
                };
            }

            closeBtn.onclick = function () {
                theoryBox.style.display = 'none';
                if (hanziFrame) hanziFrame.src = '';
            };

            // –ò–ó–ú–ï–ù–ï–ù–û: –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–ª–∏–∫–∏ –ø–æ .card, –∞ –Ω–µ .dict-item
            var items = document.querySelectorAll('.card');
            for (var idx = 0; idx < items.length; idx++) {
                (function (item) {
                    var hanzi = item.dataset.hanzi;
                    // –£–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ä—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫, –µ—Å–ª–∏ –µ—Å—Ç—å
                    if (item.clickHandler) {
                        item.removeEventListener('click', item.clickHandler);
                    }
                    item.clickHandler = function () {
                        if (theoryBox.style.display === 'block' && theoryBox.dataset.hanzi === hanzi) {
                            theoryBox.style.display = 'none';
                            return;
                        }
                        theoryBox.dataset.hanzi = hanzi;
                        theoryBox.style.display = 'block';
                        var theoryPane = document.getElementById('tab-theory');
                        theoryPane.innerHTML = '<p style="color:#999;font-size:12px;">–ü–æ–∏—Å–∫...</p>';

                        var filteredResults = window.masterTheoryResults.filter(r => r.hanzi === hanzi);
                        if (filteredResults.length === 0) {
                            theoryPane.innerHTML = '<p style="color:#999;font-size:12px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö.</p>';
                        } else {
                            var html = '';
                            for (var j = 0; j < filteredResults.length; j++) {
                                var res = filteredResults[j];
                                var context = res.context.replace(new RegExp('(' + hanzi + ')', 'g'), '<span style="background-color:#ffb6c1;padding:0 2px;border-radius:3px;">$1</span>');
                                html += `
                                    <div style="margin-bottom:14px;">
                                        <strong style="color:#5a5a5a;font-size:12px;">–£—Ä–æ–∫ ${res.lesson}</strong>
                                        <h4 style="margin:4px 0;color:#7c6b96;">${res.title}</h4>
                                        <div style="
                                            background:#f9f7fc;
                                            padding:10px;
                                            border-left:4px solid #a8c8d8;
                                            border-radius:0 6px 6px 0;
                                            font-size:13px;
                                            line-height:1.5;
                                        ">${context}</div>
                                    </div>`;
                            }
                            theoryPane.innerHTML = html;
                        }
                        tabs[0].onclick(); // –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø–µ—Ä–≤—É—é –≤–∫–ª–∞–¥–∫—É
                    };
                    item.addEventListener('click', item.clickHandler);
                })(items[idx]);
            }
        }

        // --- –ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å –∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ –≤ DOM ---
        if (!window.__theoryObserverInstalled) {
            var observer = new MutationObserver(function (mutations) {
                for (var m of mutations) {
                    if (m.type === 'childList' && m.target.id === 'lessons-container') {
                        setTimeout(mainScript, 100);
                        break;
                    }
                }
            });
            observer.observe(document.body, { childList: true, subtree: true });
            window.__theoryObserverInstalled = true;
            console.log('‚úÖ –ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å –∑–∞ DOM —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.');
        }

        // --- –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ (—É–∂–µ –µ—Å—Ç—å –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Å–∫—Ä–∏–ø—Ç–µ –≤—ã—à–µ) ---
        // mainScript() –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –∫–∞—Ä—Ç–æ—á–µ–∫
    </script>
</body>
</html>