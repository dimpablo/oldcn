<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>–ò–µ—Ä–æ–≥–ª–∏—Ñ–∏–∫–∞</title>
  <style>
    html, body {
      width: 100%;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f8f9fa;
      color: #333;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      padding: 10px;
      gap: 8px;
      width: 100%;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 16px;
      color: #555;
      flex-shrink: 0;
    }

    .scale-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .scale-btn {
      width: 28px;
      height: 28px;
      font-size: 18px;
      line-height: 28px;
      text-align: center;
      background-color: #e0e0e0;
      border-radius: 50%;
      cursor: pointer;
      user-select: none;
    }

    .scale-value {
      min-width: 36px;
      text-align: center;
      font-weight: bold;
    }

    #progress-container {
      width: 100%;
      height: 6px;
      background-color: #e0e0e0;
      border-radius: 3px;
      overflow: hidden;
      flex-shrink: 0;
    }

    #progress-bar {
      height: 100%;
      width: 0%;
      background-color: #4caf50;
      transition: width 0.4s ease;
      border-radius: 3px;
    }

    #task-container {
      flex: 1;
      width: 100%;
      border: none;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease;
      min-height: 0;
      max-height: calc(100vh - 150px);
    }

    #task-container.active {
      opacity: 1;
      visibility: visible;
    }

    #task-frame {
      width: 100%;
      height: 100%;
      border: none;
      transform-origin: center top;
      transform: scale(1);
      transition: transform 0.2s ease;
      overflow: auto;
    }

    .controls {
      padding: 12px 0;
      display: flex;
      justify-content: center;
      flex-shrink: 0;
    }

    #next-btn {
      padding: 14px 24px;
      font-size: 18px;
      font-weight: 600;
      color: white;
      background-color: #1976d2;
      border: none;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      transition: background-color 0.2s ease, transform 0.1s ease;
      width: 90%;
      max-width: 300px;
    }

    #next-btn:active {
      transform: scale(0.98);
    }

    #next-btn:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
      transform: none;
    }

#status {
  font-size: 16px;
  text-align: center;
  color: #555;
  white-space: nowrap;        /* –ó–∞–ø—Ä–µ—â–∞–µ–º –ø–µ—Ä–µ–Ω–æ—Å */
  overflow: hidden;           /* –û–±—Ä–µ–∑–∞–µ–º, –µ—Å–ª–∏ –Ω–µ –≤–ª–µ–∑–∞–µ—Ç */
  text-overflow: ellipsis;    /* –ú–Ω–æ–≥–æ—Ç–æ—á–∏–µ, –µ—Å–ª–∏ –æ–±—Ä–µ–∑–∞–µ–º */
  padding: 0 8px;
}

    @media (max-width: 768px) {
      #task-container {
        max-height: calc(100vh - 180px);
      }
      
      .controls {
        padding: 8px 0;
      }
      
      #next-btn {
        padding: 12px 16px;
        font-size: 16px;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <div id="status">üî§ –ì–æ—Ç–æ–≤ –∫ —É—Ä–æ–∫—É</div>
    <div class="scale-controls">
      <div class="scale-btn" id="zoom-out">‚àí</div>
      <div class="scale-value" id="scale-value">1.0</div>
      <div class="scale-btn" id="zoom-in">+</div>
    </div>
  </div>

  <div id="progress-container">
    <div id="progress-bar"></div>
  </div>

  <div id="task-container">
    <iframe id="task-frame" src="about:blank" frameborder="0" allowfullscreen></iframe>
  </div>

  <div class="controls">
    <button id="next-btn">‚ñ∂Ô∏è –°—Ç–∞—Ä—Ç!</button>
  </div>
<script src="./../dictionary.js"></script>

<script>
  // === –ù–ê–°–¢–†–û–ô–ö–ê –£–†–û–ö–ê ===
  const LESSON = 4;  // ‚Üê –ú–µ–Ω—è–π –Ω–æ–º–µ—Ä —É—Ä–æ–∫–∞ –∑–¥–µ—Å—å

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–ª–æ–≤–∞—Ä—è
  if (typeof charData === 'undefined') {
    console.error('‚ùå –ù–µ –∑–∞–≥—Ä—É–∂–µ–Ω dictionary.js');
    alert('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ª–æ–≤–∞—Ä—å –∏–µ—Ä–æ–≥–ª–∏—Ñ–æ–≤.');
    throw new Error('charData not found');
  }

  // === –°–æ–±–∏—Ä–∞–µ–º –∏–µ—Ä–æ–≥–ª–∏—Ñ—ã –Ω—É–∂–Ω–æ–≥–æ —É—Ä–æ–∫–∞ ===
  const lessonwords = Object.keys(charData).filter(key => {
    const data = charData[key];
    return data.lesson === LESSON;
  });

  if (lessonwords.length === 0) {
    console.error(`‚ùå –ù–µ—Ç –∏–µ—Ä–æ–≥–ª–∏—Ñ–æ–≤ –¥–ª—è —É—Ä–æ–∫–∞ ${LESSON}`);
    alert(`–ù–µ—Ç –∏–µ—Ä–æ–≥–ª–∏—Ñ–æ–≤ –¥–ª—è —É—Ä–æ–∫–∞ ${LESSON}. –ü—Ä–æ–≤–µ—Ä—å –ø–æ–ª–µ 'lesson' –≤ dictionary.js`);
  }

  // === –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º ===
  function shuffleArray(array) {
    const arr = [...array];
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  const shuffledLesson = shuffleArray(lessonwords);
  const totalTasks = shuffledLesson.length;
  let currentTaskIndex = 0;

  // === –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–∞—Å—à—Ç–∞–±–∞ ===
  let currentScale = 1.0;
  const minScale = 0.25;
  const maxScale = 2.0;
  const scaleStep = 0.1;

  const iframe = document.getElementById("task-frame");
  const statusEl = document.getElementById("status");
  const nextBtn = document.getElementById("next-btn");
  const progressBar = document.getElementById("progress-bar");
  const scaleValueEl = document.getElementById("scale-value");
  const zoomInBtn = document.getElementById("zoom-in");
  const zoomOutBtn = document.getElementById("zoom-out");

  // --- –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ ---
  function setScale(scale) {
    currentScale = Math.max(minScale, Math.min(maxScale, Math.round(scale * 10) / 10));
    iframe.style.transform = `scale(${currentScale})`;
    scaleValueEl.textContent = currentScale.toFixed(1);
  }

  zoomInBtn.addEventListener("click", () => setScale(currentScale + scaleStep));
  zoomOutBtn.addEventListener("click", () => setScale(currentScale - scaleStep));

  // --- –ü—Ä–æ–∏–≥—Ä—ã–≤–∞–Ω–∏–µ –∑–≤—É–∫–∞ ---
  function playHanziSound(hanzi) {
    const data = charData[hanzi];
    if (!data || !data.pinyin) return;

    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –ø–∏–Ω—å–∏–Ω—å —Å –¥–∏–∞–∫—Ä–∏—Ç–∏–∫–æ–π ‚Üí —Å —Ü–∏—Ñ—Ä–æ–≤—ã–º —Ç–æ–Ω–æ–º
    let cleanPinyin = data.pinyin
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, '')
      .replace(/√º/g, 'u')
      .replace(/v/g, 'u');

    let tone = '1';
    if (data.pinyin.includes('ƒÅ') || data.pinyin.includes('ƒì') || data.pinyin.includes('ƒ´') || data.pinyin.includes('≈ç') || data.pinyin.includes('≈´') || data.pinyin.includes('«ñ')) tone = '1';
    else if (data.pinyin.includes('√°') || data.pinyin.includes('√©') || data.pinyin.includes('√≠') || data.pinyin.includes('√≥') || data.pinyin.includes('√∫') || data.pinyin.includes('«ò')) tone = '2';
    else if (data.pinyin.includes('«é') || data.pinyin.includes('ƒõ') || data.pinyin.includes('«ê') || data.pinyin.includes('«í') || data.pinyin.includes('«î') || data.pinyin.includes('«ö')) tone = '3';
    else if (data.pinyin.includes('√†') || data.pinyin.includes('√®') || data.pinyin.includes('√¨') || data.pinyin.includes('√≤') || data.pinyin.includes('√π') || data.pinyin.includes('«ú')) tone = '4';

    const pinyinKey = cleanPinyin + tone;
    const url = `https://data.dong-chinese.com/pinyin/b/${pinyinKey}.mp3`;
    const audio = new Audio(url);

    audio.play().catch(e => {
      console.error(`‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–∏–≥—Ä–∞—Ç—å –∑–≤—É–∫ –¥–ª—è '${hanzi}':`, e);
    });
  }

  // --- –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞–Ω–∏—è ---
  function loadNextTask() {
    if (currentTaskIndex >= totalTasks) return;

    const hanzi = shuffledLesson[currentTaskIndex];
    const data = charData[hanzi] || { pinyin: '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ', meaning: '–∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ' };
    const pinyin = data.pinyin;

    const url = `tasks/task1.html?_=${Date.now()}#${hanzi}`;

    // –°–æ–∫—Ä–∞—â–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ, –µ—Å–ª–∏ –æ–Ω–æ –¥–ª–∏–Ω–Ω–æ–µ
    const meaningDisplay = data.meaning.length > 50 
      ? data.meaning.slice(0, 47) + '...' 
      : data.meaning;

    statusEl.textContent = `${hanzi} ‚Ä¢ ${pinyin} ‚Ä¢ —É—Ä–æ–∫ ${LESSON}: ${meaningDisplay}`;
    statusEl.title = `–£—Ä–æ–∫ ${LESSON}: ${data.meaning}`;

    document.getElementById("task-container").classList.add("active");

    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ iframe
    iframe.src = '';
    setTimeout(() => {
      iframe.src = url;
    }, 10);

    // –ü—Ä–æ–∏–≥—Ä—ã–≤–∞–µ–º –∑–≤—É–∫
    setTimeout(() => playHanziSound(hanzi), 500);

    // –ü—Ä–æ–≥—Ä–µ—Å—Å
    progressBar.style.width = `${(currentTaskIndex / totalTasks) * 100}%`;
  }

  // --- –ö–Ω–æ–ø–∫–∞ "–°—Ç–∞—Ä—Ç!" ‚Üí "–°–ª–µ–¥—É—é—â–µ–µ –∑–∞–¥–∞–Ω–∏–µ" ---
  nextBtn.addEventListener("click", () => {
    if (currentTaskIndex === 0) {
      nextBtn.textContent = "‚ñ∂Ô∏è –°–ª–µ–¥—É—é—â–µ–µ –∑–∞–¥–∞–Ω–∏–µ";
      loadNextTask();
      currentTaskIndex++;
      return;
    }

    if (currentTaskIndex < totalTasks) {
      loadNextTask();
      currentTaskIndex++;
      return;
    }

    // –ö–æ–Ω–µ—Ü —É—Ä–æ–∫–∞
    iframe.style.display = "none";
    nextBtn.disabled = true;
    statusEl.innerHTML = `<div style="text-align: center;">
      <h2>üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!</h2>
      <p>–í—ã –∑–∞–≤–µ—Ä—à–∏–ª–∏ —É—Ä–æ–∫ ${LESSON}<br><strong>–ò–µ—Ä–æ–≥–ª–∏—Ñ–∏–∫–∞</strong>!</p>
      <div id="fireworks" style="width: 100%; height: 200px; position: relative; background: #0000; border-radius: 8px; margin: 10px 0;"></div>
    </div>`;
    createFireworks();
    setTimeout(() => window.location.href = "../", 5000);
  });

  // --- –§–µ–π–µ—Ä–≤–µ—Ä–∫–∏ ---
  function createFireworks() {
    const container = document.getElementById("fireworks");
    const colors = ["#FF0000", "#00FF00", "#0000FF", "#FFFF00", "#FF00FF", "#00FFFF", "#FFA500", "#FFFFFF"];
    const particles = 50;

    function createExplosion(x, y) {
      for (let i = 0; i < particles; i++) {
        const particle = document.createElement("div");
        const angle = Math.random() * Math.PI * 2;
        const speed = 1 + Math.random() * 3;
        const size = 2 + Math.random() * 4;

        particle.style.position = "absolute";
        particle.style.width = `${size}px`;
        particle.style.height = `${size}px`;
        particle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        particle.style.borderRadius = "50%";
        particle.style.boxShadow = "0 0 6px currentColor";
        particle.style.left = `${x}px`;
        particle.style.top = `${y}px`;
        particle.style.pointerEvents = "none";

        container.appendChild(particle);

        let dx = Math.cos(angle) * speed;
        let dy = Math.sin(angle) * speed;
        let opacity = 1;
        let posX = x;
        let posY = y;

        const animate = () => {
          opacity -= 0.02;
          posX += dx;
          posY += dy + 0.1;
          dy += 0.05;

          particle.style.opacity = opacity;
          particle.style.left = `${posX}px`;
          particle.style.top = `${posY}px`;

          if (opacity > 0) {
            requestAnimationFrame(animate);
          } else {
            container.removeChild(particle);
          }
        };

        requestAnimationFrame(animate);
      }
    }

    for (let i = 0; i < 5; i++) {
      setTimeout(() => {
        const x = 50 + Math.random() * (container.offsetWidth - 100);
        const y = 100 + Math.random() * (container.offsetHeight - 100);
        createExplosion(x, y);
      }, i * 300);
    }
  }

  // --- –ó–∞–ø—É—Å–∫ ---
  window.addEventListener("load", () => {
    console.log(`üìö –£—Ä–æ–∫ ${LESSON}: –Ω–∞–π–¥–µ–Ω–æ ${lessonwords.length} –∏–µ—Ä–æ–≥–ª–∏—Ñ–æ–≤`, lessonwords);
    console.log("üé≤ –ü–µ—Ä–µ–º–µ—à–∞–Ω–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫:", shuffledLesson);

    if (window.innerWidth <= 768 || (navigator.maxTouchPoints && navigator.maxTouchPoints > 1)) {
      setScale(1);
    }
  });
</script>
</body>
</html>