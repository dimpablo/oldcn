<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>–ò–µ—Ä–æ–≥–ª–∏—Ñ–∏–∫–∞</title>
  <style>
    html, body {
      width: 100%;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f8f9fa;
      color: #333;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      padding: 10px;
      gap: 8px;
      width: 100%;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 16px;
      color: #555;
      flex-shrink: 0;
    }

    .scale-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .scale-btn {
      width: 28px;
      height: 28px;
      font-size: 18px;
      line-height: 28px;
      text-align: center;
      background-color: #e0e0e0;
      border-radius: 50%;
      cursor: pointer;
      user-select: none;
    }

    .scale-value {
      min-width: 36px;
      text-align: center;
      font-weight: bold;
    }

    #progress-container {
      width: 100%;
      height: 6px;
      background-color: #e0e0e0;
      border-radius: 3px;
      overflow: hidden;
      flex-shrink: 0;
    }

    #progress-bar {
      height: 100%;
      width: 0%;
      background-color: #4caf50;
      transition: width 0.4s ease;
      border-radius: 3px;
    }

    #task-container {
      flex: 1;
      width: 100%;
      border: none;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease;
      min-height: 0;
      max-height: calc(100vh - 150px);
    }

    #task-container.active {
      opacity: 1;
      visibility: visible;
    }

    #task-frame {
      width: 100%;
      height: 100%;
      border: none;
      transform-origin: center top;
      transform: scale(1);
      transition: transform 0.2s ease;
      overflow: auto;
    }

    .controls {
      padding: 12px 0;
      display: flex;
      justify-content: center;
      gap: 12px;
      flex-shrink: 0;
    }

    button {
      padding: 14px 24px;
      font-size: 18px;
      font-weight: 600;
      border: none;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      transition: background-color 0.2s ease, transform 0.1s ease;
      width: calc(50% - 6px);
      max-width: 200px;
    }

    button:active {
      transform: scale(0.98);
    }

    #next-btn {
      color: white;
      background-color: #1976d2;
    }

    #next-btn:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }

    #skip-btn {
      color: white;
      background-color: #6c757d;
    }

    #status {
      font-size: 16px;
      text-align: center;
      color: #555;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      padding: 0 8px;
    }

    @media (max-width: 768px) {
      #task-container {
        max-height: calc(100vh - 180px);
      }
      
      .controls {
        padding: 8px 0;
      }
      
      button {
        padding: 12px 16px;
        font-size: 16px;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <div id="status">üî§ –ì–æ—Ç–æ–≤ –∫ —É—Ä–æ–∫—É</div>
    <div class="scale-controls">
      <div class="scale-btn" id="zoom-out">‚àí</div>
      <div class="scale-value" id="scale-value">1.0</div>
      <div class="scale-btn" id="zoom-in">+</div>
    </div>
  </div>

  <div id="progress-container">
    <div id="progress-bar"></div>
  </div>

  <div id="task-container">
    <iframe id="task-frame" src="about:blank" frameborder="0" allowfullscreen></iframe>
  </div>

  <div class="controls">
    <button id="next-btn">‚ñ∂Ô∏è –°—Ç–∞—Ä—Ç!</button>
    <button id="skip-btn" style="display: none;">‚è≠Ô∏è –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
  </div>

  <script src="./../dictionary.js"></script>

  <script>
    // === –ù–ê–°–¢–†–û–ô–ö–ê –£–†–û–ö–ê ===
    const LESSON = 5;

    if (typeof charData === 'undefined') {
      console.error('‚ùå –ù–µ –∑–∞–≥—Ä—É–∂–µ–Ω dictionary.js');
      alert('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ª–æ–≤–∞—Ä—å –∏–µ—Ä–æ–≥–ª–∏—Ñ–æ–≤.');
      throw new Error('charData not found');
    }

    const lessonwords = Object.keys(charData).filter(key => {
      const data = charData[key];
      return data.lesson === LESSON && key.length === 1; // —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω–æ—á–Ω—ã–µ –∏–µ—Ä–æ–≥–ª–∏—Ñ—ã
    });

    if (lessonwords.length === 0) {
      console.error(`‚ùå –ù–µ—Ç –∏–µ—Ä–æ–≥–ª–∏—Ñ–æ–≤ –¥–ª—è —É—Ä–æ–∫–∞ ${LESSON}`);
      alert(`–ù–µ—Ç –∏–µ—Ä–æ–≥–ª–∏—Ñ–æ–≤ –¥–ª—è —É—Ä–æ–∫–∞ ${LESSON}`);
    }

    function shuffleArray(array) {
      const arr = [...array];
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    const shuffledLesson = shuffleArray(lessonwords);
    const totalTasks = shuffledLesson.length;
    let currentTaskIndex = 0;

    let currentScale = 1.0;
    const minScale = 0.25;
    const maxScale = 2.0;
    const scaleStep = 0.1;

    const iframe = document.getElementById("task-frame");
    const statusEl = document.getElementById("status");
    const nextBtn = document.getElementById("next-btn");
    const skipBtn = document.getElementById("skip-btn");
    const progressBar = document.getElementById("progress-bar");
    const scaleValueEl = document.getElementById("scale-value");
    const zoomInBtn = document.getElementById("zoom-in");
    const zoomOutBtn = document.getElementById("zoom-out");

    function setScale(scale) {
      currentScale = Math.max(minScale, Math.min(maxScale, Math.round(scale * 10) / 10));
      iframe.style.transform = `scale(${currentScale})`;
      scaleValueEl.textContent = currentScale.toFixed(1);
    }

    zoomInBtn.addEventListener("click", () => setScale(currentScale + scaleStep));
    zoomOutBtn.addEventListener("click", () => setScale(currentScale - scaleStep));

    function playHanziSound(hanzi) {
      const data = charData[hanzi];
      if (!data || !data.pinyin) return;

      let cleanPinyin = data.pinyin
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/√º/g, 'u')
        .replace(/v/g, 'u');

      let tone = '1';
      if (data.pinyin.includes('ƒÅ')) tone = '1';
      else if (data.pinyin.includes('√°')) tone = '2';
      else if (data.pinyin.includes('«é')) tone = '3';
      else if (data.pinyin.includes('√†')) tone = '4';

      const pinyinKey = cleanPinyin + tone;
      const url = `https://data.dong-chinese.com/pinyin/b/${pinyinKey}.mp3`;
      const audio = new Audio(url);

      audio.play().catch(e => {
        console.warn(`üîá –ù–µ—Ç –∑–≤—É–∫–∞ –¥–ª—è ${hanzi}`);
      });
    }

    window.addEventListener("message", function(event) {
      if (event.data.type === "TASK_RESULT" && event.data.success) {
        statusEl.textContent = "‚úÖ –ì–æ—Ç–æ–≤–æ! –ú–æ–∂–Ω–æ –¥–∞–ª—å—à–µ";
        nextBtn.disabled = false;
      }
    });

    function loadNextTask() {
      if (currentTaskIndex >= totalTasks) return;

      const hanzi = shuffledLesson[currentTaskIndex];
      const data = charData[hanzi] || {};

      const url = `tasks/task1.html?_=${Date.now()}#${encodeURIComponent(hanzi)}`;

      const meaningDisplay = (data.meaning?.length > 50)
        ? data.meaning.slice(0, 47) + '...'
        : data.meaning || '–∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ';

      statusEl.textContent = `${hanzi} ‚Ä¢ ${data.pinyin || '‚Äî'} ‚Ä¢ ${meaningDisplay}`;
      statusEl.title = `${data.meaning || ''}`;

      document.getElementById("task-container").classList.add("active");
      nextBtn.disabled = true;
      if (skipBtn) skipBtn.style.display = "block";

      iframe.src = '';
      setTimeout(() => { iframe.src = url; }, 50);

      setTimeout(() => playHanziSound(hanzi), 600);
      progressBar.style.width = `${(currentTaskIndex / totalTasks) * 100}%`;
    }

    nextBtn.addEventListener("click", () => {
      if (currentTaskIndex === 0) {
        nextBtn.textContent = "‚ñ∂Ô∏è –°–ª–µ–¥—É—é—â–µ–µ";
        loadNextTask();
        currentTaskIndex++;
        return;
      }

      if (currentTaskIndex < totalTasks) {
        loadNextTask();
        currentTaskIndex++;
        return;
      }

      iframe.style.display = "none";
      nextBtn.disabled = true;
      skipBtn.style.display = "none";
      statusEl.innerHTML = `<div style="text-align: center;">
        <h2>üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!</h2>
        <p>–í—ã –∑–∞–≤–µ—Ä—à–∏–ª–∏ —É—Ä–æ–∫ ${LESSON}</p>
      </div>`;
      setTimeout(() => window.location.href = "../", 3000);
    });

    if (skipBtn) {
      skipBtn.addEventListener("click", () => {
        loadNextTask();
        currentTaskIndex++;
        if (currentTaskIndex >= totalTasks) {
          nextBtn.click();
        }
      });
    }

    window.addEventListener("load", () => {
      console.log(`üìö –£—Ä–æ–∫ ${LESSON}: ${lessonwords.length} –∏–µ—Ä–æ–≥–ª–∏—Ñ–æ–≤`);
      console.log("üé≤ –ü–æ—Ä—è–¥–æ–∫:", shuffledLesson);
      setScale(1.0);
    });
  </script>
</body>
</html>