<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>–ó–∞–¥–∞–Ω–∏—è —É—Ä–æ–∫–∞ 1</title>
  <style>
    html, body { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:#f8f9fa; color:#333; display:flex; flex-direction:column; gap:8px; padding:10px; }
    .header { display:flex; justify-content:space-between; align-items:center; font-size:16px; color:#555; }
    .scale-controls { display:flex; align-items:center; gap:8px; }
    .scale-btn { width:28px; height:28px; font-size:18px; line-height:28px; text-align:center; background:#e0e0e0; border-radius:50%; cursor:pointer; user-select:none; }
    .scale-value { min-width:36px; text-align:center; font-weight:bold; }
    #progress-container { width:100%; height:6px; background:#e0e0e0; border-radius:3px; overflow:hidden; }
    #progress-bar { height:100%; width:0%; background:#4caf50; transition:width .4s ease; border-radius:3px; }
    #stage { flex:1; min-height:0; display:flex; align-items:center; justify-content:center; }
    #card { width:min(960px, 100%); background:white; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,.1); padding:14px; }
    .title { font-weight:700; margin-bottom:8px; text-align:center; }
    .oracle { text-align:center; font-size:20px; margin:8px 0; font-weight:700; }
    .row { display:flex; flex-wrap:wrap; gap:6px; margin:6px 0; }
    .pool, .drop { min-height:40px; border:1px solid #ccd; border-radius:8px; padding:8px; display:flex; flex-wrap:wrap; gap:6px; background:#f9fafb; }
    .drop { border-style:dashed; background:#eef7ff; }
    .tile { padding:6px 10px; border:1px solid #aaa; background:white; border-radius:8px; cursor:pointer; user-select:none; font-size:16px; touch-action:none; }
    .tile.dragging { opacity:.8; box-shadow:0 6px 18px rgba(0,0,0,.15); }
    .controls { display:flex; justify-content:center; gap:8px; margin-top:10px; }
    button { padding:10px 16px; border:none; border-radius:10px; background:#1976d2; color:#fff; font-weight:600; cursor:pointer; }
    #result { margin-top:8px; text-align:center; font-weight:700; }
    .success { color:#27ae60; }
    .error { color:#e74c3c; }
    iframe#legacy { width:100%; height:100%; border:none; display:none; }
  </style>
</head>
<body>
  <div class="header">
    <div id="status">üîç –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–¥–∞–Ω–∏—è...</div>
    <div class="scale-controls">
      <div class="scale-btn" id="zoom-out">‚àí</div>
      <div class="scale-value" id="scale-value">1.0</div>
      <div class="scale-btn" id="zoom-in">+</div>
    </div>
  </div>
  <div id="progress-container"><div id="progress-bar"></div></div>
  <div id="stage">
    <div id="card" role="group" aria-live="polite" aria-atomic="true" hidden>
      <div class="title" id="title"></div>
      <div class="oracle" id="oracle" hidden></div>
      <div class="row">
        <div class="pool" id="pool" aria-label="–ü—É–ª —ç–ª–µ–º–µ–Ω—Ç–æ–≤"></div>
      </div>
      <div class="row">
        <div class="drop" id="drop" aria-label="–ü–æ–ª–µ –æ—Ç–≤–µ—Ç–∞"></div>
      </div>
      <div class="controls">
        <button id="check">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
        <button id="reset">–°–±—Ä–æ—Å–∏—Ç—å</button>
      </div>
      <div id="result"></div>
    </div>
    <iframe id="legacy" title="–ó–∞–¥–∞–Ω–∏—è (—Ä–µ–∂–∏–º —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)"></iframe>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/hanzi-writer@3.5/dist/hanzi-writer.min.js"></script>
  <script>
    const statusEl = document.getElementById('status');
    const progressBar = document.getElementById('progress-bar');
    const card = document.getElementById('card');
    const titleEl = document.getElementById('title');
    const oracleEl = document.getElementById('oracle');
    const poolEl = document.getElementById('pool');
    const dropEl = document.getElementById('drop');
    const resultEl = document.getElementById('result');
    const checkBtn = document.getElementById('check');
    const resetBtn = document.getElementById('reset');
    const legacyFrame = document.getElementById('legacy');

    let tasks = [];
    let idx = 0;

    // Pointer Events helpers
    let dragGhost = null; let draggedTile = null; let startParent = null;
    function makeTile(text) {
      const el = document.createElement('div');
      el.className = 'tile';
      el.textContent = text;
      el.tabIndex = 0;
      el.addEventListener('click', () => {
        if (el.parentElement === poolEl) { dropEl.appendChild(el); } else { poolEl.appendChild(el); }
      });
      el.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); el.click(); }
        if (e.key === 'Backspace' && el.parentElement === dropEl) { poolEl.appendChild(el); }
      });
      el.addEventListener('pointerdown', (e) => {
        e.preventDefault();
        draggedTile = el; startParent = el.parentElement;
        el.classList.add('dragging');
        dragGhost = el.cloneNode(true);
        dragGhost.style.position = 'fixed';
        dragGhost.style.pointerEvents = 'none';
        dragGhost.style.opacity = '0.9';
        dragGhost.style.zIndex = '9999';
        dragGhost.classList.add('dragging');
        document.body.appendChild(dragGhost);
        moveGhost(e.clientX, e.clientY);
        window.addEventListener('pointermove', onMove);
        window.addEventListener('pointerup', onUp, { once:true });
      });
      return el;
    }
    function moveGhost(x, y) { if (dragGhost) { dragGhost.style.transform = `translate(${x+6}px, ${y+6}px)`; } }
    function onMove(e) { moveGhost(e.clientX, e.clientY); }
    function isInside(el, x, y) {
      const r = el.getBoundingClientRect();
      return x >= r.left && x <= r.right && y >= r.top && y <= r.bottom;
    }
    function onUp(e) {
      if (dragGhost) { dragGhost.remove(); dragGhost = null; }
      if (draggedTile) {
        draggedTile.classList.remove('dragging');
        if (isInside(dropEl, e.clientX, e.clientY)) {
          dropEl.appendChild(draggedTile);
        } else if (isInside(poolEl, e.clientX, e.clientY)) {
          poolEl.appendChild(draggedTile);
        } else {
          startParent.appendChild(draggedTile);
        }
      }
      draggedTile = null; startParent = null;
      window.removeEventListener('pointermove', onMove);
    }

    function setProgress() {
      const p = tasks.length ? (idx / tasks.length) * 100 : 0;
      progressBar.style.width = `${p}%`;
      try { window.parent && window.parent.postMessage({ type: 'PROGRESS', progress: p }, '*'); } catch {}
    }

    function arraysEqual(a, b) { return a.length === b.length && a.every((v, i) => v === b[i]); }

    function showCard() { card.hidden = false; legacyFrame.style.display = 'none'; }
    function showLegacy(src) { card.hidden = true; legacyFrame.style.display = 'block'; legacyFrame.src = src; }

    function renderTask(t) {
      showCard();
      titleEl.textContent = t.title || '';
      resultEl.textContent = '';
      resultEl.className = '';
      oracleEl.hidden = !t.oracleText;
      if (t.oracleText) oracleEl.textContent = t.oracleText;
      poolEl.innerHTML = ''; dropEl.innerHTML = '';

      if (t.type === 'hanzi-quiz') {
        oracleEl.hidden = false; oracleEl.textContent = '–ù–∞—Ä–∏—Å—É–π—Ç–µ –∏–µ—Ä–æ–≥–ª–∏—Ñ –∏–∑ –Ω–∞–±–æ—Ä–∞';
        poolEl.innerHTML = '';
        dropEl.innerHTML = '';
        const size = t.size || 300;
        const canvas = document.createElement('div');
        canvas.style.width = `${size}px`; canvas.style.height = `${size}px`; canvas.style.margin = '0 auto';
        dropEl.appendChild(canvas);
        const chars = [...new Set((t.charSet || '').split(''))];
        const randomChar = chars[Math.floor(Math.random()*chars.length)] || 'Èõ®';
        const writer = HanziWriter.create(canvas, randomChar, { width:size, height:size, showCharacter:false, showOutline:false, showHintAfterMisses:1, highlightOnComplete:false, padding:5 });
        writer.quiz({ onComplete: () => { resultEl.textContent = '‚úÖ –ì–æ—Ç–æ–≤–æ'; resultEl.className = 'success'; window.parent?.postMessage({ type:'TASK_RESULT', success:true }, '*'); } });
        checkBtn.onclick = null; // –Ω–µ –Ω—É–∂–µ–Ω
        resetBtn.onclick = () => renderTask(t);
        return;
      }

      // assemble
      const shuffled = [...t.pool]; shuffled.sort(() => Math.random() - 0.5);
      shuffled.forEach(ch => poolEl.appendChild(makeTile(ch)));
      checkBtn.onclick = () => {
        const current = Array.from(dropEl.children).map(el => el.textContent);
        if (arraysEqual(current, t.expected)) {
          resultEl.textContent = '‚úÖ –í–µ—Ä–Ω–æ!'; resultEl.className = 'success';
          window.parent?.postMessage({ type:'TASK_RESULT', success:true }, '*');
        } else { resultEl.textContent = '‚ùå –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë'; resultEl.className = 'error'; }
      };
      resetBtn.onclick = () => renderTask(t);
    }

    async function loadJsonTasks() {
      const res = await fetch('tasks.json?_=' + Date.now());
      if (!res.ok) throw new Error('no json');
      const data = await res.json();
      return (data.tasks || []).filter(Boolean);
    }

    async function fallbackToLegacy() {
      // Discover legacy taskN.html
      const existing = [];
      let n = 1;
      const maxN = 200;
      while (n <= maxN) {
        try {
          const url = `task${n}.html?_=${Date.now()}`;
          const resp = await fetch(url, { method:'GET' });
          if (!resp.ok) break;
          existing.push(`task${n}.html`);
          n++;
        } catch { break; }
      }
      if (existing.length === 0) throw new Error('no-legacy');
      // Play legacy inside iframe like old flow
      let i = 0;
      showLegacy(existing[i] + '?_=' + Date.now());
      window.addEventListener('message', (ev) => {
        if (ev.data && ev.data.type === 'TASK_RESULT' && ev.data.success) {
          i++;
          idx = i; setProgress();
          if (i >= existing.length) {
            statusEl.textContent = 'üéâ –£—Ä–æ–∫ –∑–∞–≤–µ—Ä—à—ë–Ω';
            showCard(); card.innerHTML = '<div class="title">–ì–æ—Ç–æ–≤–æ!</div>';
          } else {
            showLegacy(existing[i] + '?_=' + Date.now());
          }
        }
      });
      statusEl.textContent = `‚ñ∂Ô∏è –†–µ–∂–∏–º —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ (${existing.length})`;
      tasks = existing.map(x => ({ legacy:x }));
      setProgress();
    }

    async function start() {
      try {
        tasks = await loadJsonTasks();
        if (!tasks.length) throw new Error('empty');
        statusEl.textContent = `‚úÖ –ù–∞–π–¥–µ–Ω–æ –∑–∞–¥–∞—á: ${tasks.length}`;
        try { window.parent && window.parent.postMessage({ type: 'STATUS', message: statusEl.textContent }, '*'); } catch {}
        idx = 0; setProgress();
        renderTask(tasks[idx]);
        // –Ω–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —É—Å–ø–µ—à–Ω–æ–º—É –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é
        checkBtn.insertAdjacentHTML('afterend', '<button id="next">–î–∞–ª–µ–µ</button>');
        const nextBtn = document.getElementById('next');
        nextBtn.addEventListener('click', () => {
          idx++; setProgress();
          if (idx >= tasks.length) { statusEl.textContent = 'üéâ –£—Ä–æ–∫ –∑–∞–≤–µ—Ä—à—ë–Ω'; card.innerHTML = '<div class="title">–ì–æ—Ç–æ–≤–æ!</div>'; }
          else { renderTask(tasks[idx]); }
        });
      } catch (e) {
        await fallbackToLegacy();
      }
    }

    start();
  </script>
</body>
</html>