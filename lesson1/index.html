<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>–ö—É—Ä—Å: –î—Ä–µ–≤–Ω–µ–∫–∏—Ç–∞–π—Å–∫–∏–µ –æ—Ä–∞–∫—É–ª—å–Ω—ã–µ –Ω–∞–¥–ø–∏—Å–∏</title>
  <style>
    html, body {
      width: 100%;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f8f9fa;
      color: #333;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      padding: 10px;
      gap: 8px;
      width: 100%;
      box-sizing: border-box;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 16px;
      color: #555;
      flex-shrink: 0;
    }

    .scale-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .scale-btn {
      width: 28px;
      height: 28px;
      font-size: 18px;
      line-height: 28px;
      text-align: center;
      background-color: #e0e0e0;
      border-radius: 50%;
      cursor: pointer;
      user-select: none;
    }

    .scale-value {
      min-width: 36px;
      text-align: center;
      font-weight: bold;
    }

    #progress-container {
      width: 100%;
      height: 6px;
      background-color: #e0e0e0;
      border-radius: 3px;
      overflow: hidden;
      flex-shrink: 0;
    }

    #progress-bar {
      height: 100%;
      width: 0%;
      background-color: #4caf50;
      transition: width 0.4s ease;
      border-radius: 3px;
    }

    #task-container {
      flex: 1;
      width: 100%;
      border: none;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease;
      min-height: 0;
      max-height: calc(100vh - 150px);
    }

    #task-container.active {
      opacity: 1;
      visibility: visible;
    }

    #task-frame {
      width: 100%;
      height: 100%;
      border: none;
      transform-origin: center top;
      transform: scale(1);
      transition: transform 0.2s ease;
      overflow: auto;
    }

.controls {
  padding: 12px 0;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 12px;
  flex-wrap: nowrap;
}
    #next-btn {
      padding: 14px 24px;
      font-size: 18px;
      font-weight: 600;
      color: white;
      background-color: #1976d2;
      border: none;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      transition: background-color 0.2s ease, transform 0.1s ease;
      width: 90%;
      max-width: 300px;
    }

    #next-btn:active {
      transform: scale(0.98);
    }

    #next-btn:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
      transform: none;
    }

    #skip-btn {
      padding: 14px 24px;
      font-size: 18px;
      font-weight: 600;
      color: white;
      background-color: #ff9800;
      border: none;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      transition: background-color 0.2s ease, transform 0.1s ease;
      width: 90%;
      max-width: 300px;
      margin-top: 8px;
    }

    #skip-btn:active {
      transform: scale(0.98);
    }

    #skip-btn:hover {
      background-color: #f57c00;
    }

    .hidden-iframe {
      position: absolute;
      top: -9999px;
      left: -9999px;
      width: 1px;
      height: 1px;
      border: none;
    }

    #status {
      font-size: 16px;
      text-align: center;
      color: #555;
    }

    /* –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è */
    @media (max-width: 768px) {
      #task-container {
        max-height: calc(100vh - 180px);
      }
      
      .controls {
        padding: 8px 0;
      }
      
      #next-btn, #skip-btn {
  padding: 14px 24px;
  font-size: 18px;
  font-weight: 600;
  color: white;
  border: none;
  border-radius: 12px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  cursor: pointer;
  transition: background-color 0.2s ease, transform 0.1s ease;
  max-width: 300px;
  flex: 1;
  min-width: 150px;
}
    }
  </style>
</head>
<body>
  <div class="header">
    <div id="status">üîç –ü–æ–∏—Å–∫ –∑–∞–¥–∞–Ω–∏–π...</div>
    <div class="scale-controls">
      <div class="scale-btn" id="zoom-out">‚àí</div>
      <div class="scale-value" id="scale-value">1.0</div>
      <div class="scale-btn" id="zoom-in">+</div>
    </div>
  </div>

  <div id="progress-container">
    <div id="progress-bar"></div>
  </div>

  <!-- iframe —Å–∫—Ä—ã—Ç –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–æ–∏—Å–∫–∞ -->
  <div id="task-container">
    <iframe id="task-frame" src="about:blank" frameborder="0" allowfullscreen></iframe>
  </div>

  <div class="controls">
    <button id="next-btn" disabled>–°–ª–µ–¥—É—é—â–µ–µ –∑–∞–¥–∞–Ω–∏–µ</button>
    <button id="skip-btn">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ</button>
  </div>

<script type="module">
  // === üî¢ –ù–û–ú–ï–† –£–†–û–ö–ê (—É—Å—Ç–∞–Ω–æ–≤–∏ –≤—Ä—É—á–Ω—É—é –¥–ª—è –∫–∞–∂–¥–æ–π –ø–∞–ø–∫–∏) ===
  const LESSON = 1; // –ù–∞–ø—Ä–∏–º–µ—Ä: lesson1 ‚Üí 1, lesson2 ‚Üí 2

  // === üî• –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ö FIREBASE ===
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js';
  import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js';
  import { getFirestore, doc, getDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js';

  const firebaseConfig = {
    apiKey: "AIzaSyBvyxPtx5PICYk60HUCERw5Cxh1TyCcZCY",
    authDomain: "antient-9bff0.firebaseapp.com",
    projectId: "antient-9bff0",
    storageBucket: "antient-9bff0.firebasestorage.app",
    messagingSenderId: "311792589414",
    appId: "1:311792589414:web:5fff3154735007c2006ba7",
    measurementId: "G-W4ZQXWRTKK"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  let currentUser = null;
  let totalEarnedForLesson = 0;

  // –°–ª–µ–¥–∏–º –∑–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
  onAuthStateChanged(auth, (user) => {
    if (user) {
      currentUser = user;
      console.log('üîê –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:', user.displayName);
    } else {
      alert("–î–ª—è –¥–æ—Å—Ç—É–ø–∞ –Ω—É–∂–Ω–æ –≤–æ–π—Ç–∏");
      window.location.href = "../index.html";
    }
  });

  // === üìö –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ª–æ–≤–∞—Ä—å –∏ –ø–æ–ª—É—á–∞–µ–º –∏–µ—Ä–æ–≥–ª–∏—Ñ—ã —É—Ä–æ–∫–∞ ===
  let lessonwords = [];

  async function loadDictionary() {
    try {
      const response = await fetch('./../dictionary.js');
      const scriptText = await response.text();

      // –°–æ–∑–¥–∞—ë–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç, —á—Ç–æ–±—ã –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∫–æ–¥
      const script = document.createElement('script');
      script.textContent = scriptText;
      document.head.appendChild(script);
      document.head.removeChild(script);

      if (typeof charData === 'undefined') {
        throw new Error('charData not found in dictionary.js');
      }

      // –§–∏–ª—å—Ç—Ä—É–µ–º –∏–µ—Ä–æ–≥–ª–∏—Ñ—ã –ø–æ —É—Ä–æ–∫—É
      lessonwords = Object.keys(charData).filter(key => {
        const data = charData[key];
        return data.lesson === LESSON && key.length === 1;
      });

      if (lessonwords.length === 0) {
        throw new Error(`–ù–µ—Ç –∏–µ—Ä–æ–≥–ª–∏—Ñ–æ–≤ –¥–ª—è —É—Ä–æ–∫–∞ ${LESSON}`);
      }

      console.log(`üìö –£—Ä–æ–∫ ${LESSON}: –Ω–∞–π–¥–µ–Ω–æ ${lessonwords.length} –∏–µ—Ä–æ–≥–ª–∏—Ñ–æ–≤`, lessonwords);
    } catch (e) {
      console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–æ–≤–∞—Ä—è:", e);
      statusEl.innerHTML = `‚ùå –û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ª–æ–≤–∞—Ä—å –∏–µ—Ä–æ–≥–ª–∏—Ñ–æ–≤.`;
    }
  }

  // === ‚úÖ –§—É–Ω–∫—Ü–∏—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–∞–ª–ª–æ–≤ ===
  async function addPoints(points, reason) {
    if (!currentUser) return;
    try {
      const userRef = doc(db, 'users', currentUser.uid);
      const userSnap = await getDoc(userRef);
      const currentPoints = userSnap.exists() ? (userSnap.data().points || 0) : 0;
      const newPoints = currentPoints + points;
      await updateDoc(userRef, { points: newPoints });
      totalEarnedForLesson += points;
      console.log(`[–ë–∞–ª–ª—ã] ${points} (${reason}) ‚Üí –≤—Å–µ–≥–æ –≤ —É—Ä–æ–∫–µ: ${totalEarnedForLesson}`);
    } catch (e) {
      console.error("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–ª—ã:", e);
    }
  }

  // === üß© –û–°–ù–û–í–ù–û–ô –ö–û–î –ö–í–ò–ó–ê ===
  let tasks = [];
  let currentTaskIndex = 0;
  let currentScale = 1.0;
  const minScale = 0.25;
  const maxScale = 2.0;
  const scaleStep = 0.1;

  const iframe = document.getElementById("task-frame");
  const statusEl = document.getElementById("status");
  const nextBtn = document.getElementById("next-btn");
  const skipBtn = document.getElementById("skip-btn");
  const progressBar = document.getElementById("progress-bar");
  const scaleValueEl = document.getElementById("scale-value");
  const zoomInBtn = document.getElementById("zoom-in");
  const zoomOutBtn = document.getElementById("zoom-in");

  let hasProcessedHanzi = false;
  let discoveryCompleted = false;

  function shuffleArray(array) {
    const arr = [...array];
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  function checkTaskIsValid(n) {
    return new Promise((resolve) => {
      const filename = `tasks/task${n}.html`;
      const frame = document.createElement("iframe");
      frame.classList.add("hidden-iframe");
      frame.setAttribute("data-check", n);

      let responded = false;
      let timeoutId;

      function onMessage(event) {
        const frameN = parseInt(frame.getAttribute("data-check"));
        if (event.data.type === "TASK_EXISTS" && event.data.valid) {
          if (!responded && frameN === n) {
            responded = true;
            clearTimeout(timeoutId);
            document.body.removeChild(frame);
            window.removeEventListener("message", onMessage);
            resolve({ exists: true, n });
          }
        }
      }

      window.addEventListener("message", onMessage);

      timeoutId = setTimeout(() => {
        if (!responded) {
          document.body.removeChild(frame);
          window.removeEventListener("message", onMessage);
          resolve({ exists: false, n });
        }
      }, 3000);

      frame.onload = () => {
        try {
          if (frame.contentDocument && frame.contentDocument.title === "404 Not Found") {
            if (!responded) {
              clearTimeout(timeoutId);
              document.body.removeChild(frame);
              window.removeEventListener("message", onMessage);
              resolve({ exists: false, n });
            }
          }
        } catch (e) {}
      };

      frame.onerror = () => {
        if (!responded) {
          clearTimeout(timeoutId);
          document.body.removeChild(frame);
          window.removeEventListener("message", onMessage);
          resolve({ exists: false, n });
        }
      };

      frame.src = filename + "?_=" + Date.now();
      document.body.appendChild(frame);
    });
  }

  async function discoverTasks() {
    const existingTasks = [];
    let n = 1;

    statusEl.textContent = "üîç –ò—â–µ–º –∑–∞–¥–∞–Ω–∏—è...";

    while (true) {
      const result = await checkTaskIsValid(n);
      if (result.exists) {
        existingTasks.push(`tasks/task${n}.html`);
        n++;
      } else {
        break;
      }
      if (n > 200) break;
    }

    if (existingTasks.length === 0) {
      statusEl.innerHTML = `
        ‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ <strong>–Ω–∞—Å—Ç–æ—è—â–µ–≥–æ</strong> –∑–∞–¥–∞–Ω–∏—è.<br>
        –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∫–∞–∂–¥—ã–π <code>taskN.html</code> –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç:<br>
        <code>window.parent.postMessage({ type: "TASK_EXISTS", valid: true }, "*");</code>
      `;
      return;
    }

    tasks = shuffleArray(existingTasks);
    discoveryCompleted = true;
    statusEl.textContent = `‚úÖ –ù–∞–π–¥–µ–Ω–æ ${tasks.length} –∑–∞–¥–∞–Ω–∏–π.`;
    updateProgress();
    document.getElementById("task-container").classList.add("active");

    if (isMobile()) setScale(1);
    loadTask(0);
  }

  function loadTask(index) {
    if (index >= tasks.length) {
      iframe.style.display = "none";
      nextBtn.disabled = true;
      skipBtn.disabled = true;

      statusEl.innerHTML = `<div style="text-align: center;">
        <h2>üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!</h2>
        <p>–í—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–∏–ª–∏ —É—Ä–æ–∫!</p>
        <p><strong>+10 –±–∞–ª–ª–æ–≤ –∑–∞ –ø–æ–ª–Ω–æ–µ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ!</strong></p>
        <div id="fireworks" style="width: 100%; height: 200px; position: relative; background: #0000; border-radius: 8px; margin: 10px 0;"></div>
      </div>`;

      addPoints(10, `—É—Å–ø–µ—à–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —É—Ä–æ–∫–∞ ${window.location.pathname.split('/')[1]}`);
      createFireworks();

      setTimeout(() => {
        window.location.href = "../";
      }, 5000);

      updateProgress();
      return;
    }

    hasProcessedHanzi = false;
    const url = tasks[index] + "?_=" + Date.now();
    iframe.src = url;
    updateProgress();
    nextBtn.disabled = true;
    currentTaskIndex = index;
  }

  function updateProgress() {
    const progress = tasks.length > 0 ? (currentTaskIndex / tasks.length) * 100 : 0;
    progressBar.style.width = `${progress}%`;
  }

  function setScale(scale) {
    currentScale = scale;
    iframe.style.transform = `scale(${currentScale})`;
    scaleValueEl.textContent = currentScale.toFixed(1);
  }

  zoomInBtn.addEventListener("click", () => {
    if (currentScale < maxScale) {
      setScale(Math.round((currentScale + scaleStep) * 10) / 10);
    }
  });

  zoomOutBtn.addEventListener("click", () => {
    if (currentScale > minScale) {
      setScale(Math.round((currentScale - scaleStep) * 10) / 10);
    }
  });

  function isMobile() {
    return window.innerWidth <= 768 || (navigator.maxTouchPoints && navigator.maxTouchPoints > 1);
  }

  // === üéØ –û–ë–†–ê–ë–û–¢–ö–ê –°–û–û–ë–©–ï–ù–ò–ô –û–¢ –ó–ê–î–ê–ù–ò–ô ===
  window.addEventListener("message", async (event) => {
    const { type, success } = event.data;

    if (type === "DO_HANZI" && !hasProcessedHanzi && discoveryCompleted && lessonwords.length > 0) {
      hasProcessedHanzi = true;
      const randomChar = lessonwords[Math.floor(Math.random() * lessonwords.length)];
      const newSrc = `${tasks[currentTaskIndex]}?_=${Date.now()}#${randomChar}`;
      iframe.src = '';
      setTimeout(() => { iframe.src = newSrc; }, 10);
      nextBtn.disabled = true;
      return;
    }

    if (type === "TASK_RESULT") {
      if (success) {
        statusEl.textContent = "‚úÖ –ó–∞–¥–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ!";
        nextBtn.disabled = false;
        addPoints(5, `—É—Å–ø–µ—à–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ ${tasks[currentTaskIndex]}`);
      } else {
        statusEl.textContent = "‚ùå –û—à–∏–±–∫–∞ –∏–ª–∏ –ø—Ä–æ–ø—É—Å–∫";
        nextBtn.disabled = false;
        addPoints(-4, `–æ—à–∏–±–∫–∞ –∏–ª–∏ –ø—Ä–æ–ø—É—Å–∫ –≤ ${tasks[currentTaskIndex]}`);
      }
    }
  });

  // === ‚è≠Ô∏è –ö–Ω–æ–ø–∫–∏ ===
  nextBtn.addEventListener("click", () => {
    currentTaskIndex++;
    loadTask(currentTaskIndex);
  });

  skipBtn.addEventListener("click", () => {
    addPoints(-4, `–ø—Ä–æ–ø—É—Å–∫ –∑–∞–¥–∞–Ω–∏—è ${tasks[currentTaskIndex]}`);
    currentTaskIndex++;
    loadTask(currentTaskIndex);
  });

  // === üéÜ –ê–Ω–∏–º–∞—Ü–∏—è —Ñ–µ–π–µ—Ä–≤–µ—Ä–∫–æ–≤ ===
  function createFireworks() {
    const container = document.getElementById("fireworks");
    const colors = ["#FF0000", "#00FF00", "#0000FF", "#FFFF00", "#FF00FF", "#00FFFF", "#FFA500", "#FFFFFF"];
    const particles = 50;

    function createExplosion(x, y) {
      for (let i = 0; i < particles; i++) {
        const particle = document.createElement("div");
        const angle = Math.random() * Math.PI * 2;
        const speed = 1 + Math.random() * 3;
        const size = 2 + Math.random() * 4;

        particle.style.position = "absolute";
        particle.style.width = `${size}px`;
        particle.style.height = `${size}px`;
        particle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        particle.style.borderRadius = "50%";
        particle.style.boxShadow = "0 0 6px currentColor";
        particle.style.left = `${x}px`;
        particle.style.top = `${y}px`;
        particle.style.pointerEvents = "none";

        container.appendChild(particle);

        let dx = Math.cos(angle) * speed;
        let dy = Math.sin(angle) * speed;
        let opacity = 1;
        let posX = x;
        let posY = y;

        const animate = () => {
          opacity -= 0.02;
          posX += dx;
          posY += dy + 0.1;
          dy += 0.05;

          particle.style.opacity = opacity;
          particle.style.left = `${posX}px`;
          particle.style.top = `${posY}px`;

          if (opacity > 0) {
            requestAnimationFrame(animate);
          } else {
            container.removeChild(particle);
          }
        };

        requestAnimationFrame(animate);
      }
    }

    setInterval(() => {
      const x = 50 + Math.random() * (container.offsetWidth - 100);
      const y = 100 + Math.random() * (container.offsetHeight - 100);
      createExplosion(x, y);
    }, 400);
  }

  // === üöÄ –ó–ê–ü–£–°–ö ===
  loadDictionary().then(() => {
    discoverTasks();
  });
</script>
</body>
</html>