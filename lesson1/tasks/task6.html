<!DOCTYPE html>
<html lang="ru">
<head>
    <link rel="stylesheet" href="../../tasks.css">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Собери перевод</title>
</head>
<body>

  <h2>Собери перевод</h2>

  <div class="instructions">
    <p><strong>Кликайте по словам</strong>, чтобы добавить их в перевод.</p>
    <p>Клик по слову в поле — удалит его.</p>
  </div>

  <div class="task-container">
    <div class="task-title">1. 不其雨</div>
    <div class="oracle-text">不其雨</div>
    <div id="word-pool1" class="word-pool"></div>
    <div id="drop-area1" class="drop-area"></div>
  </div>

  <div class="task-container">
    <div class="task-title">2. 貞不雨</div>
    <div class="oracle-text">貞不雨</div>
    <div id="word-pool2" class="word-pool"></div>
    <div id="drop-area2" class="drop-area"></div>
  </div>

  <div class="controls">
    <button id="check-btn">Проверить</button>
    <button id="reset-btn">Сбросить</button>
  </div>

  <p id="result"></p>

  <script>
    const expected1 = [
      ['не', 'будет', 'дождя'],
      ['не', 'пойдёт', 'дождь'],
      ['дождя', 'не', 'будет'],
      ['дождь', 'не', 'пойдёт'],
      ['не', 'будет', 'дождь'],
      ['не', 'пойдёт', 'дождя']
    ];
    
    const expected2 = [
      ['спрашивали', 'не', 'будет', 'дождя'],
      ['гадали', 'не', 'пойдёт', 'дождь'],
      ['спрашивали', 'дождя', 'не', 'будет'],
      ['гадали', 'дождь', 'не', 'пойдёт'],
      ['спрашивали', 'не', 'пойдёт', 'дождь'],
      ['гадали', 'не', 'будет', 'дождя']
    ];

    const words1 = ['не', 'будет', 'пойдёт', 'дождя', 'дождь', 'возможно', 'может', 'ли', 'дождливо'];
    const words2 = ['спрашивали', 'гадали', 'не', 'будет', 'пойдёт', 'дождя', 'дождь', 'задавали', 'предсказывали'];

    const wordPool1 = document.getElementById('word-pool1');
    const wordPool2 = document.getElementById('word-pool2');
    const dropArea1 = document.getElementById('drop-area1');
    const dropArea2 = document.getElementById('drop-area2');
    const checkBtn = document.getElementById('check-btn');
    const resetBtn = document.getElementById('reset-btn');
    const resultEl = document.getElementById('result');

    function createWordBox(word, pool, dropArea) {
      const box = document.createElement('div');
      box.className = 'word-box';
      box.textContent = word;
      box.onclick = () => {
        box.remove();
        const clone = box.cloneNode(true);
        clone.onclick = () => { clone.remove(); updatePlaceholder(dropArea); };
        dropArea.appendChild(clone);
        updatePlaceholder(dropArea);
      };
      pool.appendChild(box);
    }

    function updatePlaceholder(dropArea) {
      const hasWords = dropArea.children.length > 0 && !Array.from(dropArea.children).some(el => el.textContent.includes('[пусто]'));
      if (!hasWords && dropArea.children.length === 0) {
        dropArea.innerHTML = '';
        const placeholder = document.createElement('span');
        placeholder.style.color = '#999';
        placeholder.style.fontStyle = 'italic';
        placeholder.textContent = '[пусто]';
        dropArea.appendChild(placeholder);
      }
    }

    function init() {
      wordPool1.innerHTML = '';
      wordPool2.innerHTML = '';
      dropArea1.innerHTML = '';
      dropArea2.innerHTML = '';
      resultEl.style.display = 'none';
      updatePlaceholder(dropArea1);
      updatePlaceholder(dropArea2);

      const shuffled1 = [...words1].sort(() => Math.random() - 0.5);
      const shuffled2 = [...words2].sort(() => Math.random() - 0.5);

      shuffled1.forEach(word => createWordBox(word, wordPool1, dropArea1));
      shuffled2.forEach(word => createWordBox(word, wordPool2, dropArea2));
    }

    function getWords(dropArea) {
      return Array.from(dropArea.children)
        .filter(el => !el.textContent.includes('[пусто]'))
        .map(el => el.textContent.trim());
    }

    checkBtn.addEventListener('click', () => {
      const current1 = getWords(dropArea1);
      const current2 = getWords(dropArea2);

      const isCorrect1 = expected1.some(option => arraysEqual(current1, option));
      const isCorrect2 = expected2.some(option => arraysEqual(current2, option));

      if (isCorrect1 && isCorrect2) {
        resultEl.innerHTML = `✅ <b>Верно!</b>`;
        resultEl.className = 'message success';
        resultEl.style.display = 'block';
        sendResult(true);
      } else {
        let message = '❌ Ошибки в переводе.';
        if (isCorrect1 && !isCorrect2) message = '❌ Второй неверен.';
        else if (!isCorrect1 && isCorrect2) message = '❌ Первый неверен.';
        resultEl.textContent = message;
        resultEl.className = 'message error';
        resultEl.style.display = 'block';
        sendResult(false, 'Ошибка в порядке слов');
      }
    });

    resetBtn.addEventListener('click', init);

    function arraysEqual(a, b) {
      if (a.length !== b.length) return false;
      for (let i = 0; i < a.length; i++) {
        if (a[i] !== b[i]) return false;
      }
      return true;
    }

    function sendResult(success, message) {
      window.parent.postMessage({
        type: "TASK_RESULT",
        success: !!success,
        message: message || (success ? "Верно" : "Ошибка")
      }, "*");
    }

    // Инициализация при загрузке
    window.onload = init;

    // Сигнал о существовании задания
    window.parent.postMessage({ type: "TASK_EXISTS", valid: true }, "*");
  </script>
</body>
</html>

