#!/bin/bash

# –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É backup, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
echo "üîÑ –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–ø–∫–∏ backup..."
mkdir -p backup

# –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ task*.html —Ñ–∞–π–ª—ã –≤ –ø–∞–ø–∫—É backup
echo "üíæ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –≤ backup..."
cp task*.html backup/ 2>/dev/null || echo "‚ö†Ô∏è –ù–µ –Ω–∞–π–¥–µ–Ω–æ —Ñ–∞–π–ª–æ–≤ task*.html –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è"

# –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—ã–π HTML-—Ñ–∞–π–ª
echo "üßπ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤ task*.html..."

for file in task*.html; do
  # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ñ–∞–π–ª
  if [[ ! -f "$file" ]]; then
    echo "‚ùå –§–∞–π–ª—ã task*.html –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
    continue
  fi

  echo "üìù –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–∞: $file"

  # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ —É–∂–µ —Å—Å—ã–ª–∫—É –Ω–∞ tasks.css
  if grep -q "tasks\.css" "$file"; then
    echo "‚úÖ $file —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç tasks.css ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º"
    continue
  fi

  # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç—å –∫ tasks.css –∫–∞–∫ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å –Ω–∞ —É—Ä–æ–≤–µ–Ω—å –≤—ã—à–µ
  css_path="../../tasks.css"

  # –£–¥–∞–ª—è–µ–º –±–ª–æ–∫ <style>...</style> –∏ –≤—Å—Ç–∞–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ ../tasks.css
  if grep -q "<style>" "$file"; then
    sed -i.bak -E '
      /<style>/,/<\/style>/{
        /<head>/!{
          /<style>/,/<\/style>/d
        }
      }
      /<head>/a\
    <link rel="stylesheet" href="'"$css_path"'">
    ' "$file"

    # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –±—ç–∫–∞–ø –æ—Ç sed
    rm -f "$file.bak"

    echo "‚ú® $file –æ–±–Ω–æ–≤–ª–µ–Ω: –¥–æ–±–∞–≤–ª–µ–Ω–∞ —Å—Å—ã–ª–∫–∞ –Ω–∞ ../tasks.css"
  else
    # –ï—Å–ª–∏ –Ω–µ—Ç <style>, –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É
    sed -i.bak '/<head>/a\
  <link rel="stylesheet" href="'"$css_path"'">\
' "$file"
    rm -f "$file.bak"
    echo "üîó $file: –¥–æ–±–∞–≤–ª–µ–Ω–∞ —Å—Å—ã–ª–∫–∞ –Ω–∞ ../tasks.css (–Ω–µ –±—ã–ª–æ —Å—Ç–∏–ª–µ–π)"
  fi
done

echo "‚úÖ –ì–æ—Ç–æ–≤–æ! –í—Å–µ —Ñ–∞–π–ª—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è ../tasks.css"
echo "üìÇ –†–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –ø–∞–ø–∫–µ ./backup/"