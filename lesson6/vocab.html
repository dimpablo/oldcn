<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–≤–∏–∑ –ø–æ –∫–∏—Ç–∞–π—Å–∫–∏–º –∏–µ—Ä–æ–≥–ª–∏—Ñ–∞–º</title>
    <script src="../dictionary.js"></script>
    <link rel="stylesheet" type="text/css" href="../vocab.css">
</head>
<body>
    <div class="container">
        <h1>–°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –∏–µ—Ä–æ–≥–ª–∏—Ñ–æ–≤</h1>
        
        <div class="controls">
            <div id="status" class="status">–°–æ–ø–æ—Å—Ç–∞–≤—å—Ç–µ –∏–µ—Ä–æ–≥–ª–∏—Ñ—ã</div>
        </div>
        
        <div class="matching-container">
            <div class="column" id="leftColumn"></div>
            <div class="column" id="rightColumn"></div>
        </div>
        
        <div class="progress">
            <div id="progressBar" class="progress-bar"></div>
        </div>
        
        <button id="nextBtn" class="btn">–°–ª–µ–¥—É—é—â–µ–µ –∑–∞–¥–∞–Ω–∏–µ</button>
        
        <div class="feedback correct-feedback" id="correctFeedback">‚úì –í–µ—Ä–Ω–æ! +1 –±–∞–ª–ª</div>
        <div class="feedback incorrect-feedback" id="incorrectFeedback">‚úó –ù–µ–≤–µ—Ä–Ω–æ -1 –±–∞–ª–ª</div>
    </div>

    <script>
        // === –ù–ê–°–¢–†–û–ô–ö–ê –£–†–û–ö–ê ===
        const LESSON = 6;
        
        // === FIREBASE INIT ===
        let db = null;
        let auth = null;
        let currentUser = null;
        let updateDocRef = null;
        let docRef = null;

        async function initFirebase() {
            try {
                const [{ initializeApp }, { getAuth, onAuthStateChanged }, { getFirestore }, { updateDoc, doc }] = await Promise.all([
                    import('https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js'),
                    import('https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js'),
                    import('https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js'),
                    import('https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js')
                ]);

                const firebaseConfig = {
                    apiKey: "AIzaSyBvyxPtx5PICYk60HUCERw5Cxh1TyCcZCY",
                    authDomain: "antient-9bff0.firebaseapp.com",
                    projectId: "antient-9bff0",
                    storageBucket: "antient-9bff0.firebasestorage.app",
                    messagingSenderId: "311792589414",
                    appId: "1:311792589414:web:5fff3154735007c2006ba7",
                    measurementId: "G-W4ZQXWRTKK"
                };

                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                updateDocRef = updateDoc;
                docRef = doc;

                onAuthStateChanged(auth, (user) => {
                    currentUser = user;
                    console.log('üîê –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:', user ? user.displayName : '–Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
                });
            } catch (e) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase:", e);
            }
        }

        // === –û–ó–í–£–ß–ö–ê ===
        function playHanziSound(hanzi) {
            const data = charData[hanzi];
            if (!data || !data.pinyin) return;

            let cleanPinyin = data.pinyin
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .replace(/√º/g, 'u')
                .replace(/v/g, 'u');

            let tone = '1';
            if (data.pinyin.includes('ƒÅ')) tone = '1';
            else if (data.pinyin.includes('√°')) tone = '2';
            else if (data.pinyin.includes('«é')) tone = '3';
            else if (data.pinyin.includes('√†')) tone = '4';

            const pinyinKey = cleanPinyin + tone;
            const url = `https://data.dong-chinese.com/pinyin/b/${pinyinKey}.mp3`;
            const audio = new Audio(url);

            audio.play().catch(e => {
                console.warn(`üîá –ù–µ—Ç –∑–≤—É–∫–∞ –¥–ª—è ${hanzi}`);
            });
        }

        // === –°–ò–°–¢–ï–ú–ê –ë–ê–õ–õ–û–í ===
        async function updateUserPoints(pointsChange) {
            if (!db || !currentUser || !updateDocRef || !docRef) {
                console.warn("Firebase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω, –±–∞–ª–ª—ã –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã");
                return;
            }

            try {
                const userRef = docRef(db, 'users', currentUser.uid);
                await updateDocRef(userRef, {
                    points: (currentUser.points || 0) + pointsChange
                });
                
                if (currentUser.points === undefined) currentUser.points = 0;
                currentUser.points += pointsChange;
                console.log(`[–ë–∞–ª–ª—ã] –ò–∑–º–µ–Ω–µ–Ω–∏–µ: ${pointsChange}. –¢–µ–ø–µ—Ä—å: ${currentUser.points}`);
            } catch (e) {
                console.error("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –±–∞–ª–ª—ã –≤ Firestore:", e);
            }
        }

        // === –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê –ö–í–ò–ó–ê ===
        let selectedLeft = null;
        let selectedRight = null;
        let matchedPairs = 0;
        let totalPairs = 0;
        let leftItems = [];
        let rightItems = [];
        let allLessonChars = [];
        
        // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ –∫–∞–∂–¥–æ–º—É –∏–µ—Ä–æ–≥–ª–∏—Ñ—É
        let charProgress = {};
        let currentTaskType = ''; // 'pinyin' –∏–ª–∏ 'meaning'
        let currentChars = [];

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', async function() {
            await initFirebase();
            
            // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∏–µ—Ä–æ–≥–ª–∏—Ñ—ã —É—Ä–æ–∫–∞
            allLessonChars = Object.keys(charData).filter(char => 
                charData[char].lesson === LESSON
            );
            
            totalPairs = allLessonChars.length * 2; // –ö–∞–∂–¥—ã–π –∏–µ—Ä–æ–≥–ª–∏—Ñ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –¥–≤–∞–∂–¥—ã
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–µ—Ä–æ–≥–ª–∏—Ñ–∞
            allLessonChars.forEach(char => {
                charProgress[char] = {
                    pinyin: false,
                    meaning: false
                };
            });
            
            loadTask();
            
            document.getElementById('nextBtn').addEventListener('click', loadTask);
        });
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞–Ω–∏—è
        function loadTask() {
            selectedLeft = null;
            selectedRight = null;
            matchedPairs = 0;
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–∏–ø—ã –∑–∞–¥–∞–Ω–∏–π
            const remainingPinyin = allLessonChars.filter(char => !charProgress[char].pinyin);
            const remainingMeaning = allLessonChars.filter(char => !charProgress[char].meaning);
            
            if (remainingPinyin.length === 0 && remainingMeaning.length === 0) {
                // –í—Å–µ –∏–µ—Ä–æ–≥–ª–∏—Ñ—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–∑—É—á–µ–Ω—ã
                document.getElementById('status').textContent = '–í—Å–µ –∏–µ—Ä–æ–≥–ª–∏—Ñ—ã —É—Ä–æ–∫–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–∑—É—á–µ–Ω—ã!';
                document.getElementById('leftColumn').innerHTML = '';
                document.getElementById('rightColumn').innerHTML = '';
                document.getElementById('progressBar').style.width = '100%';
                document.getElementById('nextBtn').disabled = true;
                return;
            }
            
            // –°–õ–£–ß–ê–ô–ù–´–ô –í–´–ë–û–† —Ç–∏–ø–∞ –∑–∞–¥–∞–Ω–∏—è
            const availableTypes = [];
            if (remainingPinyin.length > 0) availableTypes.push('pinyin');
            if (remainingMeaning.length > 0) availableTypes.push('meaning');
            
            // –°–ª—É—á–∞–π–Ω–æ –≤—ã–±–∏—Ä–∞–µ–º —Ç–∏–ø –∑–∞–¥–∞–Ω–∏—è –∏–∑ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö
            const randomTypeIndex = Math.floor(Math.random() * availableTypes.length);
            currentTaskType = availableTypes[randomTypeIndex];
            
            const remainingChars = currentTaskType === 'pinyin' ? remainingPinyin : remainingMeaning;
            
            // –ë–µ—Ä–µ–º 5 —Å–ª—É—á–∞–π–Ω—ã—Ö –∏–∑ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è (–∏–ª–∏ –º–µ–Ω—å—à–µ, –µ—Å–ª–∏ –æ—Å—Ç–∞–ª–æ—Å—å –º–µ–Ω—å—à–µ 5)
            const count = Math.min(5, remainingChars.length);
            currentChars = getRandomCharacters(remainingChars, count);
            
            createColumns(currentChars);
            updateProgress();
            updateStatus();
            

        }
        
        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ª—É—á–∞–π–Ω—ã—Ö –∏–µ—Ä–æ–≥–ª–∏—Ñ–æ–≤
        function getRandomCharacters(charArray, count) {
            const selectedChars = [];
            const tempArray = [...charArray];
            
            for (let i = 0; i < count; i++) {
                const randomIndex = Math.floor(Math.random() * tempArray.length);
                const char = tempArray[randomIndex];
                selectedChars.push({
                    char: char,
                    pinyin: charData[char].pinyin,
                    meaning: charData[char].meaning
                });
                tempArray.splice(randomIndex, 1);
            }
            
            return selectedChars;
        }
        
        // –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–ª–æ–Ω–æ–∫
        function createColumns(chars) {
            const leftColumn = document.getElementById('leftColumn');
            const rightColumn = document.getElementById('rightColumn');
            
            leftColumn.innerHTML = '';
            rightColumn.innerHTML = '';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç–∞—Ç—É—Å–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –∑–∞–¥–∞–Ω–∏—è
            const statusText = currentTaskType === 'pinyin' ? 
                '–°–æ–ø–æ—Å—Ç–∞–≤—å—Ç–µ –∏–µ—Ä–æ–≥–ª–∏—Ñ—ã —Å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–µ–π' : 
                '–°–æ–ø–æ—Å—Ç–∞–≤—å—Ç–µ –∏–µ—Ä–æ–≥–ª–∏—Ñ—ã —Å–æ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏';
            document.getElementById('status').textContent = statusText;
            
            // –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –∏–µ—Ä–æ–≥–ª–∏—Ñ—ã
            leftItems = [];
            chars.forEach(charData => {
                const item = document.createElement('div');
                item.className = 'item';
                item.innerHTML = `<div class="character">${charData.char}</div>`;
                item.dataset.char = charData.char;
                item.dataset.matched = 'false';
                item.addEventListener('click', () => {
                    selectItem(item, 'left');
                    playHanziSound(charData.char);
                });
                leftColumn.appendChild(item);
                leftItems.push(item);
            });
            
            // –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ç–∏–ø (–ª–∏–±–æ pinyin, –ª–∏–±–æ meaning)
            rightItems = [];
            const shuffledChars = [...chars].sort(() => Math.random() - 0.5);
            
            shuffledChars.forEach(charData => {
                const item = document.createElement('div');
                item.className = 'item';
                
                if (currentTaskType === 'pinyin') {
                    item.innerHTML = `<div class="pinyin">${charData.pinyin}</div>`;
                    item.dataset.pinyin = charData.pinyin;
                    item.dataset.type = 'pinyin';
                } else {
                    item.innerHTML = `<div class="meaning">${charData.meaning}</div>`;
                    item.dataset.meaning = charData.meaning;
                    item.dataset.type = 'meaning';
                }
                
                item.dataset.char = charData.char;
                item.dataset.matched = 'false';
                item.addEventListener('click', () => selectItem(item, 'right'));
                rightColumn.appendChild(item);
                rightItems.push(item);
            });
        }
        
        // –í—ã–±–æ—Ä —ç–ª–µ–º–µ–Ω—Ç–∞
        function selectItem(item, column) {
            if (item.dataset.matched === 'true') return;
            
            if (column === 'left') {
                if (selectedLeft) {
                    selectedLeft.classList.remove('selected');
                }
                selectedLeft = item;
                item.classList.add('selected');
                
                if (selectedRight) {
                    checkMatch();
                }
            } else {
                if (selectedRight) {
                    selectedRight.classList.remove('selected');
                }
                selectedRight = item;
                item.classList.add('selected');
                
                if (selectedLeft) {
                    checkMatch();
                }
            }
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è
        function checkMatch() {
            const leftChar = selectedLeft.dataset.char;
            let isMatch = false;
            
            if (currentTaskType === 'pinyin') {
                isMatch = (charData[leftChar].pinyin === selectedRight.dataset.pinyin);
            } else {
                isMatch = (charData[leftChar].meaning === selectedRight.dataset.meaning);
            }
            
            if (isMatch) {
                showFeedback(true);
                updateUserPoints(1); // +1 –±–∞–ª–ª –∑–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
                
                selectedLeft.dataset.matched = 'true';
                selectedRight.dataset.matched = 'true';
                selectedLeft.classList.remove('selected');
                selectedLeft.classList.add('matched');
                selectedRight.classList.remove('selected');
                selectedRight.classList.add('matched');
                
                matchedPairs++;
                
                // –ï—Å–ª–∏ –≤—Å–µ –ø–∞—Ä—ã –≤ —Ç–µ–∫—É—â–µ–º –∑–∞–¥–∞–Ω–∏–∏ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω—ã
                if (matchedPairs === leftItems.length) {
                    // –û—Ç–º–µ—á–∞–µ–º –∏–µ—Ä–æ–≥–ª–∏—Ñ—ã –∫–∞–∫ –ø—Ä–æ–π–¥–µ–Ω–Ω—ã–µ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Ç–∏–ø–∞ –∑–∞–¥–∞–Ω–∏—è
                    leftItems.forEach(item => {
                        charProgress[item.dataset.char][currentTaskType] = true;
                    });
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
                    updateProgress();
                    
                    // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –∑–∞–¥–∞–Ω–∏—è
                    document.getElementById('nextBtn').disabled = false;
                }
            } else {
                showFeedback(false);
                updateUserPoints(-1); // -1 –±–∞–ª–ª –∑–∞ –æ—à–∏–±–∫—É
                
                selectedLeft.classList.remove('selected');
                selectedRight.classList.remove('selected');
            }
            
            selectedLeft = null;
            selectedRight = null;
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏
        function showFeedback(isCorrect) {
            const feedbackElement = isCorrect ? 
                document.getElementById('correctFeedback') : 
                document.getElementById('incorrectFeedback');
            
            feedbackElement.style.opacity = '1';
            
            setTimeout(() => {
                feedbackElement.style.opacity = '0';
            }, 1500);
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –ø–æ –≤—Å–µ–º—É —É—Ä–æ–∫—É
        function updateProgress() {
            // –°—á–∏—Ç–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–π–¥–µ–Ω–Ω—ã—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫ (pinyin + meaning)
            let completedChecks = 0;
            allLessonChars.forEach(char => {
                if (charProgress[char].pinyin) completedChecks++;
                if (charProgress[char].meaning) completedChecks++;
            });
            
            const progress = (completedChecks / totalPairs) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
        function updateStatus() {
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è
            document.getElementById('nextBtn').disabled = true;
        }
    </script>
</body>
</html>